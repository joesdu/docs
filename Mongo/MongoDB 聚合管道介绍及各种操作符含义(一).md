## MongoDB èšåˆç®¡é“åˆæ­¥ä»‹ç»åŠå„ç§æ“ä½œç¬¦å«ä¹‰(ä¸€)

- å“,æœ€è¿‘å¹´æœ«äº†,å„ç§ä¼šè®®,æ€»ç»“å†™çš„æˆ‘å·²ç»æƒ³åäº†,ç°åœ¨æ‰“ç®—æ¥ç»§ç»­å†™ä¹‹å‰ MongoDB çš„ä¸€äº›å°åˆ†äº«.
- ä¹‹å‰ä»‹ç»äº†ç®€å•çš„ CRUD æ“ä½œ,è¿™æ¬¡å°±æ·±å…¥ä¸€äº›,ä»‹ç»ä¸‹ MongoDB çš„èšåˆç®¡é“.
- è¿™éƒ¨åˆ†æˆ‘ä½¿ç”¨çš„ä¸€èˆ¬éƒ½æ˜¯åˆ†ç»„,å¯èƒ½è®²çš„ä¸æ˜¯å¾ˆæ·±å…¥,ä¹Ÿä¸æ˜¯å¾ˆå‡†ç¡®,ä¸è¿‡éƒ½ç®—æ˜¯å­¦ä¹ äº†.
- æ¯”å¦‚ç½‘ä¸Šè¿˜ç»å¸¸åœ¨è¯´ MapReduce å…¶å®åœ¨æ–°ç‰ˆä¸­,MongoDB å·²ç»å¼ƒç”¨äº†è¿™ä¸ªä¸œè¥¿(ä» 5.0 å¼€å§‹).æ‰€ä»¥æœ¬æ–‡å°±ä¸è®²è¿™ä¸ªä¸œè¥¿äº†,æˆ‘å…¶å®ä¹Ÿæ²¡å­¦.ğŸ˜‚
- ç½‘ä¸Šä¹Ÿæœ‰å¾ˆå¤šäººè®²è¿™éƒ¨åˆ†å†…å®¹,ä½†æ˜¯æˆ‘å‘ç°ä»–ä»¬çš„èµ„æ–™å¤§éƒ½åœç•™åœ¨ 2.x æˆ–è€… 3.x çš„ç‰ˆæœ¬,æ„Ÿè§‰å¯èƒ½å’Œç°åœ¨çš„ä¸€äº›è¯´æ³•ä¸å¤ªå‡†ç¡®,æ¯•ç«Ÿç°åœ¨å·²ç» 6.x æ—¶ä»£äº†.
- æœ€å¸¸ç”¨çš„ä¸€äº›èšåˆæ“ä½œå…¶å®å°±æ˜¯åˆ†é¡µ,æ’åº,æ±‚æ–‡æ¡£æ•°é‡ç­‰æ“ä½œ,ä½†æ˜¯è¿™äº›æ“ä½œå…¶å® MongoDB çš„ C# API æˆ–è€…ä½¿ç”¨ JavaScript ä»£ç éƒ½èƒ½ç›´æ¥å†™,ä¸å¤ªè±¡æ˜¯èšåˆç®¡é“çš„æ“ä½œ,ä½†æ˜¯å®é™…ä¸Šä»–ä»¬æ˜¯ä¸€æ ·çš„.
- è¿˜æ˜¯æŒ‰ç…§ä¹‹å‰çš„é£æ ¼,å…ˆä»‹ç»ä¸€ä¸‹å„ç§èšåˆæ“ä½œç¬¦ä»¥åŠèšåˆç®¡é“è¿ç®—ç¬¦çš„è¯¦ç»†å†…å®¹.
- é¦–å…ˆçœ‹çœ‹å®˜ç½‘å¯¹èšåˆç®¡é“çš„å®šä¹‰,ä»¥åŠå®˜ç½‘å¯¹å„ä¸ªæ“ä½œç¬¦çš„è§£é‡Š.
- å‚è€ƒ [å®˜ç½‘](https://www.mongodb.com/docs/manual/reference/operator/aggregation-pipeline/) çš„è¯¦ç»†ä»‹ç»å’ŒåŸæ–‡
- https://www.mongodb.com/docs/manual/reference/operator/aggregation-pipeline/

---

```JavaScript
In the db.collection.aggregate() method and db.aggregate() method, pipeline stages appear in an array. Documents pass through the stages in sequence.
// è¯´ä¸­æ–‡å¤§æ¦‚å°±æ˜¯å¦‚ä¸‹æ„æ€
åœ¨db.collection.aggregation()æ–¹æ³•å’Œdb.aggregation()æ–¹æ³•ä¸­,ç®¡é“é˜¶æ®µå‡ºç°åœ¨ä¸€ä¸ªæ•°ç»„ä¸­.æ–‡æ¡£æŒ‰é¡ºåºé€šè¿‡è¿™äº›é˜¶æ®µ.
```

- é™¤äº† \$outã€\$mergeã€\$geoNear å’Œ \$changeStream é˜¶æ®µå¤–,æ‰€æœ‰é˜¶æ®µéƒ½å¯ä»¥åœ¨ä¸€ä¸ªç®¡é“ä¸­å‡ºç°å¤šæ¬¡.

- æŒ‰ç…§æˆ‘çš„ç†è§£å…¶å®å°±æ˜¯å’Œ.NET ä¸­çš„ä¸­é—´ä»¶å·®ä¸å¤šçš„æ„æ€.ä¸€ä¸ªç®¡é“å¤„ç†å®Œäº¤ç»™ä¸‹ä¸€ä¸ªç®¡é“.æ‰€ä»¥æˆ‘è§‰å¾—è¿™ä¸ªä¸œè¥¿ç»„åˆèµ·æ¥åå°±éå¸¸çš„å¼ºå¤§äº†.

### db.collection.aggregate()é˜¶æ®µ

```JavaScript
// è¯­æ³•
db.collection.aggregate( [ { <stage> }, ... ] );
```

| é˜¶æ®µ             | æè¿°                                                                                                                                                                                                                              | è‹±æ–‡åŸæ–‡                                                                                                                                                                                                                                                                                                                                                                                       |
| ---------------- | --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | ---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| $addFields       | ä¸ºæ–‡æ¡£æ·»åŠ æ–°å­—æ®µ.ä¸ \$project ç±»ä¼¼, \$addFields é‡å¡‘äº†æµä¸­çš„æ¯ä¸€ä¸ªæ–‡æ¡£;å…·ä½“æ¥è¯´,å°±æ˜¯åœ¨è¾“å‡ºæ–‡æ¡£ä¸­æ·»åŠ æ–°çš„å­—æ®µ,å…¶ä¸­åŒ…å«è¾“å…¥æ–‡æ¡£ä¸­çš„ç°æœ‰å­—æ®µå’Œæ–°æ·»åŠ çš„å­—æ®µ. \$set æ˜¯ \$addFields çš„ä¸€ä¸ªåˆ«å.                                         | Adds new fields to documents. Similar to \$project, \$addFields reshapes each document in the stream; specifically, by adding new fields to output documents that contain both the existing fields from the input documents and the newly added fields. $set is an alias for \$addFields.                                                                                                      |
| $bucket          | æ ¹æ®æŒ‡å®šçš„è¡¨è¾¾å¼å’Œæ¡¶çš„è¾¹ç•Œ,å°†ä¼ å…¥çš„æ–‡æ¡£å½’ç±»ä¸ºç»„,ç§°ä¸ºæ¡¶.                                                                                                                                                                           | Categorizes incoming documents into groups, called buckets, based on a specified expression and bucket boundaries.                                                                                                                                                                                                                                                                             |
| $bucketAuto      | æ ¹æ®æŒ‡å®šçš„è¡¨è¾¾å¼,å°†æ”¶åˆ°çš„æ–‡æ¡£åˆ†ç±»åˆ°ç‰¹å®šæ•°é‡çš„ç»„,ç§°ä¸ºæ¡¶.æ¡¶çš„è¾¹ç•Œè¢«è‡ªåŠ¨ç¡®å®š,ä»¥è¯•å›¾å°†æ–‡ä»¶å‡åŒ€åœ°åˆ†é…åˆ°æŒ‡å®šæ•°é‡çš„æ¡¶ä¸­.                                                                                                                 | Categorizes incoming documents into a specific number of groups, called buckets, based on a specified expression. Bucket boundaries are automatically determined in an attempt to evenly distribute the documents into the specified number of buckets.                                                                                                                                        |
| $changeStream    | è¿”å›è¯¥é›†åˆçš„ ChangeStream æ¸¸æ ‡.è¿™ä¸ªé˜¶æ®µåœ¨ä¸€ä¸ªèšåˆç®¡é“ä¸­åªèƒ½å‡ºç°ä¸€æ¬¡,è€Œä¸”å¿…é¡»ä½œä¸ºç¬¬ä¸€ä¸ªé˜¶æ®µå‡ºç°.                                                                                                                                   | Returns a Change Stream cursor for the collection. This stage can only occur once in an aggregation pipeline and it must occur as the first stage.                                                                                                                                                                                                                                             |
| $collStats       | è¿”å›å…³äºä¸€ä¸ªé›†åˆæˆ–è§†å›¾çš„ç»Ÿè®¡æ•°æ®                                                                                                                                                                                                  | Returns statistics regarding a collection or view.                                                                                                                                                                                                                                                                                                                                             |
| $count           | è¿”å›åœ¨èšåˆç®¡é“çš„è¿™ä¸ªé˜¶æ®µçš„æ–‡æ¡£æ•°é‡çš„è®¡æ•°.åŒºåˆ«äº \$count èšåˆç´¯åŠ å™¨.                                                                                                                                                               | Returns a count of the number of documents at this stage of the aggregation pipeline.Distinct from the \$count aggregation accumulator.                                                                                                                                                                                                                                                        |
| $densify         | åœ¨ä¸€ä¸ªæ–‡æ¡£åºåˆ—ä¸­åˆ›å»ºæ–°çš„æ–‡æ¡£,å…¶ä¸­ç¼ºå°‘æŸä¸ªå­—æ®µçš„æŸäº›å€¼.                                                                                                                                                                            | Creates new documents in a sequence of documents where certain values in a field are missing.                                                                                                                                                                                                                                                                                                  |
| $documents       | ä»è¾“å…¥è¡¨è¾¾å¼ä¸­è¿”å›å­—é¢æ–‡æ¡£                                                                                                                                                                                                        | Returns literal documents from input expressions.                                                                                                                                                                                                                                                                                                                                              |
| $facet           | åœ¨åŒä¸€è¾“å…¥æ–‡æ¡£é›†çš„å•ä¸€é˜¶æ®µå†…å¤„ç†å¤šä¸ªèšåˆç®¡é“.èƒ½å¤Ÿåˆ›å»ºå¤šé¢èšåˆ,èƒ½å¤Ÿåœ¨ä¸€ä¸ªé˜¶æ®µå†…è·¨å¤šä¸ªç»´åº¦æˆ–é¢æ¥æè¿°æ•°æ®çš„ç‰¹å¾.                                                                                                                     | Processes multiple aggregation pipelines within a single stage on the same set of input documents. Enables the creation of multi-faceted aggregations capable of characterizing data across multiple dimensions, or facets, in a single stage.                                                                                                                                                 |
| $fill            | åœ¨æ–‡æ¡£ä¸­å¡«å……ç©ºå­—æ®µå’Œç¼ºå¤±å­—æ®µçš„å€¼                                                                                                                                                                                                  | Populates null and missing field values within documents.                                                                                                                                                                                                                                                                                                                                      |
| $geoNear         | æ ¹æ®ä¸åœ°ç†ç©ºé—´ç‚¹çš„æ¥è¿‘ç¨‹åº¦,è¿”å›ä¸€ä¸ªæœ‰åºçš„æ–‡æ¡£æµ.èåˆäº† \$matchã€\$sort å’Œ \$limit çš„åœ°ç†ç©ºé—´æ•°æ®çš„åŠŸèƒ½.è¾“å‡ºçš„æ–‡æ¡£åŒ…æ‹¬ä¸€ä¸ªé¢å¤–çš„è·ç¦»å­—æ®µ,å¯ä»¥åŒ…æ‹¬ä¸€ä¸ªä½ç½®æ ‡è¯†ç¬¦å­—æ®µ.                                                               | Returns an ordered stream of documents based on the proximity to a geospatial point. Incorporates the functionality of \$match, \$sort, and \$limit for geospatial data. The output documents include an additional distance field and can include a location identifier field.                                                                                                                |
| $graphLookup     | åœ¨ä¸€ä¸ªé›†åˆä¸Šæ‰§è¡Œé€’å½’æœç´¢.åœ¨æ¯ä¸ªè¾“å‡ºçš„æ–‡æ¡£ä¸­,æ·»åŠ ä¸€ä¸ªæ–°çš„æ•°ç»„å­—æ®µ,åŒ…å«è¯¥æ–‡æ¡£çš„é€’å½’æœç´¢çš„éå†ç»“æœ.                                                                                                                                  | Performs a recursive search on a collection. To each output document, adds a new array field that contains the traversal results of the recursive search for that document.                                                                                                                                                                                                                    |
| $group           | æŒ‰æŒ‡å®šçš„æ ‡è¯†ç¬¦è¡¨è¾¾å¼å¯¹è¾“å…¥çš„æ–‡æ¡£è¿›è¡Œåˆ†ç»„,å¹¶å°†ç´¯åŠ å™¨è¡¨è¾¾å¼ï¼ˆå¦‚æœæŒ‡å®šçš„è¯ï¼‰åº”ç”¨äºæ¯ä¸ªç»„.æ¶ˆè€—æ‰€æœ‰çš„è¾“å…¥æ–‡æ¡£,æ¯ä¸ªä¸åŒçš„ç»„è¾“å‡ºä¸€ä¸ªæ–‡æ¡£.è¾“å‡ºçš„æ–‡æ¡£åªåŒ…å«æ ‡è¯†ç¬¦å­—æ®µ,å¦‚æœæŒ‡å®šçš„è¯,è¿˜åŒ…å«ç´¯ç§¯å­—æ®µ.                                         | Groups input documents by a specified identifier expression and applies the accumulator expression(s), if specified, to each group. Consumes all input documents and outputs one document per each distinct group. The output documents only contain the identifier field and, if specified, accumulated fields.                                                                               |
| $indexStats      | è¿”å›æœ‰å…³é›†åˆçš„æ¯ä¸ªç´¢å¼•ä½¿ç”¨æƒ…å†µçš„ç»Ÿè®¡æ•°æ®.                                                                                                                                                                                         | Returns statistics regarding the use of each index for the collection.                                                                                                                                                                                                                                                                                                                         |
| $limit           | å°†æœªä¿®æ”¹çš„å‰ n ä¸ªæ–‡æ¡£ä¼ é€’ç»™ç®¡é“,å…¶ä¸­ n æ˜¯æŒ‡å®šçš„é™åˆ¶.å¯¹äºæ¯ä¸ªè¾“å…¥çš„æ–‡ä»¶,è¾“å‡ºä¸€ä¸ªæ–‡ä»¶ï¼ˆå‰ n ä¸ªæ–‡ä»¶ï¼‰æˆ– 0 ä¸ªæ–‡ä»¶ï¼ˆå‰ n ä¸ªæ–‡ä»¶ä¹‹åï¼‰.                                                                                                 | Passes the first n documents unmodified to the pipeline where n is the specified limit. For each input document, outputs either one document (for the first n documents) or zero documents (after the first n documents).                                                                                                                                                                      |
| $listSessions    | åˆ—å‡ºæ‰€æœ‰æ´»åŠ¨æ—¶é—´é•¿åˆ°è¶³ä»¥ä¼ æ’­åˆ° system.session é›†åˆçš„ä¼šè¯.                                                                                                                                                                         | Lists all sessions that have been active long enough to propagate to the system.sessions collection.                                                                                                                                                                                                                                                                                           |
| $lookup          | å¯¹åŒä¸€æ•°æ®åº“ä¸­çš„å¦ä¸€ä¸ªé›†åˆè¿›è¡Œå·¦å¤–è”æ¥,ä» "è”æ¥" çš„é›†åˆä¸­è¿‡æ»¤æ–‡æ¡£è¿›è¡Œå¤„ç†.                                                                                                                                                        | Performs a left outer join to another collection in the same database to filter in documents from the "joined" collection for processing.                                                                                                                                                                                                                                                      |
| $match           | è¿‡æ»¤æ–‡æ¡£æµ,åªå…è®¸åŒ¹é…çš„æ–‡æ¡£æœªç»ä¿®æ”¹åœ°è¿›å…¥ä¸‹ä¸€ä¸ªæµæ°´çº¿é˜¶æ®µ. \$match ä½¿ç”¨æ ‡å‡†çš„ MongoDB æŸ¥è¯¢.å¯¹äºæ¯ä¸ªè¾“å…¥æ–‡æ¡£,è¾“å‡ºä¸€ä¸ªæ–‡æ¡£ï¼ˆåŒ¹é…ï¼‰æˆ–é›¶æ–‡æ¡£ï¼ˆä¸åŒ¹é…ï¼‰.                                                                               | Filters the document stream to allow only matching documents to pass unmodified into the next pipeline stage. \$match uses standard MongoDB queries. For each input document, outputs either one document (a match) or zero documents (no match).                                                                                                                                              |
| $merge           | å°†èšåˆç®¡é“çš„ç»“æœæ–‡æ¡£å†™å…¥ä¸€ä¸ªé›†åˆ.è¯¥é˜¶æ®µå¯ä»¥å°†ï¼ˆæ’å…¥æ–°çš„æ–‡æ¡£ã€åˆå¹¶æ–‡æ¡£ã€æ›¿æ¢æ–‡æ¡£ã€ä¿ç•™ç°æœ‰çš„æ–‡æ¡£ã€æ“ä½œå¤±è´¥ã€ç”¨è‡ªå®šä¹‰çš„æ›´æ–°ç®¡é“å¤„ç†æ–‡æ¡£ï¼‰ç»“æœçº³å…¥ä¸€ä¸ªè¾“å‡ºé›†åˆ.è¦ä½¿ç”¨\$merge é˜¶æ®µ,å®ƒå¿…é¡»æ˜¯æµæ°´çº¿ä¸­çš„æœ€åä¸€ä¸ªé˜¶æ®µ.4.2 ç‰ˆæœ¬ä¸­çš„æ–°åŠŸèƒ½. | Writes the resulting documents of the aggregation pipeline to a collection. The stage can incorporate (insert new documents, merge documents, replace documents, keep existing documents, fail the operation, process documents with a custom update pipeline) the results into an output collection. To use the \$merge stage, it must be the last stage in the pipeline. New in version 4.2. |
| $out             | å°†èšåˆç®¡é“çš„ç»“æœæ–‡æ¡£å†™å…¥ä¸€ä¸ªé›†åˆ.è¦ä½¿ç”¨ \$out é˜¶æ®µ,å®ƒå¿…é¡»æ˜¯æµæ°´çº¿çš„æœ€åä¸€ä¸ªé˜¶æ®µ.                                                                                                                                                  | Writes the resulting documents of the aggregation pipeline to a collection. To use the \$out stage, it must be the last stage in the pipeline.                                                                                                                                                                                                                                                 |
| $planCacheStats  | è¿”å›ä¸€ä¸ªé›†åˆçš„è®¡åˆ’ç¼“å­˜ä¿¡æ¯                                                                                                                                                                                                        | Returns plan cache information for a collection.                                                                                                                                                                                                                                                                                                                                               |
| $project         | é‡å¡‘æ•°æ®æµä¸­çš„æ¯ä¸ªæ–‡æ¡£,ä¾‹å¦‚å¢åŠ æ–°çš„å­—æ®µæˆ–åˆ é™¤ç°æœ‰çš„å­—æ®µ.å¯¹äºæ¯ä¸ªè¾“å…¥çš„æ–‡æ¡£,è¾“å‡ºä¸€ä¸ªæ–‡æ¡£.å¦è§ \$unset ç”¨äºç§»é™¤ç°æœ‰å­—æ®µ.                                                                                                            | Reshapes each document in the stream, such as by adding new fields or removing existing fields. For each input document, outputs one document.See also \$unset for removing existing fields.                                                                                                                                                                                                   |
| $redact          | æ ¹æ®å­˜å‚¨åœ¨æ–‡æ¡£ä¸­çš„ä¿¡æ¯,é€šè¿‡é™åˆ¶æ¯ä¸ªæ–‡æ¡£çš„å†…å®¹æ¥é‡å¡‘æµä¸­çš„æ¯ä¸ªæ–‡æ¡£.ç»“åˆäº† \$project å’Œ \$match çš„åŠŸèƒ½.å¯ä»¥ç”¨æ¥å®ç°å­—æ®µçº§çš„ç¼–è¾‘.å¯¹äºæ¯ä¸ªè¾“å…¥çš„æ–‡æ¡£,è¾“å‡ºä¸€ä¸ªæˆ–é›¶ä¸ªæ–‡æ¡£.                                                              | Reshapes each document in the stream by restricting the content for each document based on information stored in the documents themselves. Incorporates the functionality of \$project and \$match. Can be used to implement field level redaction. For each input document, outputs either one or zero documents.                                                                             |
| $replaceRoot     | ç”¨æŒ‡å®šçš„åµŒå…¥å¼æ–‡æ¡£æ›¿æ¢ä¸€ä¸ªæ–‡æ¡£.è¯¥æ“ä½œæ›¿æ¢äº†è¾“å…¥æ–‡æ¡£ä¸­çš„æ‰€æœ‰ç°æœ‰å­—æ®µ,åŒ…æ‹¬ \_id å­—æ®µ.æŒ‡å®šä¸€ä¸ªåµŒå…¥åœ¨è¾“å…¥æ–‡æ¡£ä¸­çš„æ–‡æ¡£,å°†åµŒå…¥çš„æ–‡æ¡£æå‡åˆ°æœ€é«˜çº§åˆ«. \$replaceWith æ˜¯\$replaceRoot é˜¶æ®µçš„ä¸€ä¸ªåˆ«å.                                       | Replaces a document with the specified embedded document. The operation replaces all existing fields in the input document, including the \_id field. Specify a document embedded in the input document to promote the embedded document to the top level. \$replaceWith is an alias for \$replaceRoot stage.                                                                                  |
| $replaceWith     | ç”¨æŒ‡å®šçš„åµŒå…¥å¼æ–‡æ¡£æ›¿æ¢ä¸€ä¸ªæ–‡æ¡£.è¯¥æ“ä½œæ›¿æ¢äº†è¾“å…¥æ–‡æ¡£ä¸­çš„æ‰€æœ‰ç°æœ‰å­—æ®µ,åŒ…æ‹¬ \_id å­—æ®µ.æŒ‡å®šä¸€ä¸ªåµŒå…¥åœ¨è¾“å…¥æ–‡æ¡£ä¸­çš„æ–‡æ¡£,å°†åµŒå…¥çš„æ–‡æ¡£æå‡åˆ°æœ€é«˜çº§åˆ«. \$replaceWith æ˜¯\$replaceRoot é˜¶æ®µçš„ä¸€ä¸ªåˆ«å.                                       | Replaces a document with the specified embedded document. The operation replaces all existing fields in the input document, including the \_id field. Specify a document embedded in the input document to promote the embedded document to the top level. \$replaceWith is an alias for \$replaceRoot stage.                                                                                  |
| $sample          | ä»å…¶è¾“å…¥ä¸­éšæœºé€‰æ‹©æŒ‡å®šæ•°é‡çš„æ–‡ä»¶.                                                                                                                                                                                                 | Randomly selects the specified number of documents from its input.                                                                                                                                                                                                                                                                                                                             |
| $set             | ä¸ºæ–‡æ¡£æ·»åŠ æ–°å­—æ®µ.ä¸ \$project ç±»ä¼¼, \$set é‡å¡‘äº†æµä¸­çš„æ¯ä¸€ä¸ªæ–‡æ¡£ï¼›å…·ä½“æ¥è¯´,å°±æ˜¯åœ¨è¾“å‡ºæ–‡æ¡£ä¸­æ·»åŠ æ–°çš„å­—æ®µ,å…¶ä¸­åŒ…å«è¾“å…¥æ–‡æ¡£ä¸­çš„ç°æœ‰å­—æ®µå’Œæ–°æ·»åŠ çš„å­—æ®µ. \$set æ˜¯\$addFields é˜¶æ®µçš„ä¸€ä¸ªåˆ«å.                                           | Adds new fields to documents. Similar to \$project, \$set reshapes each document in the stream; specifically, by adding new fields to output documents that contain both the existing fields from the input documents and the newly added fields. \$set is an alias for \$addFields stage.                                                                                                     |
| $setWindowFields | å°†æ–‡æ¡£åˆ†ç»„åˆ°çª—å£,å¹¶å¯¹æ¯ä¸ªçª—å£ä¸­çš„æ–‡æ¡£åº”ç”¨ä¸€ä¸ªæˆ–å¤šä¸ªè¿ç®—ç¬¦.5.0 ç‰ˆçš„æ–°åŠŸèƒ½.                                                                                                                                                         | Groups documents into windows and applies one or more operators to the documents in each window. New in version 5.0.                                                                                                                                                                                                                                                                           |
| $skip            | è·³è¿‡å‰ n ä¸ªæ–‡æ¡£,å…¶ä¸­ n æ˜¯æŒ‡å®šçš„è·³è¿‡æ¬¡æ•°,å¹¶å°†å‰©ä½™çš„æ–‡æ¡£ä¸åŠ ä¿®æ”¹åœ°ä¼ é€’ç»™ç®¡é“.å¯¹äºæ¯ä¸ªè¾“å…¥æ–‡ä»¶,è¾“å‡ºé›¶ä¸ªæ–‡ä»¶ï¼ˆå¯¹äºå‰ n ä¸ªæ–‡ä»¶ï¼‰æˆ–ä¸€ä¸ªæ–‡ä»¶ï¼ˆå¦‚æœåœ¨å‰ n ä¸ªæ–‡ä»¶ä¹‹åï¼‰.                                                                   | Skips the first n documents where n is the specified skip number and passes the remaining documents unmodified to the pipeline. For each input document, outputs either zero documents (for the first n documents) or one document (if after the first n documents).                                                                                                                           |
| $sort            | æŒ‰æŒ‡å®šçš„æ’åºé”®é‡æ–°æ’åˆ—æ–‡æ¡£æµ.ä»…ä»…æ˜¯é¡ºåºçš„æ”¹å˜,æ–‡æ¡£ä¿æŒä¸å˜.å¯¹äºæ¯ä¸€ä¸ªè¾“å…¥æ–‡æ¡£,è¾“å‡ºä¸€ä¸ªæ–‡æ¡£.                                                                                                                                       | Reorders the document stream by a specified sort key. Only the order changes; the documents remain unmodified. For each input document, outputs one document.                                                                                                                                                                                                                                  |
| $sortByCount     | æ ¹æ®æŒ‡å®šçš„è¡¨è¾¾å¼çš„å€¼å¯¹è¿›å…¥çš„æ–‡æ¡£è¿›è¡Œåˆ†ç»„,ç„¶åè®¡ç®—æ¯ä¸ªä¸åŒç»„ä¸­çš„æ–‡æ¡£æ•°.                                                                                                                                                            | Groups incoming documents based on the value of a specified expression, then computes the count of documents in each distinct group.                                                                                                                                                                                                                                                           |
| $unionWith       | æ‰§è¡Œä¸¤ä¸ªé›†åˆçš„è”åˆï¼›å³æŠŠä¸¤ä¸ªé›†åˆçš„ç®¡é“ç»“æœåˆå¹¶ä¸ºä¸€ä¸ªç»“æœé›†.4.4 ç‰ˆæœ¬ä¸­çš„æ–°åŠŸèƒ½.                                                                                                                                                    | Performs a union of two collections; i.e. combines pipeline results from two collections into a single result set. New in version 4.4.                                                                                                                                                                                                                                                         |
| $unset           | ä»æ–‡æ¡£ä¸­åˆ é™¤/æ’é™¤å­—æ®µ. \$unset æ˜¯ \$project é˜¶æ®µçš„ä¸€ä¸ªåˆ«å,ç”¨äºåˆ é™¤å­—æ®µ.                                                                                                                                                          | Removes/excludes fields from documents. \$unset is an alias for \$project stage that removes fields.                                                                                                                                                                                                                                                                                           |
| $unwind          | ä»è¾“å…¥æ–‡æ¡£ä¸­è§£æ„ä¸€ä¸ªæ•°ç»„å­—æ®µ,ä¸ºæ¯ä¸ªå…ƒç´ è¾“å‡ºä¸€ä¸ªæ–‡æ¡£.æ¯ä¸ªè¾“å‡ºçš„æ–‡æ¡£ç”¨ä¸€ä¸ªå…ƒç´ å€¼æ›¿æ¢æ•°ç»„.å¯¹äºæ¯ä¸ªè¾“å…¥æ–‡æ¡£,è¾“å‡º n ä¸ªæ–‡æ¡£,å…¶ä¸­ n æ˜¯æ•°ç»„å…ƒç´ çš„æ•°é‡,å¯¹äºç©ºæ•°ç»„å¯ä»¥æ˜¯é›¶.                                                                 | Deconstructs an array field from the input documents to output a document for each element. Each output document replaces the array with an element value. For each input document, outputs n documents where n is the number of array elements and can be zero for an empty array.                                                                                                            |

- ä»¥ä¸Šå°±æ˜¯ db.collection.aggregate()é˜¶æ®µçš„èšåˆç®¡é“å…¶ä¸­è¿˜æœ‰ä¸¤ä¸ªæ“ä½œç¬¦ä»…æ”¯æŒ MongoDB Atlas clusters,æ‰€ä»¥ä¸€èˆ¬äººç”¨ä¸åˆ°,é™¤éä½ ä¹°ä»–ä»¬çš„äº‘æœåŠ¡ç‰ˆ MongoDB.
- å¹¶ä¸” \$searchMeta éœ€è¦ MongoDB ç‰ˆæœ¬å¤§äº 4.4.9

| é˜¶æ®µ        | æè¿°                                                      | è‹±æ–‡åŸæ–‡                                                                                                     |
| ----------- | --------------------------------------------------------- | ------------------------------------------------------------------------------------------------------------ |
| $search     | å¯¹ä¸€ä¸ªæˆ–å¤šä¸ªå­—æ®µè¿›è¡Œå…¨æ–‡æœç´¢                              | Performs a full-text search of the field or fields in an Atlas collection.                                   |
| $searchMeta | å¯¹ä¸€ä¸ªæˆ–å¤šä¸ªå­—æ®µè¿›è¡Œå…¨æ–‡æœç´¢,è¿”å›ä¸åŒç±»å‹çš„å…ƒæ•°æ®ç»“æœæ–‡æ¡£ | Returns different types of metadata result documents for the Atlas Search query against an Atlas collection. |

---

### db.aggregate()é˜¶æ®µ

```JavaScript
// è¯­æ³•
db.aggregate( [ { <stage> }, ... ] )
```

- ä»¥ä¸‹é˜¶æ®µä½¿ç”¨ db.aggregate()æ–¹æ³•è€Œä¸æ˜¯ db.collection.aggregate()æ–¹æ³•.

| é˜¶æ®µ               | æè¿°                                                                                                         | è‹±æ–‡åŸæ–‡                                                                                                                                                                      |
| ------------------ | ------------------------------------------------------------------------------------------------------------ | ----------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| $changeStream      | è¿”å›è¯¥é›†åˆçš„ ChangeStream æ¸¸æ ‡.è¿™ä¸ªé˜¶æ®µåœ¨ä¸€ä¸ªèšåˆç®¡é“ä¸­åªèƒ½å‡ºç°ä¸€æ¬¡,è€Œä¸”å¿…é¡»ä½œä¸ºç¬¬ä¸€ä¸ªé˜¶æ®µå‡ºç°.              | Returns a Change Stream cursor for the collection. This stage can only occur once in an aggregation pipeline and it must occur as the first stage.                            |
| $currentOp         | è¿”å›å…³äº MongoDB éƒ¨ç½²çš„æ´»åŠ¨å’Œ/æˆ–ä¼‘çœ æ“ä½œçš„ä¿¡æ¯.                                                              | Returns information on active and/or dormant operations for the MongoDB deployment.                                                                                           |
| $listLocalSessions | åˆ—å‡ºæ‰€æœ‰æœ€è¿‘åœ¨å½“å‰è¿æ¥çš„ mongos æˆ– mongod å®ä¾‹ä¸Šä½¿ç”¨çš„æ´»åŠ¨ä¼šè¯.è¿™äº›ä¼šè¯å¯èƒ½è¿˜æ²¡æœ‰ä¼ æ’­åˆ° system.session é›†åˆ. | Lists all active sessions recently in use on the currently connected mongos or mongod instance. These sessions may have not yet propagated to the system.sessions collection. |
| $documents         | ä»è¾“å…¥å€¼è¿”å›å­—é¢æ–‡æ¡£                                                                                         | Returns literal documents from input values.                                                                                                                                  |

- å¯ç”¨äºæ›´æ–°çš„é˜¶æ®µ
- ä» MongoDB 4.2 å¼€å§‹,æ‚¨å¯ä»¥ä½¿ç”¨èšåˆç®¡é“ æ›´æ–°åœ¨:

| å‘½ä»¤          | mongosh æ–¹æ³•                                                                                                                                   |
| ------------- | ---------------------------------------------------------------------------------------------------------------------------------------------- |
| findAndModify | db.collection.findOneAndUpdateï¼ˆï¼‰<br/> db.collection.findAndModifyï¼ˆï¼‰                                                                        |
| update        | db.collection.updateOneï¼ˆï¼‰<br/> db.collection.updateManyï¼ˆï¼‰<br/> Bulk.find.updateï¼ˆï¼‰<br/> Bulk.find.updateOneï¼ˆï¼‰<br/> Bulk.find.upsertï¼ˆï¼‰ |

å¯¹äºæ›´æ–°,ç®¡é“å¯ä»¥åŒ…å«ä»¥ä¸‹é˜¶æ®µ:

- \$addFields åŠå…¶åˆ«å \$set
- \$project åŠå…¶åˆ«å \$unset
- \$replaceRoot åŠå…¶åˆ«å \$replaceWith.

---

- ä¸Šè¾¹çš„å†…å®¹åŸºæœ¬ä¸Šæ˜¯æŒ‰ç…§å®˜ç½‘çš„å†…å®¹æ¬è¿è¿‡æ¥,å°†å…¶ä¸­çš„æ“ä½œç¬¦æè¿°ç¿»è¯‘æˆäº†ä¸­æ–‡,ä¾¿äºç†è§£ä¸€äº›.
- ä»Šå¤©æš‚æ—¶å…ˆå†™åˆ°è¿™é‡Œ.æ˜å¤©åº”è¯¥ä¼šå…ˆç»§ç»­ä»‹ç»ä¸€ä¸‹ç®¡é“ä¸­çš„èšåˆå‡½æ•°(Aggregation Pipeline Operators)
- è€Œä¸”èšåˆå‡½æ•°çš„å†…å®¹ç›¸å½“å¤š,ç²—ç•¥çœ‹äº†ä¸‹å¤§æ¦‚æœ‰ä¸ä¸‹ 100 ä¸ª,ä¼°è®¡æ˜å¤©æˆ‘ä¹Ÿä¸ä¼šæŠŠæ‰€æœ‰çš„éƒ½å†™å‡ºæ¥,è€Œæ˜¯æŒ‘å‡ ä¸ªå¸¸ç”¨çš„ç®€å•ä»‹ç»ä¸€ä¸‹,å¹¶ç»“åˆä»£ç æ¥å±•ç¤º.
- ç”±äºè¿™äº›ä»‹ç»å®Œå,æ‰èƒ½é€šè¿‡ C# ä»£ç æ¥ä½“ç°å…¶ä¸­çš„æ•ˆæœ.ä¸ç„¶å‡ºç°æ²¡æœ‰ä»‹ç»çš„æ“ä½œç¬¦å®¹æ˜“äº§ç”Ÿç–‘æƒ‘.æ‰€ä»¥ä»£ç ä»Šå¤©æš‚æ—¶å°±ä¸å†™äº†.å·²ç»æ™šä¸Š **23 ç‚¹+** äº†.
