### MongoDB æ‰¹é‡æ“ä½œæ•°æ®,æ›´æ–°åˆ é™¤ç­‰

> åœ¨æ•°æ®åº“æ•°æ®æ‰¹é‡æ“ä½œä¸­,æˆ‘ä»¬å¸¸å¸¸ä¼šé‡åˆ°ä¸€ç§æƒ…æ™¯.æ¯”å¦‚æœ‰ä¸€å †æ•°æ®,æˆ‘ä»¬å¸Œæœ›æ ¹æ®æŸäº›æ¡ä»¶æ¥å®ç°æ‰¹é‡æ›´æ–°,æ¯”å¦‚æˆ‘ä»¬ç¬¬ä¸€æ¡æ•°æ®,æˆ‘ä»¬å¸Œæœ›å°† 1 å­—æ®µæ›´æ–°ä¸ºæ–°å€¼,ç¬¬äºŒä¸ªæ•°æ®çš„ 2 å­—æ®µæ›´æ–°ä¸ºæ–°å€¼.åœ¨ MySQL å’Œ MSSQL è¿™ç§å…³ç³»å‹æ•°æ®åº“ä¸­å¥½åƒæ— æ³•å®ç°,æˆ‘è‡ªå·±æ²¡æœ‰å°è¯•è¿‡ ğŸ˜….

- é‚£ä¹ˆé—®é¢˜æå‡ºæ¥äº†,éœ€è¦å¦‚ä½•è§£å†³å‘¢.
- åœ¨ MongoDB ä¸­æœ‰ä¸€ä¸ªäº›æ¥å£æ¥å®ç°è¿™ç§åŠŸèƒ½.ä½¿ç”¨ BulkWriteAsync å’Œ BulkWrite è¿™ä¸¤ä¸ªæ¥å£å°±å¯ä»¥å®ç°.
- åœ¨ VS ä¸­,æˆ‘ä»¬å¯ä»¥æŸ¥çœ‹è¿™ä¸ªæ¥å£çš„å‚æ•°,å¯ä»¥å‘ç°,ç¬¬ä¸€ä¸ªå‚æ•°æ¥å— DeleteOneModel, InsertOneModel, UpdateOneModel, ReplaceOneModel,UpdateManyModel,DeleteManyModel ç­‰ç±»å‹,ç¬¬äºŒä¸ªå‚æ•°æ˜¯ BulkWriteOptions å¯ä»¥ç”¨æ¥æŒ‡å®šä¸€äº›æ“ä½œä¸­çš„é€‰é¡¹,å¦‚æ˜¯å¦æœ‰åº.
- æœ‰åº Bulk æ“ä½œ,æ˜¯æŒ‡ä»¥æœ‰åºçš„æ–¹å¼æ‰§è¡Œæ‰€æœ‰çš„æ“ä½œ,å¹¶ä¸”åœ¨é¦–æ¬¡é‡åˆ°å¼‚å¸¸æ—¶æŠ›å‡ºå¼‚å¸¸.
- æ— åº Bulk æ“ä½œ,æ˜¯æŒ‡æ‰§è¡Œæ‰€æœ‰çš„æ“ä½œ,å¹¶è®°å½•æ“ä½œè¿‡ç¨‹ä¸­çš„å…¨éƒ¨å¼‚å¸¸.æ— åºçš„æ‰¹é‡æ“ä½œä¸èƒ½ä¿è¯æ‰§è¡Œçš„é¡ºåº.
- ç”±äºè¿™äº›ç”¨æ³•éƒ½å¾ˆç±»ä¼¼,æ‰€ä»¥è¿™é‡Œä»…ä»¥ UpdateOneModel æ¥åšä¸€ä¸ªä¾‹å­.
- å‡è®¾æˆ‘ä»¬æœ‰ä¸€ä¸ªå¦‚ä¸‹ç»“æ„çš„æ•°æ®é›†åˆ.

```json
{
    "_id": ObjectId("63f34e187e6e5256b8aca3a6"),
    "addTime": ISODate("2023-02-20T10:39:42.068Z"),
    "modifyTime": ISODate("2023-02-20T10:39:42.068Z"),
    "isDelete": false,
    "name": "æå£¹å…ƒ",
    "age": NumberInt("1")
},
{
    "_id": ObjectId("63f34e187e6e5256b8aca3a7"),
    "addTime": ISODate("2023-02-20T10:39:42.068Z"),
    "modifyTime": ISODate("2023-02-20T10:39:42.068Z"),
    "isDelete": false,
    "name": "æè´°å…ƒ",
    "age": NumberInt("2")
},
{
    "_id": ObjectId("63f34e187e6e5256b8aca3a8"),
    "addTime": ISODate("2023-02-20T10:39:42.068Z"),
    "modifyTime": ISODate("2023-02-20T10:39:42.068Z"),
    "isDelete": false,
    "name": "æåå…ƒ",
    "age": NumberInt("3")
},
{
    "_id": ObjectId("63f34e187e6e5256b8aca3a9"),
    "addTime": ISODate("2023-02-20T10:39:42.068Z"),
    "modifyTime": ISODate("2023-02-20T10:39:42.068Z"),
    "isDelete": false,
    "name": "æè‚†å…ƒ",
    "age": NumberInt("4")
},
{
    "_id": ObjectId("63f34e187e6e5256b8aca3aa"),
    "addTime": ISODate("2023-02-20T10:39:42.068Z"),
    "modifyTime": ISODate("2023-02-20T10:39:42.068Z"),
    "isDelete": false,
    "name": "æä¼å…ƒ",
    "age": NumberInt("5")
},
{
    "_id": ObjectId("63f34e187e6e5256b8aca3ab"),
    "addTime": ISODate("2023-02-20T10:39:42.068Z"),
    "modifyTime": ISODate("2023-02-20T10:39:42.068Z"),
    "isDelete": false,
    "name": "æé™†å…ƒ",
    "age": NumberInt("6")
},
{
    "_id": ObjectId("63f34e187e6e5256b8aca3ac"),
    "addTime": ISODate("2023-02-20T10:39:42.068Z"),
    "modifyTime": ISODate("2023-02-20T10:39:42.068Z"),
    "isDelete": false,
    "name": "ææŸ’å…ƒ",
    "age": NumberInt("7")
},
{
    "_id": ObjectId("63f34e187e6e5256b8aca3ad"),
    "addTime": ISODate("2023-02-20T10:39:42.068Z"),
    "modifyTime": ISODate("2023-02-20T10:39:42.068Z"),
    "isDelete": false,
    "name": "ææŒå…ƒ",
    "age": NumberInt("8")
},
{
    "_id": ObjectId("63f34e187e6e5256b8aca3ae"),
    "addTime": ISODate("2023-02-20T10:39:42.068Z"),
    "modifyTime": ISODate("2023-02-20T10:39:42.068Z"),
    "isDelete": false,
    "name": "æç–å…ƒ",
    "age": NumberInt("9")
},
{
    "_id": ObjectId("63f34e187e6e5256b8aca3af"),
    "addTime": ISODate("2023-02-20T10:39:42.068Z"),
    "modifyTime": ISODate("2023-02-20T10:39:42.068Z"),
    "isDelete": false,
    "name": "æå£¹æ‹¾å…ƒ",
    "age": NumberInt("10")
}
```

- æˆ‘ä»¬åœ¨.NET ä¸­çš„æ•°æ®ç»“æ„å¦‚ä¸‹

```csharp
public class Info
{
    public string Id{get;set;}
    public DateTime AddTime{get;set;}
    public DateTime ModifyTime{get;set;}
    public bool IsDelete{get;set;}
    public string Name{get;set;}
    public int Age{get;set;}
}
```

- è¿™ä¸ªæ—¶å€™æˆ‘ä»¬å¸Œæœ›ä¸€æ¬¡æ€§å°† Age å°äºç­‰äº 5 çš„æ•°æ®æ›´åä¸ºç‹ä¸€,ç‹äºŒ,ç‹ä¸‰...ä»¥æ­¤ç±»æ¨,å°†å¤§äº 5 çš„æ•°æ®æ›´åä¸ºèµµå…­,èµµä¸ƒ...
- æ¥ä¸‹æ¥å°±æ˜¯å†™ä»£ç çš„æ—¶å€™äº†.

```csharp
// é¦–å…ˆæˆ‘ä»¬å…ˆå°†æ‰€æœ‰æ•°æ®æŸ¥è¯¢å‡ºæ¥.
var list = await db.Info.Find(bf.Empty).ToListAsync();
// æ¥ç€ç”Ÿæˆæˆ‘ä»¬æ‰€éœ€çš„UpdateOneModelé›†åˆ.
var bf = Builders<Info>.Filter;
var bu = Builders<Info>.Update;
var bulk1 = list.Select(c => new UpdateOneModel<Info>(bf.Lte(c => c.Age, 5), bu.Set(c => c.Name, $"ç‹{c.Age}")));
var bulk2 = list.Select(c => new UpdateOneModel<Info>(bf.Gt(c => c.Age, 5), bu.Set(c => c.Name, $"èµµ{c.Age}")));
// å°†æ•°æ®æ„é€ å¥½å,æˆ‘ä»¬åˆå¹¶ä¸¤ä¸ªé›†åˆ.
bulk1.AddRagne(bulk2);
// æœ€åå³å¯æ‰§è¡Œæ‰¹é‡æ“ä½œäº†.
await db.Info.BulkWriteAsync(bulk1, new() { IsOrdered = false });
```

- ä»¥ä¸Šå³æ˜¯æ‰¹é‡æ›´æ–°çš„æ“ä½œäº†.å½“ç„¶è¿˜æœ‰å…¶ä»–çš„æ“ä½œ Model,ä½¿ç”¨æ–¹æ³•éƒ½æ˜¯å¤§åŒå°å¼‚.å¯ä»¥æ ¹æ®è‡ªå·±çš„å®é™…æƒ…å†µé€‰ç”¨.
- è¿™é‡Œä»…ä»…æ˜¯ç®€å•çš„ä»‹ç»äº†ä¸‹å¦‚ä½•ä½¿ç”¨æ‰¹é‡æ“ä½œæ¥æ›´æ–°æˆ–è€…åˆ é™¤ä»¥åŠæ›¿æ¢æˆ‘ä»¬çš„æ–‡æ¡£.æƒ³è¯¦ç»†äº†è§£çš„å¯ä»¥[é€šè¿‡å®˜ç½‘æŸ¥çœ‹ç»†èŠ‚](https://www.mongodb.com/docs/manual/core/bulk-write-operations)
- çœ‹åˆ°èµ„æ–™æœ‰æç¤ºè¯´åœ¨ 2.6 ç‰ˆæœ¬ä¹‹å‰ä¸æ¨èä½¿ç”¨æ‰¹é‡æ“ä½œ,è¯´æ˜¯æ€§èƒ½å­˜åœ¨ä¸€äº›é—®é¢˜.ä¸è¿‡ç°åœ¨éƒ½ 2.19.x äº† ğŸ˜‚
