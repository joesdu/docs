> MongoDB çš„åˆ†ç‰‡é›†ç¾¤å¯ä»¥å®žçŽ°æ°´å¹³æ¨ªå‘æ‰©å±•,è‡ªå·±ç®€å•æµ‹è¯•äº†ä¸‹.æ€§èƒ½ç®€ç›´æ˜¯ç‚¸è£‚.

- é¦–å…ˆå‡†å¤‡ä¸€æ‰¹æœåŠ¡å™¨.(ç†è®ºä¸Šæ¥è®² mongos éœ€è¦å¤šèŠ‚ç‚¹é«˜å¯ç”¨,ä½†æ˜¯å®¶å¢ƒè´«å¯’,å…ˆå¼„ä¸€ä¸ªèŠ‚ç‚¹)

| åç§°           | vCPU | RAM | ROM | æ•°æ®ç£ç›˜ | IP           | ç”¨é€”                 |
| -------------- | ---- | --- | --- | -------- | ------------ | -------------------- |
| mongos-01      | 16   | 32  | 50  | 0        | 192.168.2.60 | å¯¹å¤–æä¾› mongos æœåŠ¡ |
| mongocs-01     | 2    | 4   | 50  | 0        | 192.168.2.61 | mongoconfig æœåŠ¡ 1   |
| mongocs-02     | 2    | 4   | 50  | 0        | 192.168.2.62 | mongoconfig æœåŠ¡ 2   |
| mongocs-03     | 1    | 2   | 50  | 0        | 192.168.2.63 | mongoconfig æœåŠ¡ 3   |
| mongosh-g0-01  | 4    | 8   | 40  | 200      | 192.168.2.64 | åˆ†ç‰‡ 1 ä¸»èŠ‚ç‚¹        |
| mongosh-g0-02  | 4    | 8   | 40  | 200      | 192.168.2.65 | åˆ†ç‰‡ 1 ä»ŽèŠ‚ç‚¹        |
| mongosh-g0-arb | 1    | 1   | 40  | 0        | 192.168.2.66 | åˆ†ç‰‡ 1 ä»²è£èŠ‚ç‚¹      |
| mongosh-g1-01  | 4    | 8   | 40  | 200      | 192.168.2.67 | åˆ†ç‰‡ 2 ä¸»èŠ‚ç‚¹        |
| mongosh-g1-02  | 4    | 8   | 40  | 200      | 192.168.2.68 | åˆ†ç‰‡ 2 ä»ŽèŠ‚ç‚¹        |
| mongosh-g1-arb | 1    | 1   | 40  | 0        | 192.168.2.69 | åˆ†ç‰‡ 2 ä»²è£èŠ‚ç‚¹      |

- ä»¥ä¸Šå°±æ˜¯æœåŠ¡å™¨çš„è§„åˆ’.ä¸å¤šä¸å°‘æ­£å¥½ 10 å°.(åšé›†ç¾¤çœŸçš„æ˜¯æœ‰ç‚¹è´¹ ðŸ¤£)
- ç»™ 10 å°æœåŠ¡å™¨å‡è£…å¥½æ“ä½œç³»ç»Ÿ Ubuntu20.04LTS(ç›®å‰ MongoDB 6.x æ”¯æŒçš„æœ€æ–°ç‰ˆæœ¬,21.10 ä¹Ÿå¯ä»¥)
- æŽ¥ä¸‹æ¥å…ˆèµ°ä¸€æ³¢å¸¸è§„çš„ MongoDB å®‰è£…æ­¥éª¤,ä¹Ÿå¯ä»¥å‚è€ƒå‰¯æœ¬é›†é›†ç¾¤ä¸­çš„å®‰è£…æ­¥éª¤.
- é¦–å…ˆå¸¸è§„æ“ä½œ,å®‰è£…å¿…é¡»çš„ä¾èµ–åŒ….

```bash
sudo apt install gnupg
```

- å¯¼å…¥ GPG å…¬é’¥

```bash
wget -qO - https://www.mongodb.org/static/pgp/server-6.0.asc | sudo apt-key add -
```

- åˆ›å»º MongoDB çš„åŒ…æºæ–‡ä»¶

```bash
echo "deb [ arch=amd64,arm64 ] https://repo.mongodb.org/apt/ubuntu focal/mongodb-org/6.0 multiverse" | sudo tee /etc/apt/sources.list.d/mongodb-org-6.0.list
```

- æ‰§è¡ŒåŒ…æºæ›´æ–°å’Œå®‰è£… mongodb ç¤¾åŒºç‰ˆ

```bash
sudo apt update && sudo apt install mongodb-org -y
```

- åˆ°æ­¤ MongoDB çš„åŒ…å°±è£…å¥½äº†.æŽ¥ä¸‹æ¥å°±æ˜¯è°ƒæ•´é…ç½®æ–‡ä»¶çš„éƒ¨åˆ†äº†.
- é¦–å…ˆå…ˆåšä¸¤ä¸ª shard èŠ‚ç‚¹çš„é…ç½®.
- æˆ‘ä»¬å¯ä»¥å…ˆç”Ÿæˆä¸€ä¸ª keyFile ç”¨æ¥èŠ‚ç‚¹é—´æ ¡éªŒé€šä¿¡,å¹¶åŒæ­¥åˆ°æ‰€æœ‰èŠ‚ç‚¹çš„ç”¨æˆ·ç›®å½•ä¸‹.

```bash
openssl rand -base64 745 > /home/joe/mongokeyfile.key
# åŒæ—¶è¿˜è°ƒæ•´keyFileçš„æ‰€æœ‰è€…å’Œåªè¯»æƒé™.å¹¶åŒæ­¥åˆ°å…¶ä»–æ‰€æœ‰æœºå™¨
sudo chown mongodb:mongodb /home/joe/mongokeyfile.key && sudo chmod 400 /home/joe/mongokeyfile.key
```

- ä¿®æ”¹ mongod.conf é…ç½®æ–‡ä»¶

```bash
sudo nano /etc/mongod.conf
```

- 192.168.2.64 - 192.168.2.66 è¿™ä¸‰ä¸ªèŠ‚ç‚¹æˆ‘ä»¬å½“ä½œ shard1.å…¶é…ç½®å¦‚ä¸‹.

```conf
# mongod.conf
# for documentation of all options, see:
#   http://docs.mongodb.org/manual/reference/configuration-options/

# Where and how to store data.
storage:
  dbPath: /mongo
  journal:
    enabled: true
#  engine:
#  wiredTiger:

# where to write logging data.
systemLog:
  destination: file
  logAppend: true
  path: /mongo/logs/mongod.log

# network interfaces
net:
  port: 27017
  bindIp: 0.0.0.0

# how the process runs
processManagement:
  timeZoneInfo: /usr/share/zoneinfo

#security:
security:
  keyFile: /home/joe/mongokeyfile.key
  authorization: enabled

#operationProfiling:

replication:
  replSetName: sh1

sharding:
  clusterRole: shardsvr

## Enterprise-Only Options:

#auditLog:

#snmp:
```

- å¯è§æˆ‘ä»¬çš„é…ç½®æ–‡ä»¶ä¸­å¯ç”¨äº†å®‰å…¨æ ¡éªŒ,è‹¥æ˜¯å‡ºçŽ°ç¬¬ä¸€æ¬¡æ— æ³•ä½¿ç”¨ mongosh ç™»å½•,å¯å…ˆæ³¨é‡ŠæŽ‰ authorization: enabled ç­‰å¾…é…ç½®å¥½ç”¨æˆ·åŽå†å¼€å¯,shard2 ä¹Ÿæ˜¯å¦‚æ­¤.ä¿®æ”¹é…ç½®æ–‡ä»¶åŽ,mongod æœåŠ¡éœ€è¦é‡å¯ä¸€ä¸‹.
- è¿™é‡Œæˆ‘ä»¬éœ€è¦æ³¨æ„ä¸€ä¸‹ä¸€äº›å‚æ•°,å…¶ä¸­ dbPath æˆ‘å•ç‹¬æ”¾åˆ°äº†ç”¨äºŽæ•°æ®åº“ä½¿ç”¨çš„ç£ç›˜ä¸­.æ‰€ä»¥è·¯å¾„å’Œé»˜è®¤çš„ä¸ä¸€è‡´.
- ä»²è£èŠ‚ç‚¹ç”±äºŽä¸ä¿å­˜æ•°æ®,æ‰€ä»¥å¯ä»¥ä¸è°ƒæ•´é…ç½®æ–‡ä»¶å†…å®¹.ä»…éœ€åŒæ­¥ keyFile å³å¯.
- åŒæ—¶æˆ‘ä»¬éœ€è¦ç»™è¿™ä¸¤ä¸ªè·¯å¾„è°ƒæ•´ä¸€ä¸‹æ‰€æœ‰è€….(å®žé™…è·¯å¾„éœ€è¦æ ¹æ®è‡ªå·±çš„æƒ…å†µæ¥å®š)

```bash
sudo chown -R mongodb:mongodb /mongo
# è‹¥æ˜¯åŽæœŸå¯åŠ¨å‡ºçŽ°æ—¥å¿—ç›®å½•ä¸å­˜åœ¨çš„æƒ…å†µ,å¯ä»¥å…ˆæ‰‹åŠ¨æ·»åŠ ä¸€ä¸‹ç›®å½•(ä»…æ•°æ®èŠ‚ç‚¹æ·»åŠ å³å¯.è‹¥æ˜¯ä½¿ç”¨é»˜è®¤ç›®å½•è¿™ä¸¤è¡Œå‘½ä»¤éƒ½ä¸éœ€è¦)
sudo mkdir -p /mongo/logs && sudo chown -R mongodb:mongodb /mongo/logs
```

- å½“é…ç½®æ–‡ä»¶å†™å¥½äº†åŽå°±å¯ä»¥æ‰§è¡Œå‘½ä»¤å¯åŠ¨ mongod æœåŠ¡äº†.

```bash
sudo service mongod start
# ç­‰å¾…æ•°ç§’åŽ,å¯ä»¥ä½¿ç”¨å¦‚ä¸‹å‘½ä»¤æŸ¥çœ‹çŠ¶æ€
sudo service mongod status
```

- è¾“å‡ºå¦‚ä¸‹å†…å®¹è¡¨ç¤ºå¯åŠ¨æˆåŠŸ.(ä¸€èˆ¬æ¥è¯´ä½¿ç”¨ Linux çš„ç”¨æˆ·æˆ–è€…éƒ½æ¥çœ‹è¿™å¸–å­äº†,èƒ½çœ‹æ‡‚è¿™äº›å‘½ä»¤çš„å«ä¹‰)

![çŠ¶æ€](./images/640.png)

- 3 å°èŠ‚ç‚¹å‡éœ€å¯åŠ¨æˆåŠŸ.
- åœ¨æˆ‘ä»¬æ‰“ç®—åšä¸»èŠ‚ç‚¹çš„æœåŠ¡å™¨ä¸Šè¿›è¡ŒæŽ¥ä¸‹æ¥çš„æ“ä½œ,è¿™é‡Œæˆ‘ä»¬é€‰ 192.168.2.64
- ä½¿ç”¨ mongosh å‘½ä»¤(MongoDB 6.x æ–°å‘½ä»¤æ—§ç‰ˆä½¿ç”¨ mongo)ç™»å½•æœ¬æœº mongodb æœåŠ¡.

```bash
# å…ˆåˆ‡æ¢åˆ°adminæ•°æ®åº“.
use admin
# ç„¶åŽå¡«å…¥é…ç½®ä¿¡æ¯
config = {_id: 'sh1', members: [
                          {_id: 0, host: '192.168.2.64:27017'},
                          {_id: 1, host: '192.168.2.65:27017'},
                          {_id: 2, host: '192.168.2.66:27017',"arbiterOnly":true}]
}
# å†ç„¶åŽæ‰§è¡Œæ•°æ®åº“åˆå§‹åŒ–å‘½ä»¤
rs.initiate(config)
# ç­‰å¾…æ•°ç§’è¾“å‡º {"ok": 1}ç­‰ç±»ä¼¼æˆåŠŸçš„ä¿¡æ¯åŽ,å°±è¡¨ç¤ºåˆå§‹åŒ–æˆåŠŸ.
# æ‰§è¡Œé€€å‡ºå‘½ä»¤,é€€å‡ºäº¤äº’.è‡³æ­¤ç¬¬ä¸€ä¸ªå‰¯æœ¬é›†å°±é…ç½®å¥½äº†.
exit
```

- ç»™è¿™ä¸‰å°æœåŠ¡å™¨çš„ mongodb æœåŠ¡åšå¼€æœºè‡ªå¯åŠ¨

```bash
sudo systemctl enable mongod.service
```

- ç¬¬ä¸€ä¸ªå‰¯æœ¬é›†é…ç½®å¥½äº†åŽ,æˆ‘ä»¬å°±å¯ä»¥æ–­å¼€è¿™ä¸‰å°æœåŠ¡å™¨çš„ SSH é“¾æŽ¥,æŽ¥ä¸‹æ¥é…ç½®ç¬¬äºŒä¸ªå‰¯æœ¬é›†,æ“ä½œå’Œç¬¬ä¸€ä¸ªç±»ä¼¼,ä½†æ˜¯éƒ¨åˆ†é…ç½®ä¿¡æ¯ä¸ä¸€æ ·.
- ä½¿ç”¨ SSH è¿žæŽ¥ä¸Š 192.168.2.67-192.168.2.69 ä¸‰å°æœåŠ¡å™¨åŽ,ä¾ç…§ä¸Šè¾¹çš„å‘½ä»¤ä¿®æ”¹é…ç½®æ–‡ä»¶

```bash
sudo nano /etc/mongod.conf
```

- è¿™ä¸‰å°æœåŠ¡å™¨æˆ‘ä»¬å½“ä½œç¬¬äºŒä¸ªå‰¯æœ¬é›† shard2

```conf
# mongod.conf
# for documentation of all options, see:
#   http://docs.mongodb.org/manual/reference/configuration-options/

# Where and how to store data.
storage:
  dbPath: /mongo
  journal:
    enabled: true
#  engine:
#  wiredTiger:

# where to write logging data.
systemLog:
  destination: file
  logAppend: true
  path: /mongo/logs/mongod.log

# network interfaces
net:
  port: 27017
  bindIp: 0.0.0.0

# how the process runs
processManagement:
  timeZoneInfo: /usr/share/zoneinfo

#security:
security:
  keyFile: /home/joe/mongokeyfile.key
  authorization: enabled

#operationProfiling:

replication:
  replSetName: sh2

sharding:
  clusterRole: shardsvr

## Enterprise-Only Options:

#auditLog:

#snmp:
```

- å…¶ä¸­ replSetName: sh2 å’Œ shard1 ä¸ä¸€æ ·,åˆ«çš„éƒ½ä¸€è‡´çš„.åŒæ ·å…¶ä¸­çš„è·¯å¾„éœ€è¦æ ¹æ®è‡ªå·±çš„å®žé™…æƒ…å†µè°ƒæ•´
- ç„¶åŽå¯åŠ¨ä¸‰ä¸ªèŠ‚ç‚¹çš„ mongodb æœåŠ¡.
- ç„¶åŽåœ¨åˆå§‹åŒ– shard2 å‰¯æœ¬é›†.åœ¨æˆ‘ä»¬éœ€è¦åšä¸»èŠ‚ç‚¹çš„æœºå™¨ä¸Š 192.168.2.67 ä¸Šæ‰§è¡Œç±»ä¼¼æ“ä½œ

```bash
# ç™»å½•åˆ°æœ¬æœºçš„mongodbæœåŠ¡
mongosh
# åˆ‡æ¢åˆ°adminæ•°æ®åº“
use admin
# é…ç½®å‰¯æœ¬é›†äºŒ
config = {_id: 'sh2', members: [
                          {_id: 0, host: '192.168.2.67:27017'},
                          {_id: 1, host: '192.168.2.68:27017'},
                          {_id: 2, host: '192.168.2.69:27017',"arbiterOnly":true}]
}
# åˆå§‹åŒ–å‰¯æœ¬é›†
rs.initiate(config)
# ç­‰å¾…æ•°ç§’æç¤ºæˆåŠŸåŽé€€å‡º
exit
```

- é…ç½® 3 å°æœåŠ¡å™¨çš„ mongodb æœåŠ¡è‡ªå¯åŠ¨

```bash
sudo systemctl enable mongod.service
```

- è‡ªæ­¤ä¸¤ä¸ªå‰¯æœ¬é›†çš„é…ç½®å°±å®Œæˆäº†.æŽ¥ä¸‹æ¥æˆ‘ä»¬é…ç½® Config Server æœåŠ¡
- é¦–å…ˆé€€å‡º 6 ä¸ªå‰¯æœ¬é›†çš„ SSH é“¾æŽ¥,é¿å…æ“ä½œé”™è¯¯äº†.
- ç™»å½• 192.168.2.61-192.168.2.63 è¿™ä¸‰å°æœåŠ¡å™¨.
- è°ƒæ•´ä»–ä»¬çš„ mongod.conf æ–‡ä»¶

```bash
sudo nano /etc/mongod.conf
```

- è°ƒæ•´é…ç½®æ–‡ä»¶å†…å®¹å¦‚ä¸‹

```conf
# mongod.conf
# for documentation of all options, see:
#   http://docs.mongodb.org/manual/reference/configuration-options/

# Where and how to store data.
storage:
  dbPath: /var/lib/mongodb
  journal:
    enabled: true
#  engine:
#  wiredTiger:

# where to write logging data.
systemLog:
  destination: file
  logAppend: true
  path: /var/log/mongodb/mongod.log

# network interfaces
net:
  port: 27017
  bindIp: 0.0.0.0

# how the process runs
processManagement:
  timeZoneInfo: /usr/share/zoneinfo

#security:
security:
  keyFile: /home/joe/mongokeyfile.key
  authorization: enabled

#operationProfiling:

replication:
  replSetName: configReplSet
sharding:
  clusterRole: configsvr

## Enterprise-Only Options:

#auditLog:

#snmp:
```

- è¿™é‡Œç”±äºŽæ˜¯é…ç½®æ–‡ä»¶æœåŠ¡,æ‰€ä»¥æˆ‘ä½¿ç”¨äº†é»˜è®¤çš„æ–‡ä»¶å¤¹è·¯å¾„.ä¹Ÿå¯ä»¥ä¾æ®å®žé™…æƒ…å†µè¿›è¡Œè°ƒæ•´.
- å’Œå‰è¾¹å·®ä¸å¤šç±»ä¼¼çš„æ“ä½œ,æ”¹å¥½ä¸‰å°æœåŠ¡å™¨çš„é…ç½®æ–‡ä»¶åŽ,å°±ç›´æŽ¥å¯åŠ¨ mongod æœåŠ¡.
- ç„¶åŽç™»å½•ä¸»èŠ‚ç‚¹ 192.168.2.61 æ¥é…ç½® Config Server çš„é›†ç¾¤æœåŠ¡.

```bash
# ç™»å½•mongodb
mongosh
# åˆ‡æ¢adminæ•°æ®åº“
use admin
# é›†ç¾¤æœåŠ¡å™¨é…ç½®(æ–°ç‰ˆçš„mongodbä»…å…è®¸é…ç½®æœåŠ¡æ˜¯å‰¯æœ¬é›†é›†ç¾¤.)
config = {_id: 'configReplSet', members: [
                          {_id: 0, host: '192.168.2.61:27017'},
                          {_id: 1, host: '192.168.2.62:27017'},
                          {_id: 2, host: '192.168.2.63:27017'}]
}
# ç„¶åŽä¾æ®é…ç½®åˆå§‹åŒ–é›†ç¾¤
rs.initiate(config)
# é€€å‡ºshelläº¤äº’ç•Œé¢
exit
```

- ä¸€æ · Config Server ä¹Ÿéœ€è¦å¼€æœºè‡ªå¯åŠ¨.æ‰§è¡Œå‰è¾¹çš„å‘½ä»¤å³å¯.

```bash
sudo systemctl enable mongod.service
```

- é€€å‡ºä¸‰å°é…ç½®æœåŠ¡æœåŠ¡å™¨.è‡³æ­¤,Config Server é›†ç¾¤å°±é…ç½®å¥½äº†.
- æŽ¥ä¸‹æ¥é…ç½® mongos æœåŠ¡.
- é¦–å…ˆæˆ‘ä»¬æ ¹æ® mongod.conf çš„æ–‡ä»¶æ¨¡æ¿åˆ›å»ºä¸€ä¸ª mongos.conf æ–‡ä»¶

```bash
sudo cp /etc/mongod.conf /etc/mongos.conf
# æ‰“å¼€mongos.confæ–‡ä»¶ç¼–è¾‘
sudo nano /etc/mongos.conf
```

- å…¶ä¸­ mongos.conf çš„é…ç½®ä¿¡æ¯å¦‚ä¸‹

```conf
# mongod.conf

# for documentation of all options, see:
#   http://docs.mongodb.org/manual/reference/configuration-options/

# Where and how to store data.
#storage:
#  dbPath: /var/lib/mongodb
#  journal:
#    enabled: true
#  engine:
#  wiredTiger:

# where to write logging data.
systemLog:
  destination: file
  logAppend: true
  path: /var/log/mongodb/mongos.log

# network interfaces
net:
  port: 27017
  bindIp: 0.0.0.0


# how the process runs
processManagement:
  timeZoneInfo: /usr/share/zoneinfo

security:
  keyFile: /home/joe/mongokeyfile.key

#operationProfiling:

#replication:

sharding:
  configDB: configReplSet/192.168.2.61:27017,192.168.2.62:27017,192.168.2.63:27017

## Enterprise-Only Options:

#auditLog:

#snmp:
```

- ä»Žé…ç½®æ–‡ä»¶ä¸­æˆ‘ä»¬å¯ä»¥å‘çŽ°,mongos ä¸éœ€è¦æ•°æ®å­˜å‚¨ç›®å½•.æ‰€ä»¥ç›´æŽ¥æ³¨é‡ŠæŽ‰å°±è¡Œ.å…¶ä»–é…ç½®æŒ‰ç…§é…ç½®æ–‡ä»¶çš„å†…å®¹è°ƒæ•´å³å¯.
- è®¾ç½®å¥½é…ç½®æ–‡ä»¶åŽ,æˆ‘ä»¬å°±ä¸èƒ½ç›´æŽ¥å¯åŠ¨ mongod æœåŠ¡äº†,å› ä¸ºè¿™ä¸ªæœåŠ¡å™¨æ˜¯ mongos
- é¦–å…ˆæˆ‘ä»¬å°† mongd çš„ service æ–‡ä»¶ copy åˆ° mongos.service ä¸­

```bash
sudo cp /lib/systemd/system/mongosd.service /lib/systemd/system/mongos.service
# ç„¶åŽç¼–è¾‘ä¸€ä¸‹mongos.service
sudo nano /lib/systemd/system/mongos.service
```

- å°†å…¶ä¸­çš„ä¿¡æ¯æ”¹æˆå¦‚ä¸‹å†…å®¹

```conf
[Unit]
Description=MongoDB Database Server
Documentation=https://docs.mongodb.org/manual
After=network-online.target
Wants=network-online.target

[Service]
User=mongodb
Group=mongodb
EnvironmentFile=-/etc/default/mongod
ExecStart=/usr/bin/mongos --config /etc/mongos.conf
PIDFile=/var/run/mongodb/mongos.pid
# file size
LimitFSIZE=infinity
# cpu time
LimitCPU=infinity
# virtual memory size
LimitAS=infinity
# open files
LimitNOFILE=64000
# processes/threads
LimitNPROC=64000
# locked memory
LimitMEMLOCK=infinity
# total threads (user+kernel)
TasksMax=infinity
TasksAccounting=false

# Recommended limits for mongod as specified in
# https://docs.mongodb.com/manual/reference/ulimit/#recommended-ulimit-settings

[Install]
WantedBy=multi-user.target
```

- ä¸Šè¿°çš„æ–‡ä»¶ä¸»è¦è°ƒæ•´è¿™ä¸¤è¡Œ,å°†å¯åŠ¨å‘½ä»¤æ¢æˆäº† mongos ä»¥åŠé…ç½®æ–‡ä»¶æŒ‡å®šä¸ºæˆ‘ä»¬å‰è¾¹ä¿®æ”¹çš„é…ç½®æ–‡ä»¶

```bash
ExecStart=/usr/bin/mongos --config /etc/mongos.conf
PIDFile=/var/run/mongodb/mongos.pid
```

- ä¿®æ”¹å¥½åŽ,æˆ‘ä»¬å°±å¯ä»¥æ‰§è¡Œå¦‚ä¸‹å‘½ä»¤æ¥å¯åŠ¨ mongos æœåŠ¡ä»¥åŠéªŒè¯æœåŠ¡è¿è¡ŒçŠ¶æ€.

```bash
# å¯åŠ¨æœåŠ¡
sudo service mongos start
# æŸ¥çœ‹è¿è¡ŒçŠ¶æ€
sudo service mongos status
```

- å½“æœåŠ¡æˆåŠŸå¯åŠ¨åŽ.æˆ‘ä»¬å°±å¯ä»¥ä½¿ç”¨ mongosh è¿›è¡Œé…ç½®å’Œåˆå§‹åŒ–æ•´ä¸ªé›†ç¾¤äº†.

```bash
# ç™»å½•mongosæœåŠ¡
mongosh
# åˆ‡æ¢åˆ°adminæ•°æ®åº“
use admin
# æ·»åŠ åˆ†ç‰‡ä¸€
db.runCommand( { addshard : "sh1/192.168.2.64:27017,192.168.2.65:27017,192.168.2.66:27017",name:"shard1"} )
# æ·»åŠ åˆ†ç‰‡äºŒ
db.runCommand( { addshard : "sh2/192.168.2.67:27017,192.168.2.68:27017,192.168.2.69:27017",name:"shard2"} )
# æ·»åŠ æˆåŠŸåŽ,ä¼šè¾“å‡ºç±»ä¼¼å¦‚ä¸‹ä¿¡æ¯
{
	"shardAdded" : "shard1",
	"ok" : 1,
	"operationTime" : Timestamp(1638349820, 6),
	"$clusterTime" : {
		"clusterTime" : Timestamp(1638349820, 6),
		"signature" : {
			"hash" : BinData(0,"AAAAAAAAAAAAAAAAAAAAAAAAAAA="),
			"keyId" : NumberLong(0)
		}
	}
}
# å¯ä»¥æŸ¥çœ‹é›†ç¾¤çŠ¶æ€
sh.status()

# æ·»åŠ ç”¨æˆ·.æ·»åŠ åŽ,å³å¯å¼€å¯åˆ†ç‰‡å‰¯æœ¬é›†çš„å®‰å…¨è®¤è¯é€‰é¡¹äº†.
db.createUser({user: "aaa", pwd: "123456", roles: [{ role: "root", db: "admin" }]});

# é€€å‡ºshelläº¤äº’
exit
```

- è‡³æ­¤,MongoDB çš„åˆ†ç‰‡é›†ç¾¤å³éƒ¨ç½²æˆåŠŸ,æœ€åŽåˆ«å¿˜è®°å¼€æœºè‡ªå¯åŠ¨ mongos æœåŠ¡

```bash
sudo systemctl enable mongos.service
```

- æŽ¥ä¸‹æ¥ä¸€äº›åˆ†ç‰‡é›†ç¾¤çš„ä½¿ç”¨å†…å®¹,æˆ‘å°±ç›´æŽ¥å¤åˆ¶ä¸Šè¾¹å‚è€ƒé“¾æŽ¥çš„å†…å®¹äº†.
- æ¿€æ´»æ•°æ®åº“çš„åˆ†ç‰‡åŠŸèƒ½,éœ€è¦ç™»å½•åˆ° mongos

```bash
mongosh
# è¯­æ³•ï¼š
mongos> db.runCommand({enablesharding: 'æ•°æ®åº“åç§°'})

#æ¯”å¦‚å¯¹testæ•°æ®åº“å¼€å¯åˆ†ç‰‡åŠŸèƒ½ï¼š
mongos> db.runCommand({enablesharding: 'test'})
# é€€å‡ºshelläº¤äº’ç•Œé¢
exit
```

- ç»™æ•°æ®åº“çš„æŸä¸ªè¡¨æŒ‡å®šåˆ†ç‰‡é”®,èŒƒå›´åˆ†ç‰‡

```bash
mongosh

# åˆ‡æ¢åˆ°teståº“
mongos> use test

# ç»™è¡¨æ·»åŠ ä¸€ä¸ªç´¢å¼•
mongos> db.testRange.ensureIndex({id: 1})

#åˆ‡æ¢åˆ°adminåº“
mongos> use admin

# æŒ‡å®šç‰‡é”®ï¼Œå¼€å¯åˆ†ç‰‡åŠŸèƒ½ï¼ŒèŒƒå›´åˆ†ç‰‡
mongos> db.runCommand({shardcollection: "test.testRange", key: {id: 1}})

# é€€å‡ºshelläº¤äº’
exit
```
