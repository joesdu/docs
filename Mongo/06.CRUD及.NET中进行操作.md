# ä» 0 å¼€å§‹ MongoDB CRUD åŠ.NET ä¸­å¦‚ä½•ä½¿ç”¨

- å‰é¢å‡ ç¯‡æ–‡ç« è¯¦ç»†çš„ä»‹ç»äº†,å¦‚ä½•ä½¿ç”¨ Ubuntu ç³»ç»Ÿè¿›è¡Œå„ç§æ¨¡å¼çš„é›†ç¾¤éƒ¨ç½².ä»Šå¤©è¿™é‡Œæˆ‘ä»¬å°±å¼€å§‹æ­£å¼çš„ä½¿ç”¨.
- ç”±äº MongoDB æ“ä½œå¾ˆå¤š,å¾ˆå¤šæ“ä½œè¿˜å¾ˆå¤æ‚,éœ€è¦ä¸€äº›åŠŸåº•,æ‰€ä»¥è¿™é‡Œå…ˆä»æ•°æ®åº“ç•Œçš„ Hello World(CRUD)å¼€å§‹.
- æœ¬æ¥æƒ³ç›´æ¥ä¸Šæ¥å°±è®²æ“ä½œçš„,æ‰å‘ç° Mongodb çš„è¯­æ³•å’Œä¸€èˆ¬æ•°æ®åº“ä¸ä¸€æ ·,è¿˜å¾—å…ˆä»‹ç»ä¸‹æŸ¥è¯¢æ¡ä»¶.
- æŸ¥è¯¢æ¡ä»¶å¸¸åœ¨æ›´æ–°å’ŒæŸ¥è¯¢æ—¶å€™ä½¿ç”¨,å½“ç„¶ä½¿ç”¨èšåˆç®¡é“çš„æ—¶å€™ä¹Ÿéœ€è¦ä½¿ç”¨åˆ°.
- è¿™é‡Œå…ˆå°†æ”¯æŒçš„æ“ä½œç¬¦åˆ†ç±»åˆ—ä¸¾å‡ºæ¥.å‚è€ƒ[å®˜æ–¹æ–‡æ¡£](https://www.mongodb.com/docs/rapid/reference/operator/query)

### æ¯”è¾ƒ(Comparison)

| åå­— | å«ä¹‰                           | è‹±æ–‡åŸæ–‡                                                            |
| ---- | ------------------------------ | ------------------------------------------------------------------- |
| $eq  | åŒ¹é… ç­‰äº(==) æŒ‡å®šå€¼çš„å€¼       | Matches values that are equal to a specified value.                 |
| $gt  | åŒ¹é… å¤§äº(>) æŒ‡å®šå€¼çš„å€¼        | Matches values that are greater than a specified value.             |
| $gte | åŒ¹é… å¤§äºç­‰äº(>=) æŒ‡å®šå€¼çš„å€¼   | Matches values that are greater than or equal to a specified value. |
| $in  | åŒ¹é…æ•°ç»„ä¸­æŒ‡å®šçš„ä»»ä½•å€¼         | Matches any of the values specified in an array.                    |
| $lt  | åŒ¹é… å°äº(<) æŒ‡å®šå€¼çš„å€¼        | Matches values that are less than a specified value.                |
| $lte | åŒ¹é… å°äºæˆ–ç­‰äº(<=) æŒ‡å®šå€¼çš„å€¼ | Matches values that are less than or equal to a specified value.    |
| $ne  | åŒ¹é… æ‰€æœ‰ä¸ç­‰äº(!=) æŒ‡å®šå€¼çš„å€¼ | Matches all values that are not equal to a specified value.         |
| $nin | ä¸æ•°ç»„ä¸­æŒ‡å®šçš„å€¼å‡ä¸åŒ¹é…       | Matches none of the values specified in an array.                   |

### é€»è¾‘(Logical)

| åå­— | å«ä¹‰                                                    | è‹±æ–‡åŸæ–‡                                                                                                |
| ---- | ------------------------------------------------------- | ------------------------------------------------------------------------------------------------------- |
| $and | ç”¨é€»è¾‘å’Œè¿æ¥æŸ¥è¯¢å­å¥,è¿”å›ç¬¦åˆä¸¤ä¸ªå­å¥æ¡ä»¶çš„æ‰€æœ‰æ–‡æ¡£     | Joins query clauses with a logical AND returns all documents that match the conditions of both clauses. |
| $not | åæ˜ ä¸€ä¸ªæŸ¥è¯¢è¡¨è¾¾å¼çš„æ•ˆæœ,å¹¶è¿”å›ä¸æŸ¥è¯¢è¡¨è¾¾å¼ä¸åŒ¹é…çš„æ–‡ä»¶ | Inverts the effect of a query expression and returns documents that do not match the query expression.  |
| $nor | ç”¨é€»è¾‘ NOR è¿æ¥æŸ¥è¯¢å­å¥,è¿”å›æ‰€æœ‰ä¸èƒ½åŒ¹é…ä¸¤ä¸ªå­å¥çš„æ–‡æ¡£  | Joins query clauses with a logical NOR returns all documents that fail to match both clauses.           |
| $or  | ç”¨é€»è¾‘ OR è¿æ¥æŸ¥è¯¢å­å¥,è¿”å›ç¬¦åˆä»»ä¸€å­å¥æ¡ä»¶çš„æ‰€æœ‰æ–‡æ¡£   | Joins query clauses with a logical OR returns all documents that match the conditions of either clause. |

### å…ƒç´ (Element)

| åå­—    | å«ä¹‰                                | è‹±æ–‡åŸæ–‡                                               |
| ------- | ----------------------------------- | ------------------------------------------------------ |
| $exists | åŒ¹é…æœ‰æŒ‡å®šå­—æ®µçš„æ–‡æ¡£                | Matches documents that have the specified field.       |
| $type   | å¦‚æœä¸€ä¸ªå­—æ®µæ˜¯æŒ‡å®šçš„ç±»å‹,åˆ™é€‰æ‹©æ–‡ä»¶ | Selects documents if a field is of the specified type. |

### è¯„ä»·(Evaluation)

è¿™ä¸ªè‹±æ–‡ç¿»è¯‘è¿‡æ¥æœ‰ç‚¹ä¸çŸ¥é“ç†è§£äº† ğŸ¤£,çœ‹åˆ«äººä¹Ÿè¿™ä¹ˆç¿»è¯‘çš„,å°±æš‚ä¸”è¿™ä¹ˆå«å§,è¿™ä¸ªæ–¹é¢çš„é€‰æ‹©å™¨,ç›®å‰åœ¨å·¥ä½œä¸­å¤§éƒ¨åˆ†å°šæœªé‡åˆ°,åæœŸç ”ç©¶äº†å†ç»†ç©¶.

| åå­—        | å«ä¹‰                                                | è‹±æ–‡åŸæ–‡                                                             |
| ----------- | --------------------------------------------------- | -------------------------------------------------------------------- |
| $expr       | å…è®¸åœ¨æŸ¥è¯¢è¯­è¨€ä¸­ä½¿ç”¨èšåˆè¡¨è¾¾å¼                      | Allows use of aggregation expressions within the query language.     |
| $jsonSchema | æ ¹æ®ç»™å®šçš„ JSON æ¨¡å¼éªŒè¯æ–‡æ¡£                        | Allows use of aggregation expressions within the query language.     |
| $mod        | å¯¹ä¸€ä¸ªå­—æ®µçš„å€¼è¿›è¡Œæ¨¡æ•°è¿ç®—,å¹¶é€‰æ‹©å…·æœ‰æŒ‡å®šç»“æœçš„æ–‡æ¡£ | Validate documents against the given JSON Schema.                    |
| $regex      | é€‰æ‹©é‚£äº›æ•°å€¼ä¸æŒ‡å®šçš„æ­£åˆ™è¡¨è¾¾å¼ç›¸åŒ¹é…çš„æ–‡ä»¶          | Selects documents where values match a specified regular expression. |
| $text       | æ‰§è¡Œæ–‡æœ¬æœç´¢                                        | Performs text search.                                                |
| $where      | åŒ¹é…æ»¡è¶³ JavaScript è¡¨è¾¾å¼çš„æ–‡æ¡£                    | Matches documents that satisfy a JavaScript expression.              |

### åœ°ç†ä½ç½®(Geospatial)

| åå­—           | å«ä¹‰                                                | è‹±æ–‡åŸæ–‡                                                                                                                                       |
| -------------- | --------------------------------------------------- | ---------------------------------------------------------------------------------------------------------------------------------------------- |
| $geoIntersects | é€‰æ‹©ä¸ GeoJSON å‡ ä½•ä½“ç›¸äº¤çš„å‡ ä½•ä½“                   | Selects geometries that intersect with a GeoJSON geometry. The 2dsphere index supports \$geoIntersects.                                        |
| $geoWithin     | åœ¨ä¸€ä¸ªæœ‰è¾¹ç•Œçš„ GeoJSON å‡ ä½•ä½“ä¸­é€‰æ‹©å‡ ä½•ä½“           | Selects geometries within a bounding GeoJSON geometry. The 2dsphere and 2d indexes support \$geoWithin.                                        |
| $near          | è¿”å›é è¿‘æŸä¸ªç‚¹çš„åœ°ç†ç©ºé—´å¯¹è±¡.éœ€è¦åœ°ç†ç©ºé—´ç´¢å¼•       | Returns geospatial objects in proximity to a point. Requires a geospatial index. The 2dsphere and 2d indexes support \$near.                   |
| $nearSphere    | è¿”å›ä¸çƒä½“ä¸Šçš„ç‚¹é™„è¿‘çš„åœ°ç†ç©ºé—´å¯¹è±¡.éœ€è¦åœ°ç†ç©ºé—´ç´¢å¼• | Returns geospatial objects in proximity to a point on a sphere. Requires a geospatial index. The 2dsphere and 2d indexes support \$nearSphere. |

### æ•°ç»„(Array)

| åå­—       | å«ä¹‰                                                | è‹±æ–‡åŸæ–‡                                                                                         |
| ---------- | --------------------------------------------------- | ------------------------------------------------------------------------------------------------ |
| $all       | åŒ¹é…åŒ…å«æŸ¥è¯¢ä¸­æŒ‡å®šçš„æ‰€æœ‰å…ƒç´ çš„æ•°ç»„                  | Matches arrays that contain all elements specified in the query.                                 |
| $elemMatch | å¦‚æœæ•°ç»„å­—æ®µä¸­çš„å…ƒç´ ä¸æ‰€æœ‰æŒ‡å®šçš„å…ƒç´ åŒ¹é…,åˆ™é€‰æ‹©æ–‡æ¡£ | Selects documents if element in the array field matches all the specified $elemMatch conditions. |
| $size      | å¦‚æœæ•°ç»„å­—æ®µä¸ºæŒ‡å®šå¤§å°,åˆ™é€‰æ‹©æ–‡æ¡£                   | Selects documents if the array field is a specified size.                                        |

### æŒ‰ä½(Bitwise)

| åå­—          | å«ä¹‰                                                      | è‹±æ–‡åŸæ–‡                                                                                        |
| ------------- | --------------------------------------------------------- | ----------------------------------------------------------------------------------------------- |
| $bitsAllClear | åŒ¹é…æ•°å­—æˆ–äºŒè¿›åˆ¶å€¼,å…¶ä¸­ä¸€ç»„æ¯”ç‰¹ä½ç½®çš„å€¼å‡ä¸º 0             | Matches numeric or binary values in which a set of bit positions all have a value of 0.         |
| $bitsAllSet   | åŒ¹é…æ•°å­—æˆ–äºŒè¿›åˆ¶å€¼,å…¶ä¸­ä¸€ç»„æ¯”ç‰¹ä½ç½®çš„å€¼éƒ½æ˜¯ 1             | Matches numeric or binary values in which a set of bit positions all have a value of 1.         |
| $bitsAnyClear | åŒ¹é…æ•°å­—æˆ–äºŒè¿›åˆ¶å€¼,å…¶ä¸­ä¸€ç»„æ¯”ç‰¹ä½ç½®çš„ä»»ä½•ä¸€ä¸ªæ¯”ç‰¹çš„å€¼ä¸º 0 | Matches numeric or binary values in which any bit from a set of bit positions has a value of 0. |
| $bitsAnySet   | åŒ¹é…æ•°å­—æˆ–äºŒè¿›åˆ¶å€¼,å…¶ä¸­ä¸€ç»„æ¯”ç‰¹ä½ç½®çš„ä»»ä½•ä¸€ä¸ªæ¯”ç‰¹çš„å€¼ä¸º 1 | Matches numeric or binary values in which any bit from a set of bit positions has a value of 1. |

---

- ä¸Šè¿°æ˜¯æŸ¥è¯¢è¿ç®—ç¬¦,æ¥ä¸‹æ¥æ˜¯æŠ•å½±è¿ç®—ç¬¦

### æŠ•å½±è¿ç®—ç¬¦(Projection Operators)

| åå­—       | å«ä¹‰                                                  | è‹±æ–‡åŸæ–‡                                                                                 |
| ---------- | ----------------------------------------------------- | ---------------------------------------------------------------------------------------- |
| $          | æŠ•å°„ä¸€ä¸ªæ•°ç»„ä¸­ç¬¦åˆæŸ¥è¯¢æ¡ä»¶çš„ç¬¬ä¸€ä¸ªå…ƒç´                 | Projects the first element in an array that matches the query condition.                 |
| $elemMatch | æŠ•å°„ä¸€ä¸ªæ•°ç»„ä¸­ç¬¦åˆæŒ‡å®šçš„ \$elemMatch æ¡ä»¶çš„ç¬¬ä¸€ä¸ªå…ƒç´  | Projects the first element in an array that matches the specified \$elemMatch condition. |
| $meta      | æŠ•å°„åœ¨$text æ“ä½œä¸­åˆ†é…çš„æ–‡æ¡£åˆ†æ•°                      | Projects the document's score assigned during $text operation.                           |
| $slice     | é™åˆ¶ä»ä¸€ä¸ªæ•°ç»„ä¸­æŠ•å°„çš„å…ƒç´ çš„æ•°é‡.æ”¯æŒè·³è¿‡å’Œé™åˆ¶åˆ†ç‰‡   | Limits the number of elements projected from an array. Supports skip and limit slices.   |

### æ‚é¡¹è¿ç®—ç¬¦(Miscellaneous Operators)

| åå­—     | å«ä¹‰                             | è‹±æ–‡åŸæ–‡                                  |
| -------- | -------------------------------- | ----------------------------------------- |
| $comment | ä¸ºä¸€ä¸ªæŸ¥è¯¢è°“è¯æ·»åŠ æ³¨é‡Š           | Adds a comment to a query predicate.      |
| $rand    | äº§ç”Ÿä¸€ä¸ª 0 åˆ° 1 ä¹‹é—´çš„éšæœºæµ®ç‚¹æ•° | Generates a random float between 0 and 1. |

---

### å­—æ®µæ›´æ–°(Field Update Operators)

| åå­—         | å«ä¹‰                                                                                   | è‹±æ–‡åŸæ–‡                                                                                                                                      |
| ------------ | -------------------------------------------------------------------------------------- | --------------------------------------------------------------------------------------------------------------------------------------------- |
| $currentDate | å°†ä¸€ä¸ªå­—æ®µçš„å€¼è®¾ç½®ä¸ºå½“å‰æ—¥æœŸ,å¯ä»¥æ˜¯æ—¥æœŸæˆ–æ—¶é—´æˆ³                                        | Sets the value of a field to current date, either as a Date or a Timestamp.                                                                   |
| $inc         | å°†å­—æ®µçš„å€¼æŒ‰æŒ‡å®šçš„æ•°é‡é€’å¢                                                             | Increments the value of the field by the specified amount.                                                                                    |
| $min         | åªåœ¨æŒ‡å®šå€¼å°äºç°æœ‰å­—æ®µå€¼æ—¶æ›´æ–°å­—æ®µ                                                     | Only updates the field if the specified value is less than the existing field value.                                                          |
| $max         | ä»…å½“æŒ‡å®šçš„å€¼å¤§äºç°æœ‰å­—æ®µçš„å€¼æ—¶æ‰æ›´æ–°å­—æ®µ                                               | Only updates the field if the specified value is greater than the existing field value.                                                       |
| $mul         | å°†å­—æ®µçš„å€¼ä¹˜ä»¥æŒ‡å®šçš„æ•°é‡                                                               | Multiplies the value of the field by the specified amount.                                                                                    |
| $rename      | é‡å‘½åä¸€ä¸ªå­—æ®µ                                                                         | Renames a field.                                                                                                                              |
| $set         | åœ¨æ–‡æ¡£ä¸­è®¾ç½®ä¸€ä¸ªå­—æ®µçš„å€¼                                                               | Sets the value of a field in a document.                                                                                                      |
| $setOnInsert | è®¾ç½®ä¸€ä¸ªå­—æ®µçš„å€¼,å¦‚æœä¸€ä¸ªæ›´æ–°æ“ä½œå¯¼è‡´äº†ä¸€ä¸ªæ–‡æ¡£çš„æ’å…¥.å¯¹ä¿®æ”¹ç°æœ‰æ–‡æ¡£çš„æ›´æ–°æ“ä½œæ²¡æœ‰å½±å“ | Sets the value of a field if an update results in an insert of a document. Has no effect on update operations that modify existing documents. |
| $unset       | ä»ä¸€ä¸ªæ–‡æ¡£ä¸­åˆ é™¤æŒ‡å®šçš„å­—æ®µ                                                             | Removes the specified field from a document.                                                                                                  |

---

- å¦‚ä¸Šå°±æ˜¯å¸¸ç”¨çš„ä¸€äº›æŸ¥è¯¢æ“ä½œç¬¦.å…¶å®ä¸å¿…å®³æ€•éœ€è¦å­¦ä¹ è¿™ä¹ˆå¤š,å…¶å®å¸¸ç”¨çš„å°±æ˜¯æ¯”è¾ƒå’Œé€»è¾‘è¿ç®—ç¬¦,åˆ«çš„æ“ä½œå¯ä»¥å…ˆäº†è§£ä¸‹,å½“éœ€è¦çš„æ—¶å€™å†å»å®˜ç½‘æŸ¥è¯¢.
- æ¥ä¸‹æ¥æˆ‘ä»¬å…ˆä½¿ç”¨ Navicat,æˆ–è€… MongoDB Compass è¿æ¥åˆ° MongoDB è¿›è¡Œä¸€äº›å¸¸è§„çš„ CRUD æ“ä½œ.æˆ‘è¿™é‡Œä½¿ç”¨ Navicat,å› ä¸ºä»–æ”¯æŒä¸­æ–‡.
- é¦–å…ˆæˆ‘ä»¬æ–°å¢ä¸€äº›æµ‹è¯•æ•°æ®.
- ç›´æ¥ç‚¹å‡»æ–°å»ºæŸ¥è¯¢.è¾“å…¥å¦‚ä¸‹ä»£ç ,ç‚¹å‡»æ‰§è¡Œ.

```JavaScript
// æ’å…¥ä¸€æ¡æ•°æ®
db.getCollection('crud').insertOne({
    'index': 0,
    'name': 'å¼ ä¸‰',
    'age': 12,
    'gender': 'å¥³',
    'birthday': new Date('2023-01-14')
});
```

- é€šè¿‡ä¸Šè¿°æ“ä½œæˆ‘ä»¬å¯ä»¥å‘ç°,mongodb ç›¸å½“çš„æ–¹ä¾¿,ä¸éœ€è¦å…ˆåˆ›å»ºå¥½æ•°æ®åº“å’Œé›†åˆå³å¯ç›´æ¥æ’å…¥æ•°æ®.è¿™ä¹Ÿæ˜¯æˆ‘éå¸¸å–œæ¬¢ä»–çš„åŸå› ä¹‹ä¸€.è™½ç„¶æˆ‘è¿™é‡Œæå‰åˆ›å»ºäº† test æ•°æ®åº“.
- æ¥ä¸‹æ¥ä»‹ç»æ’å…¥å¤šæ¡æ•°æ®çš„æ“ä½œ.

```JavaScript
// åˆ›å»ºä¸€ä¸ªæ•°ç»„,å¾ªç¯å°†æ•°æ®åŠ å…¥å…¶ä¸­
var list = [];
for (var i = 0; i < 100; i++) {
    list.push({
        "index": i,
        "name": "å¼ ä¸‰",
        "age": i + 1,
        "gender": "å¥³",
        "birthday": new Date('2023-01-14')
    });
}
// æ‰§è¡ŒMongoDBè¯­å¥æ‰¹é‡æ’å…¥æ•°æ®.
db.getCollection("crud").insertMany(list);
```

- é€šè¿‡ä¸Šè¿°ä»£ç å°±å¯ä»¥å‘ç° mongodb çš„"SQL è¯­å¥"å…¶å®å°±æ˜¯ JavaScript ä»£ç ,æ¯”èµ· SQL è¯­å¥,JavaScript çš„é€»è¾‘æ¸…æ™°,æ›´æ˜“ç†è§£äº†.
- æ‰€ä»¥åœ¨å¯è§†åŒ–ç®¡ç†å·¥å…·ä¸­,æˆ‘ä»¬å¯ä»¥åˆ©ç”¨ JavaScript ä»£ç æ¥æ‰§è¡Œä¸€äº›æ“ä½œå’ŒæŸ¥è¯¢ä»¥åŠå¤æ‚ç®—æ³•.
- æ–°å¢å’Œæ‰¹é‡æ–°å¢å‡å·²ç»å†™å®Œäº†,æ¥ä¸‹æ¥å°±æ˜¯æ›´æ–°äº†.
- æ¯”å¦‚æˆ‘ä»¬éœ€è¦æ›´æ–°æ‰€æœ‰ index = 0 çš„ name å±æ€§ä¸ºæå››

```JavaScript
// ç”±äºå‰è¾¹çš„ä»£ç æˆ‘ä»¬å¯ä»¥å‘ç°,index == 0 çš„æ–‡æ¡£å…¶å®æœ‰ä¸¤ä¸ª,æ‰€ä»¥æˆ‘ä»¬å¯ä»¥ä½¿ç”¨ updateMany æ–¹æ³•æ›´æ–°å¤šä¸ªæ–‡æ¡£
// ä¸¾ä¸€åä¸‰,æˆ‘ä»¬ä¹Ÿå¯ä»¥çŸ¥é“æ›´æ–°ä¸€ä¸ªæ–‡æ¡£çš„æ–¹æ³•ä¸º updateOne
// è¯¥å‡½æ•°çš„ç¬¬ä¸€ä¸ªå‚æ•°ä¸ºæŸ¥è¯¢æ¡ä»¶,å› ä¸ºæˆ‘ä»¬éœ€è¦å‘Šè¯‰æ•°æ®åº“è¦æ›´æ–°å“ªäº›æ–‡æ¡£.
// ç¬¬äºŒä¸ªå‚æ•°ä¸ºå¦‚ä½•è®¾ç½®å€¼
// ç¬¬ä¸‰ä¸ªå‚æ•°ä¸ºå¯é€‰å‚æ•°,å…¶ä¸­å¯ä»¥é’ˆå¯¹ä¸€äº›ç‰¹æ®Šåœºæ™¯è¿›è¡Œé…ç½®,æ¯”å¦‚è¯´,å½“æ–‡æ¡£ä¸å­˜åœ¨çš„æ—¶å€™å°±æ–°å¢,
// è¿™é‡Œæˆ‘ä»¬å°±é‡åˆ°äº†ä¸€ä¸ª $set æ“ä½œç¬¦
db.getCollection("crud").updateMany({
    'index': 0
}, {
    $set: {
        'name': 'æå››'
    }
});
// ä¸ºäº†ä½“ç°æŸ¥è¯¢æ“ä½œç¬¦,æ‰€ä»¥æˆ‘è¿™é‡Œå†å†™å¦ä¸€ç§å†™æ³•
db.getCollection("crud").updateMany({
    'index': {
        $eq: 0
    }
}, {
    $set: {
        'name': 'æå››'
    }
});
```

- æ¥ä¸‹æ¥æ˜¯åˆ é™¤æ“ä½œ.
- è¿™é‡Œä¸¾ä¾‹,åˆ é™¤ index ä¸º 1-10 çš„æ‰€æœ‰æ–‡æ¡£

```JavaScript
// ä¸¾ä¸€åä¸‰,åŒæ ·åˆ é™¤å•ä¸ªæ–‡æ¡£çš„æ“ä½œä¸º deleteOne
// 1-10å…¶å®å°±æ˜¯å°äºç­‰äº10å¤§äº0çš„æ‰€æœ‰æ•°æ®,äºæ˜¯æ¡ä»¶å¯ä»¥è¿™ä¹ˆå†™
db.getCollection("crud").deleteMany({
    'index': {
        $lte: 10,
        $gt: 0
    }
});
```

- å†ä¸¾ä¸ªæ —å­,åˆ é™¤ index åœ¨æ•°ç»„ [ 11, 13, 15, 49, 38, 25, 90, 99 ] ä¸­çš„æ–‡æ¡£.

```JavaScript
db.getCollection("crud").deleteMany({
    'index': {
        $in: [ 11, 13, 15, 49, 38, 25, 90, 99 ]
    }
});
```

- æŸ¥è¯¢çš„è¯å…¶å®æˆ‘ä»¬å·²ç»ä¸ç”¨è®²äº†,åªéœ€è¦çŸ¥é“æŸ¥è¯¢çš„å‡½æ•°ä¸º find,å› ä¸ºå‰è¾¹çš„æ›´æ–°å’Œåˆ é™¤å‡½æ•°ä¸­çš„æŸ¥è¯¢æ¡ä»¶,å…¶å®å’Œ find çš„å‚æ•°è¦æ±‚ä¸€æ ·çš„.
- è¿™é‡Œè¿˜æ˜¯ä¸¾ä¸ªä¾‹å­.

```JavaScript
// æŸ¥è¯¢æ‰€æœ‰æ•°æ®
db.getCollection("crud").find();
db.getCollection("crud").find({});
// è¿™ä¸¤ç§å†™æ³•ç­‰æ•ˆçš„.
// æŸ¥è¯¢ageå¤§äº20çš„æ–‡æ¡£
db.getCollection("crud").find({
    'age': {
        $gt: 20
    }
});
// æŸ¥è¯¢ageç­‰äº20çš„æ–‡æ¡£,å¹¶ä¸”nameä¸ºæå››çš„æ–‡æ¡£
db.getCollection("crud").find({
    'age': 20,
    'name': 'æå››'
});
```

- è‡³æ­¤,å¸¸è§„çš„ä½¿ç”¨ Navicat è¿›è¡Œ MongoDB çš„ CRUD å°±åŸºæœ¬è®²å®Œäº†.æœ‰ä»€ä¹ˆé—®é¢˜å¯ä»¥æé—®ç§ä¿¡æˆ–è€…ç•™è¨€ç»™æˆ‘.

---

## C#å’Œ.NET 7 å¦‚ä½•ä½¿ç”¨å‘¢?(ä» 0 å¼€å§‹)

- æ—¢ç„¶æ˜¯ä» 0 å¼€å§‹,é‚£ä¹ˆæˆ‘ä»¬å°±çœŸä» 0 å¼€å§‹.
- ä¸ä½¿ç”¨æˆ‘å°è£…è¿‡çš„ MongoDB é©±åŠ¨,å½“ç„¶æƒ³äº†è§£çš„å¯ä»¥å»[çœ‹çœ‹æºç ](https://github.com/EasilyNET/EasilyNET)
- é¦–å…ˆæˆ‘ä»¬ä½¿ç”¨ VS åˆ›å»ºä¸€ä¸ªç©ºç™½çš„ WebApi é¡¹ç›®.å¹¶ä¸”æ·»åŠ  MongoDB.Driver Nuget åŒ…
- ç„¶ååˆ›å»ºä¸€ä¸ª BaseDbContext.cs ç”¨æ¥ä½œä¸º DBContext çš„åŸºç±»,å…¶ä»£ç å¦‚ä¸‹:

```csharp
public class BaseDbContext
{
    /// <summary>
    /// MongoClient
    /// </summary>
    public IMongoClient Client { get; private set; } = default!;
    /// <summary>
    /// è·å–é“¾æ¥å­—ç¬¦ä¸²æˆ–è€…HoyoMongoSettingsä¸­é…ç½®çš„ç‰¹å®šåç§°æ•°æ®åº“æˆ–é»˜è®¤æ•°æ®åº“hoyo
    /// </summary>
    public IMongoDatabase Database { get; private set; } = default!;

    /// <summary>
    ///  ä½¿ç”¨é“¾æ¥å­—ç¬¦ä¸²åˆ›å»ºå®¢æˆ·ç«¯,å¹¶æä¾›å­—ç¬¦ä¸²ä¸­çš„æ•°æ®åº“
    /// </summary>
    /// <typeparam name="T"></typeparam>
    /// <param name="connStr">é“¾æ¥å­—ç¬¦ä¸²</param>
    /// <param name="db">æ•°æ®åº“åç§°</param>
    /// <returns></returns>
    internal static T CreateInstance<T>(string connStr, string db = "hoyo") where T : BaseDbContext
    {
        var t = Activator.CreateInstance<T>();
        var mongoUrl = new MongoUrl(connStr);
        var clientSettings = MongoClientSettings.FromUrl(mongoUrl);
        t.Client = new MongoClient(clientSettings);
        var dbName = !string.IsNullOrWhiteSpace(mongoUrl.DatabaseName) ? mongoUrl.DatabaseName : db;
        t.Database = t.Client.GetDatabase(dbName);
        return t;
    }
}
```

- å†åˆ›å»ºä¸€ä¸ª MongoExtension.cs æ–¹ä¾¿æˆ‘ä»¬æ³¨å†ŒæœåŠ¡å’Œé…ç½® Mongodb çš„ä¸€äº›è¡Œä¸º.ä»£ç å¦‚ä¸‹.

```csharp
public static class MongoExtension
{
    /// <summary>
    /// é€šè¿‡è¿æ¥å­—ç¬¦ä¸²æ·»åŠ DbContext
    /// </summary>
    /// <typeparam name="T">Hoyo.Mongo.DbContext</typeparam>
    /// <param name="services">IServiceCollection</param>
    /// <param name="connStr">é“¾æ¥å­—ç¬¦ä¸²</param>
    /// <returns></returns>
    // ReSharper disable once MemberCanBePrivate.Global
    public static IServiceCollection AddMongoDbContext<T>(this IServiceCollection services, string connStr) where T : BaseDbContext
    {
        RegistryConventionPack();
        var db = BaseDbContext.CreateInstance<T>(connStr);
        _ = services.AddSingleton(db).AddSingleton(db.Database).AddSingleton(db.Client);
        return services;
    }
    /// <summary>
    /// æ³¨å†ŒPack
    /// </summary>
    private static void RegistryConventionPack(bool first = true)
    {
        if (first)
        {
            var pack = new ConventionPack
            {
                new CamelCaseElementNameConvention(),// é©¼å³°å‘½åå­—æ®µ
                new IgnoreExtraElementsConvention(true),
                new NamedIdMemberConvention("Id","ID"),// å°†_idå­—æ®µæ˜ å°„ä¸ºIdæˆ–è€…ID
                new EnumRepresentationConvention(BsonType.String),// å°†æšä¸¾ç±»å‹å­˜å‚¨ä¸ºå­—ç¬¦ä¸²å€¼
            };
            ConventionRegistry.Register($"hoyo-pack-{Guid.NewGuid()}", pack, _ => true);
            BsonSerializer.RegisterSerializer(new DateTimeSerializer(DateTimeKind.Local));// å°†æ—¶é—´è½¬åŒ–ä¸ºæœ¬åœ°æ—¶é—´
            BsonSerializer.RegisterSerializer(new DecimalSerializer(BsonType.Decimal128));
            BsonSerializer.RegisterSerializer(new DateOnlySerializer());
        }
        var idpack = new ConventionPack
        {
            new StringObjectIdIdGeneratorConvention()//Id[string] mapping ObjectId
        };
        ConventionRegistry.Register($"id-pack{Guid.NewGuid()}", idpack, _ => true);
    }
}
/// <summary>
/// map the [BsonRepresentation(MongoDB.Bson.BsonType.ObjectId]
/// </summary>
internal class StringObjectIdIdGeneratorConvention : ConventionBase, IPostProcessingConvention
{
    public void PostProcess(BsonClassMap classMap)
    {
        var idMemberMap = classMap.IdMemberMap;
        if (idMemberMap is null || idMemberMap.IdGenerator is not null) return;
        if (idMemberMap.MemberType == typeof(string)) _ = idMemberMap.SetIdGenerator(StringObjectIdGenerator.Instance).SetSerializer(new StringSerializer(BsonType.ObjectId));
    }
}
```

- ç”±äºä¸Šè¾¹ä¸´æ—¶å†³å®šæ·»åŠ ä¸€ä¸ª DateOnly ç±»å‹,è€Œ Mongo ä¸æ”¯æŒè¿™ç§æ–°ç±»å‹,æ‰€ä»¥æˆ‘ä»¬éœ€è¦è‡ªå·±å®ç°ä»–çš„åºåˆ—åŒ–æ–¹å¼.æ‰€ä»¥è¿™é‡ŒåŠ è¿›æ¥ä¹Ÿæ˜¯ä¸ºäº†æ•™å¤§å®¶å¦‚ä½•å»åšç±»ä¼¼çš„äº‹æƒ…,æ¯”å¦‚ TimeOnly,ä»¥åŠä»–ä»¬å¯¹åº”çš„å¯ç©ºç±»å‹.

```csharp
/// <summary>
/// DateOnlyåºåˆ—åŒ–æ–¹å¼
/// </summary>
internal sealed class DateOnlySerializer : StructSerializerBase<DateOnly>
{
    public override void Serialize(BsonSerializationContext context, BsonSerializationArgs args, DateOnly value)
    {
        var str = value.ToString("yyyy-MM-dd");
        context.Writer.WriteString(str);
    }

    public override DateOnly Deserialize(BsonDeserializationContext context, BsonDeserializationArgs args)
    {
        var str = context.Reader.ReadString();
        var success = DateOnly.TryParse(str, out var result);
        return success ? result : throw new("ä¸å—æ”¯æŒçš„æ•°æ®æ ¼å¼.");
    }
}
```

- åŸºç¡€çš„äº‹æƒ…åšå¥½äº†å,å°±åˆ›å»ºå‰è¾¹ç”¨åˆ°çš„æ•°æ®ç±»å‹çš„å®ä½“. Person.cs ,åŒæ—¶å†æ€§åˆ«è¿™ä¸ªå­—æ®µä½¿ç”¨æšä¸¾ç±»å‹,æ¥ä½“ç° MongoDB å°†æšä¸¾è½¬åŒ–æˆå­—ç¬¦ä¸²æ ¼å¼å­˜å‚¨çš„èƒ½åŠ›.

```csharp
public class Person
{
    /// <summary>
    /// æ•°æ®ID
    /// </summary>
    public string Id { get; set; } = string.Empty;
    /// <summary>
    /// å’Œä¾‹å­ä¸­çš„æ•°æ®ç»“æ„åŒæ­¥
    /// </summary>
    public int Index { get; set; }
    /// <summary>
    /// Name
    /// </summary>
    public string Name { get; set; } = string.Empty;
    /// <summary>
    /// å¹´é¾„
    /// </summary>
    public int Age { get; set; }
    /// <summary>
    /// æ€§åˆ«
    /// </summary>
    public Gender Gender { get; set; } = Gender.ç”·;
    /// <summary>
    /// ä¸´æ—¶å†³å®š,ä½¿ç”¨.Net 6æ–°å¢ç±»å‹ä¿å­˜ç”Ÿæ—¥,åŒæ—¶è®©ä¾‹å­å˜å¾—ä¸°å¯Œ,æ˜ç™½å¦‚ä½•å°†MongoDBä¸æ”¯æŒçš„æ•°æ®ç±»å‹åºåˆ—åŒ–
    /// </summary>
    public DateOnly Birthday { get; set; }
}

public enum Gender
{
    ç”·,
    å¥³
}
```

- è¿™äº›å†…å®¹åˆ›å»ºå¥½å,æˆ‘ä»¬ç´§æ¥ç€åˆ›å»ºæˆ‘ä»¬å®é™…ä½¿ç”¨çš„ DbContext.cs ç”¨æ¥ç®¡ç†æˆ‘ä»¬ä¸šåŠ¡ä¸­ä½¿ç”¨çš„é›†åˆ.

```csharp
public sealed class DbContext : BaseDbContext
{
    /// <summary>
    ///
    /// </summary>
    public IMongoCollection<Person> Person => Database.GetCollection<Person>("person");
}
```

- æ¥ä¸‹æ¥å†å» Programe.cs ä¸­æ³¨å…¥æœåŠ¡å³å¯é€šè¿‡ä¾èµ–æ³¨å…¥æ¥ä½¿ç”¨æˆ‘ä»¬çš„ DbContext äº†.è¿™é‡Œè´´ä¸Šå®Œæ•´ä»£ç ,ä¾¿äºè§‚å¯Ÿ.

```csharp
var builder = WebApplication.CreateBuilder(args);
// Add services to the container.
builder.Services.AddControllers();
// Learn more about configuring Swagger/OpenAPI at https://aka.ms/aspnetcore/swashbuckle
builder.Services.AddEndpointsApiExplorer();
builder.Services.AddSwaggerGen();

#region MongoDBæœåŠ¡æ³¨å…¥
var dbStr = builder.Configuration.GetConnectionString("Mongo");
builder.Services.AddMongoDbContext<DbContext>(dbStr!);
#endregion

var app = builder.Build();
// Configure the HTTP request pipeline.
if (app.Environment.IsDevelopment())
{
    _ = app.UseSwagger().UseSwaggerUI();
}
app.UseAuthorization();
app.MapControllers();
app.Run();
```

- æ¥ä¸‹æ¥æˆ‘ä»¬å°±æ­£å¼ä½¿ç”¨ C#æ“ä½œ MongoDB äº†.
- é¦–å…ˆå…ˆåˆ é™¤æ¨¡æ¿é¡¹ç›®çš„ WeatherForecast.cs åŠå¯¹ WeatherForecast æ§åˆ¶å™¨æ”¹ä¸ªå.æ¯•ç«Ÿæˆ‘ä»¬ä¸éœ€è¦çœ‹å¤©æ°” ğŸ˜.
- æˆ‘è¿™é‡Œå°†åç§°æ”¹ä¸ºäº† MongoCrudController.cs,é€šè¿‡è°ƒæ•´ä¸ºå¦‚ä¸‹å†…å®¹.

```csharp
[ApiController, Route("[controller]")]
public class MongoCrudController : ControllerBase
{
    private readonly DbContext _db;
    public MongoCrudController(DbContext db)
    {
        _db = db;
    }
}
```

- å®³,ç»ˆäºå®Œæˆäº†ç¬¦åˆæˆ‘é£æ ¼çš„åŸºæœ¬é…ç½®.ç°åœ¨å¯ä»¥å¼€å§‹æ­£å¼å†™ Crud çš„ä»£ç äº†.

```csharp
[ApiController, Route("[controller]")]
public class MongoCrudController : ControllerBase
{
    private readonly DbContext _db;
    public MongoCrudController(DbContext db)
    {
        _db = db;
    }

    private readonly FilterDefinitionBuilder<Person> _bf = Builders<Person>.Filter;
    private readonly UpdateDefinitionBuilder<Person> _bu = Builders<Person>.Update;

    [HttpPost("one")]
    public async Task<Person> InsertOne()
    {
        // è¿™é‡Œæˆ‘ä»¬ä¸éœ€è¦ä¸º Id å­—æ®µèµ‹å€¼,å› ä¸ºæ’å…¥æˆåŠŸå,ä¼šè‡ªåŠ¨ä¸ºIdå­—æ®µç»‘å®šå€¼.
        var person = new Person
        {
            Name = "å¼ ä¸‰",
            Age = 20,
            Birthday = DateOnly.FromDateTime(DateTime.Now),
            Gender = Gender.å¥³,
            Index = 0
        };
        await _db.Person.InsertOneAsync(person);
        Console.WriteLine(person.Id);
        return person;
    }

    [HttpPost("many")]
    public async Task<IEnumerable<Person>> InsertMany()
    {
        var list = new List<Person>();
        for (var i = 0; i < 100; i++)
        {
            list.Add(new()
            {
                Name = "å¼ ä¸‰",
                Age = 20 + i,
                Birthday = DateOnly.FromDateTime(DateTime.Now),
                Gender = i % 2 == 0 ? Gender.å¥³ : Gender.ç”·,
                Index = i
            });
        }
        await _db.Person.InsertManyAsync(list);
        return list;
    }

    [HttpGet("all")]
    public async Task<IEnumerable<Person>> FindAll()
    {
        // return await _db.Person.Find("{}").ToListAsync();
        // ä¸¤ç§å†™æ³•ç­‰æ•ˆ,ä½†æ˜¯å¹¶ä¸å»ºè®®åœ¨C#ä¸­ç›´æ¥å†™JSONå­—ç¬¦ä¸²æŸ¥è¯¢,é™¤éä¸€äº›ç‰¹æ®Šæƒ…å†µ.
        return await _db.Person.Find(_bf.Empty).ToListAsync();
    }

    [HttpGet("IndexIs0")]
    public async Task<IEnumerable<Person>> FindIndexIs0()
    {
        return await _db.Person.Find(_bf.Eq(c => c.Index, 0)).ToListAsync();
    }

    [HttpPut("one/{index:int}")]
    public async Task UpdateOne(int index)
    {
        // å±•ç¤ºæ‹‰å§†è¾¾è¡¨è¾¾å¼çš„æ¡ä»¶æ–¹å¼,ä»¥åŠç¬¬ä¸‰ä¸ªå¯é€‰å‚æ•°çš„é…ç½®.
        _ = await _db.Person.UpdateOneAsync(c => c.Index == index, _bu.Set(c => c.Age, 17), new() { IsUpsert = true });
    }

    [HttpPut("IndexIs0")]
    public async Task UpdateIndexIs0()
    {
        _ = await _db.Person.UpdateManyAsync(_bf.Eq(c => c.Index, 0), _bu.Set(c => c.Name, "æå››"));
    }

    [HttpDelete("one/{index:int}")]
    public async Task DeleteOne(int index)
    {
        _ = await _db.Person.DeleteOneAsync(c => c.Index == index);
        // ä¸¤ç§å†™æ³•ç­‰æ•ˆ
        //_ = await _db.Person.DeleteOneAsync(_bf.Eq(c => c.Index, index));
    }

    [HttpDelete("many")]
    public async Task DeleteMany()
    {
        var indexs = new[] { 12, 25, 14, 36, 95, 42 };
        _ = await _db.Person.DeleteManyAsync(c => indexs.Contains(c.Index));
        // ä¸¤ç§å†™æ³•ç­‰æ•ˆ.
        //_ = await _db.Person.DeleteManyAsync(_bf.In(c => c.Index, indexs));
    }
}
```

- è‡³æ­¤,åŸºæœ¬ä¸Šå¸¸è§„çš„ CRUD æ“ä½œå°±å·²ç»å®Œæˆ,å¯ä»¥å¯åŠ¨ç¨‹åºåä½¿ç”¨ Swagger è¿›è¡Œæ¥å£æµ‹è¯•.
- åŒæ—¶ä»£ç æˆ‘ä¹Ÿä¼šæ¨é€è‡³ [GitHub](https://github.com/joesdu/MongoCRUD) æœ‰éœ€è¦å‚è€ƒçš„å¯ä»¥çœ‹çœ‹.
- æœ¬æ–‡ä¸­ä½¿ç”¨çš„ MongoDB çš„æ‰©å±•å’Œå°è£…å‡å·²ç»é€šè¿‡æ›´å®Œå–„çš„æ–¹å¼åœ¨åˆ«çš„åº“ä¸­å®ç°.å‰è¾¹å·²ç»æåˆ°è¿‡é“¾æ¥,æ¬¢è¿ä½¿ç”¨.
- æœ‰ä»€ä¹ˆç–‘é—®æˆ–è€…ä¸æ˜ç™½çš„åœ°æ–¹å¯ä»¥ç»™æˆ‘ç•™è¨€.
