## ä¸€æ–‡ç²¾é€š.NET Swagger ä½¿ç”¨

> åœ¨åç«¯å¼€å‘ä¸­,å¸¸ç”¨ Web API æ¨¡å¼,å¯¹å¤–æä¾› RESTful API è®©å‰ç«¯è°ƒç”¨.è€Œå…¶ä¸­æœ€è‘—åçš„å°±æ˜¯ä½¿ç”¨ Swagger(ä¿—ç§°:ä¸è¢œå“¥),Swagger ä¸ä½†æä¾›äº†éå¸¸ç›´è§‚çš„é¡µé¢ä¾›å¼€å‘è€…æŸ¥çœ‹,è¿˜èƒ½é…ç½®æ³¨é‡Šè¯´æ˜,åˆ†ç»„ç­‰,è¿˜å¯ä»¥ç›´æ¥åœ¨æµè§ˆå™¨ä¸Šæµ‹è¯•æ¥å£,å¯ä»¥è¯´æ˜¯,ç°åœ¨ä¸ç”¨ Swagger çš„åç«¯å¼€å‘è€…ä¸æ˜¯ä¸ªå¥½å¼€å‘è€….æœ¬æ–‡å°†é’ˆå¯¹æˆ‘åœ¨æ—¥å¸¸å·¥ä½œä¸­ä½¿ç”¨ Swagger çš„ä¸€äº›æ€»ç»“å’Œä¾‹å­,åŸºæœ¬ä¸Šå±äºå¤åˆ¶ä»£ç å°±èƒ½ç”¨.

- æœ¬æ–‡é»˜è®¤å¤§å®¶éƒ½æœ‰ç‚¹åŸºç¡€,è‡³å°‘ä½¿ç”¨ VS åˆ›å»ºé¡¹ç›®è¿™äº›ä¸ç”¨æˆ‘å†å¤šè¯´.
- æœ¬æ–‡çš„ä¾‹å­ä½¿ç”¨å¾®è½¯é»˜è®¤çš„ Web API æ¨¡æ¿è¿›è¡Œæ„å»º,ä¼šè¯¦ç»†çš„è®²è§£æ¯ä¸€æ­¥.å¹¶ä¸”ä¼šå°†ä»£ç ä¸Šä¼ åˆ° GitHub.
- æœ¬æ–‡ä¼šä»‹ç» Swagger çš„æ³¨é‡Š,æ¥å£åˆ†ç»„,éšè—æ¥å£,ä»¥åŠç»™éœ€è¦é‰´æƒçš„æ¥å£æ·»åŠ æ ‡è¯†.ä»¥åŠå—æ”¯æŒçš„æ•°æ®ç±»å‹çš„é»˜è®¤å€¼æ˜¾ç¤º.
  - æ³¨é‡Šä¸ç”¨è¯´,å°±æ˜¯å°†ä»£ç æ³¨é‡Šæ˜¾ç¤ºåˆ°é¡µé¢ä¸Š.
  - æ¥å£åˆ†ç»„å¯ä»¥å®ç°å°†ä¸åŒåŠŸèƒ½çš„æ§åˆ¶å™¨åˆ†åˆ°ä¸åŒçš„ç»„ä¸­,ä¾¿äºæŸ¥çœ‹.
  - éšè—æ¥å£åˆ™æ˜¯å°†ä¸å¸Œæœ›å¯¹å¤–å…¬å¼€çš„æ¥å£ä¸æ˜¾ç¤º,é‰´æƒæ¥å£æ ‡è¯†åˆ™æ˜¯åœ¨ API çš„åè¾¹æ˜¾ç¤ºä¸€ä¸ª ğŸ”’ é”å›¾æ ‡.
  - æ˜¾ç¤ºé»˜è®¤å€¼åˆ™æ˜¯åœ¨æŸäº›æ•°æ®ä¸­,æ¯”å¦‚ç”¨æˆ·å¹´é¾„,é»˜è®¤æ˜¾ç¤º 20,å‰ç«¯ä¸€çœ‹å°±çŸ¥é“è¿™æ˜¯ä¸ªä»€ä¹ˆæ•°æ®ç±»å‹,å½“ç„¶è¿™é‡Œçš„ä¾‹å­ä¸å¤ªæ°å½“,åæ­£æ„æ€å·®ä¸å¤š.
- æœ€ç»ˆå‘ˆç°çš„æ•ˆæœå¤§æ¦‚å°±æ˜¯å¦‚ä¸‹,æ¥ä¸‹æ¥å°±å¼€å§‹ä½¿ç”¨ä»£ç è¯´æ˜è¿™ä¸€åˆ‡.

![image](./images/webapidemo.png)

- é¦–å…ˆä½¿ç”¨ VS åˆ›å»ºä¸€ä¸ª Web API é¡¹ç›®,è¿™é‡Œæˆ‘å«ä»– Swagger.Sample,ä½ ä¹Ÿå¯ä»¥å«ä»–å…¶ä»–åå­—,éšä½ è‡ªå·±.
- é»˜è®¤çš„ AddSwaggerGen é…ç½®ä»£ç é‡Œä»€ä¹ˆéƒ½æ²¡æœ‰,æ‰€ä»¥æ²¡æœ‰ä»€ä¹ˆç‰¹æ®Šçš„æ•ˆæœ.ä»…ä»…åªèƒ½æŸ¥çœ‹æ¥å£å’Œè°ƒè¯•è€Œå·².

```csharp
var builder = WebApplication.CreateBuilder(args);

// Add services to the container.
builder.Services.AddControllers();
// Learn more about configuring Swagger/OpenAPI at https://aka.ms/aspnetcore/swashbuckle
builder.Services.AddEndpointsApiExplorer();
// é…ç½®Swagger
builder.Services.AddSwaggerGen();
var app = builder.Build();

// Configure the HTTP request pipeline.
if (app.Environment.IsDevelopment())
{
    app.UseSwagger();
    app.UseSwaggerUI();
}
app.UseAuthorization();
app.MapControllers();
app.Run();
```

- ç”±äºé»˜è®¤ä»£ç é‡Œæœ‰ä¸ªå¤©æ°”æ•°æ®æ¥å£,æˆ‘ä»¬å¹¶ä¸éœ€è¦,æ‰€ä»¥åˆ æ‰ä»–ä»¬,å¹¶æ·»åŠ å‡ ä¸ª POST,PUT,GET,DELETE ç­‰æ¥å£æ¥åšä¾‹å­,æ‰€æœ‰çš„æ¥å£å‡è¿”å›ä¸€ä¸ªå­—ç¬¦ä¸².å‚æ•°æ ¹æ®ä¸åŒçš„æ¥å£ç±»å‹,ä¼šå£°æ˜ä¸åŒçš„å‚æ•°.ä½†æ˜¯éƒ½ä¸ä¼šå¤ªå¤æ‚,å¤§å®¶è‚¯å®šéƒ½èƒ½æ‡‚.
- å°†é»˜è®¤çš„æ§åˆ¶å™¨æ”¹æˆå¦‚ä¸‹è¿™ä¸ªæ ·å­.

```csharp
using Microsoft.AspNetCore.Mvc;

// ReSharper disable ClassNeverInstantiated.Global

namespace Swagger.Sample.Controllers;

/// <summary>
/// ç¬¬ä¸€ä¸ªæ§åˆ¶å™¨
/// </summary>
[ApiController, Route("[controller]/[action]")]
public class FirstController : ControllerBase
{
    /// <summary>
    /// Hello {name}
    /// </summary>
    /// <param name="name"></param>
    /// <returns></returns>
    [HttpGet]
    public string Hello(string name) => $"Hello {name}";

    /// <summary>
    /// Hello World
    /// </summary>
    /// <returns></returns>
    [HttpGet]
    public string HelloWorld() => "Hello World";

    /// <summary>
    /// PostOne
    /// </summary>
    /// <param name="parameter"></param>
    /// <returns></returns>
    [HttpPost]
    public PostParameter PostOne(PostParameter parameter) => parameter;

    /// <summary>
    /// PutOne
    /// </summary>
    /// <param name="id"></param>
    /// <param name="put"></param>
    /// <returns></returns>
    [HttpPut("{id}")]
    public string PutOne(string id, PutParameter put) => $"update:{id},{put.Gender}";

    /// <summary>
    /// DeleteOne
    /// </summary>
    /// <param name="id"></param>
    /// <returns></returns>
    [HttpDelete("{id}")]
    public string DeleteOne(string id) => $"delete {id}";
}

/// <summary>
/// Putå‚æ•°æ¨¡æ‹Ÿ
/// </summary>
public class PutParameter
{
    /// <summary>
    /// Gender
    /// </summary>
    public EGender Gender { get; set; }
}

/// <summary>
/// POSTå‚æ•°æ¨¡æ‹Ÿ
/// </summary>
public class PostParameter : PutParameter
{
    /// <summary>
    /// Name
    /// </summary>
    public string Name { get; set; } = string.Empty;

    /// <summary>
    /// Age
    /// </summary>
    public int Age { get; set; }
}

/// <summary>
/// æ€§åˆ«æšä¸¾
/// </summary>
public enum EGender
{
    /// <summary>
    /// ç”·
    /// </summary>
    ç”·,

    /// <summary>
    /// å¥³
    /// </summary>
    å¥³
}
```

- ä¸Šè¾¹æäº†å‡ ä¸ªä¾‹å­.å¯åŠ¨åä¼šå‘ç°æŒ‰ç…§é¢„æœŸæ˜¾ç¤ºé¡µé¢.ä½†æ˜¯æ²¡æœ‰æ³¨é‡Šä¹Ÿæ²¡æœ‰ä¸Šè¿°åˆ«çš„åŠŸèƒ½.

### æ·»åŠ æ–‡æ¡£æ³¨é‡Š

- è¦è®© Swagger æ˜¾ç¤ºæ–‡æ¡£æ³¨é‡Š,é¦–å…ˆè¦å¯¹é¡¹ç›®æ·»åŠ  XML æ–‡æ¡£ç”Ÿæˆ.
- æ‰“å¼€é¡¹ç›®çš„ xxx.csproj æˆ‘è¿™é‡Œæ˜¯ Swagger.Sample.csproj,åœ¨ PropertyGroup èŠ‚ç‚¹ä¸‹æ·»åŠ  GenerateDocumentationFile ä¸º Trune å¦‚ä¸‹å†…å®¹:

```xml
  <PropertyGroup>
    <GenerateDocumentationFile>True</GenerateDocumentationFile>
  </PropertyGroup>
```

- è¿™æ—¶å€™å¯åŠ¨é¡¹ç›®,è™½ç„¶ä¼šç”Ÿæˆç›¸åº”çš„æ–‡ä»¶,ä½†æ˜¯ Swagger è¿˜æ˜¯æ— æ³•æ­£å¸¸æ˜¾ç¤ºæ³¨é‡Š,å…¶åŸå› å°±æ˜¯å°šæœªå¯¹ Swaager è¿›è¡Œé…ç½®,è¿™é‡Œæˆ‘ä»¬å…ˆæ¥æ·»åŠ æ–‡æ¡£æ³¨é‡Šæ˜¾ç¤º.
- æ‰“å¼€ Program.cs æ–‡ä»¶.è‹¥æ˜¯è¿›è¡Œè¿‡å°è£…,å¯èƒ½ä¼šæ˜¯å…¶ä»–æ–‡ä»¶,è¿™é‡Œä¸åšæ¢è®¨,æˆ‘ä»¬å…¨éƒ¨éƒ½åœ¨ Program.cs ä¸­è¿›è¡Œ.
- æˆ‘ä»¬å°†ä»£ç æ”¹æˆå¦‚ä¸‹å½¢å¼

```csharp
var builder = WebApplication.CreateBuilder(args);

// Add services to the container.
builder.Services.AddControllers();
// Learn more about configuring Swagger/OpenAPI at https://aka.ms/aspnetcore/swashbuckle
builder.Services.AddEndpointsApiExplorer();
// é…ç½®Swagger
builder.Services.AddSwaggerGen(c =>
{
    // å¡«å†™æ–‡æ¡£çš„ä¸€äº›å±æ€§,åç§°,ç‰ˆæœ¬å’Œæè¿°ä¿¡æ¯
    c.SwaggerDoc("Swagger.Sample", new()
    {
        Title = "Swagger.Sample",
        Version = "v1",
        Description = "Console.WriteLine(\"ğŸ‚ğŸº\")"
    });
    // æ‰¾åˆ°ç¨‹åºè¿è¡Œç›®å½•ä¸‹çš„æ‰€æœ‰xmlæ–‡ä»¶
    var files = Directory.GetFiles(AppContext.BaseDirectory, "*.xml");
    foreach (var file in files)
    {
        // é…ç½®æ³¨é‡Šæ–‡æ¡£
        c.IncludeXmlComments(file, true);
    }
});
var app = builder.Build();

// Configure the HTTP request pipeline.
if (app.Environment.IsDevelopment())
{
    app.UseSwagger();
    app.UseSwaggerUI(c => c.SwaggerEndpoint("/swagger/Swagger.Sample/swagger.json", "Swagger.Sample v1"));
}
app.UseAuthorization();
app.MapControllers();
app.Run();
```

- å¯è§æˆ‘ä»¬åœ¨ AddSwaggerGen å’Œ UseSwaggerUI ä¸­éƒ½æ·»åŠ äº†ä¸€äº›é…ç½®,è®© Swagger å¯ä»¥æ‰¾åˆ°å¯¹åº”çš„ XML æ³¨é‡Šæ–‡ä»¶,è¿™æ—¶å€™å†é‡æ–°è¿è¡Œç¨‹åº,å³å¯çœ‹åˆ°æ³¨é‡Šäº†.
- è¿™é‡Œçš„é…ç½®æˆ‘ä»¬å¯ä»¥çœ‹åˆ°,ä¸ç®¡æ˜¯æ–‡æ¡£çš„åç§°è¿˜æ˜¯ swagger.json æ–‡ä»¶è·¯å¾„å‡æ˜¯ç¡¬ç¼–ç çš„,è¿™æ–¹é¢åè¾¹çš„è°ƒæ•´ä¸­ä¼šé€æ­¥è°ƒæ•´,è¿™é‡Œå…ˆä¸ç”¨åœ¨æ„.

![æ•ˆæœå›¾](./images/adddocxml.png)

- åˆ°è¿™é‡Œæ³¨é‡Šå°±åŸºæœ¬æ·»åŠ å®Œæˆ,åŸç†ä¹Ÿæ‡‚äº†.

### æ–‡æ¡£åˆ†ç»„

- æ–‡æ¡£åˆ†ç»„æˆ‘è¿™é‡Œä½¿ç”¨äº†ä¸€äº›ç‰¹æ€§,é…åˆåå°„æ¥è·å–åˆ†ç»„ä¿¡æ¯.æ‰€ä»¥æˆ‘ä»¬éœ€è¦å…ˆåˆ›å»ºä¸€ä¸ªå·¥å…·ç±»æ¥å¸®åŠ©æˆ‘ä»¬æ–¹ä¾¿ä½¿ç”¨åå°„.
- åˆ›å»ºä¸€ä¸ª Tool æ–‡ä»¶å¤¹,ç”¨æ¥æ”¾ä¸€äº›æ‰©å±•ç±».å¹¶æ–°å»ºæˆ‘ä»¬çš„ç¬¬ä¸€ä¸ª(è¿™ä¸ªä¾‹å­é‡Œåº”è¯¥ä¹Ÿæ˜¯æœ€åä¸€ä¸ª)æ‰©å±•ç±» AssemblyHelper.cs,å¹¶æ·»åŠ å¦‚ä¸‹ä»£ç :

```csharp
using Microsoft.Extensions.DependencyModel;
using System.Reflection;
using System.Runtime.Loader;

namespace Swagger.Sample.Tools;

/// <summary>
/// ç¨‹åºé›†å¸®åŠ©ç±»
/// </summary>
// ReSharper disable once UnusedType.Global
public static class AssemblyHelper
{
    private static readonly string[] Filters = { "dotnet-", "Microsoft.", "mscorlib", "netstandard", "System", "Windows" };
    private static readonly IEnumerable<Assembly>? _allAssemblies;
    private static readonly IEnumerable<Type>? _allTypes;

    /// <summary>
    /// éœ€è¦æ’é™¤çš„é¡¹ç›®
    /// </summary>
    private static readonly List<string> FilterLibs = new();

    /// <summary>
    /// æ„é€ å‡½æ•°
    /// </summary>
    static AssemblyHelper()
    {
        _allAssemblies = DependencyContext.Default?.GetDefaultAssemblyNames().Where(c => c.Name is not null && !Filters.Any(c.Name.StartsWith) && !FilterLibs.Any(c.Name.StartsWith)).Select(Assembly.Load);
        _allTypes = _allAssemblies?.SelectMany(c => c.GetTypes());
    }

    /// <summary>
    /// æ·»åŠ æ’é™¤é¡¹ç›®,è¯¥æ’é™¤é¡¹ç›®å¯èƒ½ä¼šå½±å“AutoDependenceInjectionè‡ªåŠ¨æ³¨å…¥,è¯·ä½¿ç”¨çš„æ—¶å€™è‡ªè¡Œæµ‹è¯•.
    /// </summary>
    /// <param name="names"></param>
    public static void AddExcludeLibs(params string[] names) => FilterLibs.AddRangeIfNotContains(names);

    /// <summary>
    /// æ ¹æ®ç¨‹åºé›†åå­—å¾—åˆ°ç¨‹åºé›†
    /// </summary>
    /// <param name="assemblyNames"></param>
    /// <returns></returns>
    public static IEnumerable<Assembly> GetAssembliesByName(params string[] assemblyNames) => assemblyNames.Select(o => AssemblyLoadContext.Default.LoadFromAssemblyPath(Path.Combine(AppContext.BaseDirectory, $"{o}.dll")));

    /// <summary>
    /// æŸ¥æ‰¾æŒ‡å®šæ¡ä»¶çš„ç±»å‹
    /// </summary>
    public static IEnumerable<Type> FindTypes(Func<Type, bool> predicate) => _allTypes!.Where(predicate).ToArray();

    /// <summary>
    /// æŸ¥æ‰¾æ‰€æœ‰æŒ‡å®šç‰¹æ€§æ ‡è®°çš„ç±»å‹
    /// </summary>
    /// <typeparam name="TAttribute"></typeparam>
    /// <returns></returns>
    public static IEnumerable<Type> FindTypesByAttribute<TAttribute>() where TAttribute : Attribute => FindTypesByAttribute(typeof(TAttribute));

    /// <summary>
    /// æŸ¥æ‰¾æ‰€æœ‰æŒ‡å®šç‰¹æ€§æ ‡è®°çš„ç±»å‹
    /// </summary>
    /// <param name="type"></param>
    /// <returns></returns>
    public static IEnumerable<Type> FindTypesByAttribute(Type type) => _allTypes!.Where(a => a.IsDefined(type, true)).Distinct().ToArray();

    /// <summary>
    /// æŸ¥æ‰¾æŒ‡å®šæ¡ä»¶çš„ç±»å‹
    /// </summary>
    public static IEnumerable<Assembly> FindAllItems(Func<Assembly, bool> predicate) => _allAssemblies!.Where(predicate).ToArray();

    /// <summary>
    /// æ·»åŠ ä¸é‡å¤çš„å…ƒç´ 
    /// </summary>
    /// <typeparam name="T"></typeparam>
    /// <param name="this"></param>
    /// <param name="values"></param>
    private static void AddRangeIfNotContains<T>(this ICollection<T> @this, params T[] values)
    {
        foreach (var obj in values)
        {
            if (@this.Contains(obj)) continue;
            @this.Add(obj);
        }
    }
}
```

- å†™å¥½å¸®åŠ©ç±»å,å³å¯æ–°å»ºä¸€ä¸ªç‰¹æ€§ç”¨æ¥æ‰¿è½½æˆ‘ä»¬çš„åˆ†ç»„ä¿¡æ¯.
- æ–°å»ºä¸€ä¸ªæ–‡ä»¶å¤¹ Attributes å¹¶æ·»åŠ  ApiGroupAttribute.cs,å¹¶å†™å…¥å¦‚ä¸‹ä»£ç :

```csharp
namespace Swagger.Sample.Attributes;

/// <summary>
/// è¢«æ­¤ç‰¹æ€§æ ‡è®°çš„æ§åˆ¶å™¨å¯åœ¨Swaggeræ–‡æ¡£åˆ†ç»„ä¸­å‘æŒ¥ä½œç”¨.
/// </summary>
[AttributeUsage(AttributeTargets.Class)]
// ReSharper disable once UnusedMember.Global
// ReSharper disable once UnusedType.Global
// ReSharper disable once ClassNeverInstantiated.Global
public sealed class ApiGroupAttribute : Attribute
{
    /// <summary>
    /// æ„é€ å‡½æ•°
    /// </summary>
    /// <param name="title"></param>
    /// <param name="version"></param>
    /// <param name="description"></param>
    public ApiGroupAttribute(string title, string version, string description = "")
    {
        Title = title;
        Version = version;
        Description = description;
        Name = $"{title}-{version}";
    }

    /// <summary>
    /// Docåç§°,$"{Title}-{Version}"æ ¼å¼
    /// </summary>
    public string Name { get; }

    /// <summary>
    /// æ ‡é¢˜
    /// </summary>
    public string Title { get; }

    /// <summary>
    /// ç‰ˆæœ¬
    /// </summary>
    public string Version { get; }

    /// <summary>
    /// æè¿°
    /// </summary>
    public string Description { get; }
}
```

- å…¶ä¸­å„ä¸ªå­—æ®µçš„å«ä¹‰,å‡æœ‰æ³¨é‡Š.æ–¹ä¾¿ç†è§£.è¿™ä¸ªæ—¶å€™æˆ‘ä»¬å‡†å¤‡å·¥ä½œå°±åšå¥½äº†,å¯ä»¥å¼€å§‹æ”¹é€  Programe.cs ä¸­çš„é…ç½®äº†.
- é¦–å…ˆåˆ›å»ºå‡ ä¸ªå±€éƒ¨å˜é‡,ç”¨æ¥å­˜å‚¨ä¸€äº›ä¿¡æ¯.

```csharp
// æ–‡æ¡£æ ‡é¢˜
const string Title = "Test";                    // æ–‡æ¡£æ ‡é¢˜
const string Version = "v1";                    // ç‰ˆæœ¬
const string Name = $"{Title}-{Version}";       // æ–‡æ¡£åç§°
Dictionary<string, string> docsDic = new();     // ç”¨æ¥å­˜å‚¨æ–‡æ¡£åˆ†ç»„çš„ä¿¡æ¯
Dictionary<string, string> endPointDic = new(); // å­˜å‚¨æ–‡æ¡£ç»ˆç»“ç‚¹jsonä¿¡æ¯
```

- ç„¶åä¿®æ”¹ AddSwaggerGen å’Œ UseSwaggerUI ä¸ºå¦‚ä¸‹å†…å®¹:
- ä¸ºäº†æ–¹ä¾¿,åæœŸå‡ä¼šå±•ç¤ºå®Œæ•´çš„ Programe.cs ä»£ç 

```csharp
using Swagger.Sample.Attributes;
using Swagger.Sample.Tools;
using System.Reflection;

var builder = WebApplication.CreateBuilder(args);

// Add services to the container.
builder.Services.AddControllers();
// Learn more about configuring Swagger/OpenAPI at https://aka.ms/aspnetcore/swashbuckle
builder.Services.AddEndpointsApiExplorer();

// é…ç½®Swagger
const string Title = "Test";                    // æ–‡æ¡£æ ‡é¢˜
const string Version = "v1";                    // ç‰ˆæœ¬
const string Name = $"{Title}-{Version}";       // æ–‡æ¡£åç§°
Dictionary<string, string> docsDic = new();     // ç”¨æ¥å­˜å‚¨æ–‡æ¡£åˆ†ç»„çš„ä¿¡æ¯
Dictionary<string, string> endPointDic = new(); // å­˜å‚¨æ–‡æ¡£ç»ˆç»“ç‚¹jsonä¿¡æ¯
builder.Services.AddSwaggerGen(c =>
{
    // é…ç½®é»˜è®¤åˆ†ç»„
    c.SwaggerDoc(Name, new()
    {
        Title = Title,
        Version = Version,
        Description = "Console.WriteLine(\"ğŸ‚ğŸº\")"
    });
    // é…ç½®æ–‡æ¡£æ³¨é‡Š
    var files = Directory.GetFiles(AppContext.BaseDirectory, "*.xml");
    foreach (var file in files)
    {
        c.IncludeXmlComments(file, true);
    }
    // è·å–æ§åˆ¶å™¨åˆ†ç»„ä¿¡æ¯å’Œé…ç½®åˆ†ç»„
    var controllers = AssemblyHelper.FindTypesByAttribute<ApiGroupAttribute>();
    foreach (var ctrl in controllers)
    {
        var attr = ctrl.GetCustomAttribute<ApiGroupAttribute>();
        if (attr is null) continue;
        if (docsDic.ContainsKey(attr.Name)) continue;
        _ = docsDic.TryAdd(attr.Name, attr.Description);
        c.SwaggerDoc(attr.Name, new()
        {
            Title = attr.Title,
            Version = attr.Version,
            Description = attr.Description
        });
    }
    c.DocInclusionPredicate((docName, apiDescription) =>
    {
        //åå°„æ‹¿åˆ°å€¼
        var actionList = apiDescription.ActionDescriptor.EndpointMetadata.Where(x => x is ApiGroupAttribute).ToList();
        if (actionList.Count != 0)
        {
            return actionList.FirstOrDefault() is ApiGroupAttribute attr && attr.Name == docName;
        }
        //åˆ¤æ–­æ˜¯å¦åŒ…å«è¿™ä¸ªåˆ†ç»„
        var not = apiDescription.ActionDescriptor.EndpointMetadata.Where(x => x is not ApiGroupAttribute).ToList();
        return not.Count != 0 && docName == Name;
    });
});
var app = builder.Build();

// Configure the HTTP request pipeline.
if (app.Environment.IsDevelopment())
{
    app.UseSwagger();
    app.UseSwaggerUI(c =>
    {
        // é»˜è®¤åˆ†ç»„
        c.SwaggerEndpoint($"/swagger/{Name}/swagger.json", $"{Title} {Version}");
        // é…ç½®ä½¿ç”¨ApiGroupAttributeçš„åˆ†ç»„
        var controllers = AssemblyHelper.FindTypesByAttribute<ApiGroupAttribute>();
        foreach (var ctrl in controllers)
        {
            var attr = ctrl.GetCustomAttribute<ApiGroupAttribute>();
            if (attr is null) continue;
            if (endPointDic.ContainsKey(attr.Name)) continue;
            _ = endPointDic.TryAdd(attr.Name, attr.Description);
            c.SwaggerEndpoint($"/swagger/{attr.Name}/swagger.json", $"{attr.Title} {attr.Version}");
        }
    });
}
app.UseAuthorization();
app.MapControllers();
app.Run();
```

- è¿™é‡Œåˆ†ç»„çš„é€»è¾‘ä»£ç å°±å·²ç»å®Œæˆäº†,æˆ‘ä»¬å†æ–°å»º TwoController å’Œ ThreeController æ§åˆ¶å™¨æ¥æ¼”ç¤ºåˆ†ç»„.

```csharp
/// <summary>
/// TwoController
/// </summary>
[Route("api/[controller]/[action]"), ApiController, ApiGroup("GroupOne", "v1", "ç¬¬ä¸€ä¸ªåˆ†ç»„")]
public class TwoController : ControllerBase
{
    /// <summary>
    /// TwoHello
    /// </summary>
    /// <returns></returns>
    [HttpGet]
    public string TwoHello() => "Hello GroupOne";
}

/// <summary>
/// ThreeController
/// </summary>
[Route("api/[controller]/[action]"), ApiController, ApiGroup("GroupOne", "v1", "ç¬¬ä¸€ä¸ªåˆ†ç»„")]
public class ThreeController : ControllerBase
{
    /// <summary>
    /// ThreeHello
    /// </summary>
    /// <returns></returns>
    [HttpGet]
    public string ThreeHello() => "Hello GroupOne";
}
```

- å¯ä»¥çœ‹åˆ°æˆ‘ä»¬åˆ†ç»„æˆåŠŸå,é€‰æ‹© GroupOne åˆ†ç»„å³å¯çœ‹åˆ° Two å’Œ Three æ§åˆ¶å™¨çš„ API äº†.

![GroupOne](./images/groupone.png)

### ä¸ºæ·»åŠ äº† Authorize ç‰¹æ€§çš„æ¥å£æ·»åŠ é”å›¾æ ‡

- Authorize ä¸º.NET æ¡†æ¶è‡ªå¸¦çš„ä¸€ä¸ªç‰¹æ€§.è¢«ä»–æ ‡è®°çš„æ¥å£,å¯ä»¥è¡¨ç¤ºè¯¥æ¥å£éœ€è¦ Token æ ¡éªŒé€šè¿‡æ‰èƒ½è®¿é—®.æˆ‘ä»¬å¯ä»¥ä½¿ç”¨ OpenApiSecurityScheme æ¥ä¸ºæ¥å£æ·»åŠ é”,ä¸è¿‡è¿™ä¸ªæ–¹æ¡ˆæœ‰ä¸ªç¼ºç‚¹,ä¼šæŠŠæ‰€æœ‰çš„æ¥å£å‡åŠ ä¸Šé”,å…¶å®æˆ‘ä»¬å®é™…å¼€å‘ä¸­æœ‰äº›æ¥å£æ˜¯ä¸éœ€è¦çš„,è™½ç„¶è®¿é—®å¯èƒ½æ²¡æœ‰ä»€ä¹ˆé—®é¢˜,ä½†æ˜¯è¿™ä¼šç»™å‰ç«¯é€ æˆä¸€äº›è¯¯è§£,æ¯”å¦‚ç™»å½•æ¥å£æœ‰ä¸ªé”.å°±ä¼šè®©äººå¾ˆæ‡µ ğŸ˜µ.ä¸ºäº†é¿å…è¿™äº›ä¸å¿…è¦çš„è¯¯è§£.æ‰€ä»¥å°±æœ‰äº†è¿™ä¸ªéœ€æ±‚,ä¸ºåªæ ‡è®°äº† Authorize ç‰¹æ€§çš„ API æ·»åŠ é”å›¾æ ‡.
- åœ¨é¡¹ç›®é‡Œæ–°å»ºä¸€ä¸ªæ–‡ä»¶å¤¹ SwaggerFilters,å­˜æ”¾æˆ‘ä»¬çš„è‡ªå®šä¹‰çš„ä¸€äº›é’ˆå¯¹ Swagger çš„ Filters.è¿™é‡Œæˆ‘ä»¬å…ˆåˆ›å»ºç¬¬ä¸€ä¸ª SwaggerAuthorizeFilter.cs,å¹¶æ·»åŠ å¦‚ä¸‹ä»£ç .

```csharp
/// <summary>
/// åœ¨Swaggeræ–‡æ¡£ä¸­ç»™éœ€è¦Authorizeçš„æ¥å£æ·»åŠ ğŸ”’
/// </summary>
// ReSharper disable once UnusedMember.Global
// ReSharper disable once ClassNeverInstantiated.Global
public sealed class SwaggerAuthorizeFilter : IOperationFilter
{
    /// <summary>
    /// Apply
    /// </summary>
    /// <param name="operation"></param>
    /// <param name="context"></param>
    public void Apply(OpenApiOperation operation, OperationFilterContext context)
    {
        // å…ˆç­›é€‰å‡ºåŒ…å«Authorizeç‰¹æ€§çš„æ¥å£
        var authAttributes = context.MethodInfo.DeclaringType?.GetCustomAttributes(true)
                                    .Union(context.MethodInfo.GetCustomAttributes(true))
                                    .OfType<AuthorizeAttribute>();
        if (!authAttributes!.Any()) return;
        // ç„¶åä¸ºå…¶æ·»åŠ SecurityScheme
        // ç”±äºé¡¹ç›®ä¸­å¤§éƒ¨åˆ†ä½¿ç”¨çš„éƒ½æ˜¯oauth2 Bearer Tokenè®¤è¯æ‰€ä»¥è¿™é‡Œé»˜è®¤ä»¥è¿™ç§æ–¹å¼å®ç°.åˆ«çš„æ–¹æ¡ˆè¯·è‡ªè¡Œè°ƒæ•´.
        operation.Security = new List<OpenApiSecurityRequirement>
        {
            new()
            {
                {
                    new()
                    {
                        Reference = new()
                        {
                            Type = ReferenceType.SecurityScheme,
                            Id = "Bearer"
                        },
                        Scheme = "oauth2",
                        Name = "Bearer",
                        In = ParameterLocation.Header
                    },
                    new List<string>()
                }
            }
        };
        operation.Responses.Add("401", new() { Description = "Unauthorized" });
    }
}
```

- å†™å¥½ Fillter åäº‹æƒ…å°±ç®€å•äº†.åœ¨ AddSwaggerGen æ–¹æ³•ä¸­æ·»åŠ ä¸€è¡Œä»£ç å³å¯.

```csharp
builder.Services.AddSwaggerGen(c =>
{
    ...
    c.DocInclusionPredicate((docName, apiDescription) =>
    {
        ...
    });
    c.OperationFilter<SwaggerAuthorizeFilter>(); // ä¸ºæ¥å£æ·»åŠ é”å›¾æ ‡
});
```

- æ¥ä¸‹æ¥åœ¨ ThreeController ä¸­æ–°å¢ä¸€ä¸ªæ¥å£æ¥åšéªŒè¯.

```csharp
/// <summary>
/// ThreeAuthorize
/// </summary>
/// <returns></returns>
[HttpGet, Authorize]
public string ThreeAuthorize() => "Hello Authorize";
```

- é‡æ–°å¯åŠ¨ç¨‹åº,å³å¯å‘ç°æ·»åŠ äº† Authorize ç‰¹æ€§çš„æ¥å£å·²ç»åŠ ä¸Šäº†é”.

![Authorize](./images/apiauthorize.png)

### éšè—æ¥å£

- æœ‰äº›åœºæ™¯ä¸‹,æˆ‘ä»¬å¸Œæœ›æŸäº›æ¥å£æ˜¯å†…éƒ¨ä½¿ç”¨,ä¸å¯¹å¤–å…¬å¼€.ç”šè‡³ä¸éœ€è¦è®©å‰ç«¯çŸ¥é“.è¿™ä¸ªæ—¶å€™æˆ‘ä»¬å°±å¯ä»¥åœ¨ Swagger é‡Œéšè—è¿™ç§æ¥å£æˆ–è€…æ§åˆ¶å™¨.è¿™æ ·åšçš„ç›®çš„æ˜¯ä¸ºäº†é™ä½å‰ç«¯å·¥ç¨‹å¸ˆäº§ç”Ÿçš„è¯¯è§£,åŒæ—¶ä¹Ÿå¯ä»¥å°†è¿‡æ—¶çš„æ¥å£éšè—èµ·æ¥,é¿å…å‰ç«¯ä½¿ç”¨é”™è¯¯,è™½ç„¶è¿‡æ—¶æ¥å£å¯ä»¥ä½¿ç”¨ Obsolete ç‰¹æ€§æ¥æ ‡è®°,ä½†æ˜¯ä»–è¿˜æ˜¯èƒ½åœ¨ Swagger ä¸Šçœ‹è§.
- ä¸ºäº†éšè—æ¥å£,æˆ‘ä»¬éœ€è¦æ–°å»ºä¸€ä¸ªç‰¹æ€§ç”¨æ¥æ ‡è®°éœ€è¦éšè—çš„æ¥å£æˆ–è€…æ§åˆ¶å™¨.
- åœ¨ Attributes æ–‡ä»¶å¤¹ä¸­æ·»åŠ  HiddenApiAttribute.cs å¹¶æ·»åŠ å¦‚ä¸‹ä»£ç .

```csharp
/// <summary>
/// è¢«æ­¤ç‰¹æ€§æ ‡è®°çš„Actionæˆ–è€…æ§åˆ¶å™¨å¯åœ¨Swaggeræ–‡æ¡£ä¸­éšè—.
/// </summary>
[AttributeUsage(AttributeTargets.Class | AttributeTargets.Method)]
public sealed class HiddenApiAttribute : Attribute { }
```

- åŒæ—¶è¿˜éœ€è¦åœ¨ SwaggerFilters æ–‡ä»¶å¤¹ä¸­æ·»åŠ  SwaggerHiddenApiFilter.cs æ¥å®ç°è¢«æ ‡è®°æ¥å£éšè—.
- å…¶åŸç†å°±æ˜¯å°†è¢« HiddenApiAttribute æ ‡è®°çš„æ¥å£ä» SwaggerDoc ä¸­ç§»é™¤æ¥æ‰“åˆ°ä¸æ˜¾ç¤ºçš„ç›®çš„.

```csharp
/// <summary>
/// åœ¨Swaggeræ–‡æ¡£ä¸­éšè—æ¥å£
/// </summary>
// ReSharper disable once UnusedMember.Global
// ReSharper disable once ClassNeverInstantiated.Global
public sealed class SwaggerHiddenApiFilter : IDocumentFilter
{
    /// <summary>
    /// Apply
    /// </summary>
    /// <param name="swaggerDoc"></param>
    /// <param name="context"></param>
    public void Apply(OpenApiDocument swaggerDoc, DocumentFilterContext context)
    {
        foreach (var apiDescription in context.ApiDescriptions)
        {
#pragma warning disable IDE0048
            if (!apiDescription.TryGetMethodInfo(out var method) || !method.ReflectedType!.IsDefined(typeof(HiddenApiAttribute)) && !method.IsDefined(typeof(HiddenApiAttribute)))
#pragma warning restore IDE0048
                continue;
            var key = $"/{apiDescription.RelativePath}";
            if (key.Contains('?'))
            {
                var index = key.IndexOf("?", StringComparison.Ordinal);
                key = key[..index];
            }
            _ = swaggerDoc.Paths.Remove(key);
        }
    }
}
```

- è¯¥è¿‡æ»¤å™¨çš„ä½¿ç”¨æ–¹æ³•å’Œå‰è¾¹çš„ SwaggerAuthorizeFilter ä¸€æ ·,åªéœ€è¦ä¸€è¡Œä»£ç .

```csharp
builder.Services.AddSwaggerGen(c =>
{
    ...
    c.OperationFilter<SwaggerAuthorizeFilter>(); // ä¸ºæ¥å£æ·»åŠ é”å›¾æ ‡
    c.DocumentFilter<SwaggerHiddenApiFilter>();  // æ·»åŠ éšè—æ¥å£è¿‡æ»¤
});
```

- æˆ‘ä»¬å†åœ¨ ThreeController ä¸­åˆ›å»ºä¸€ä¸ªæ¥å£æ¥éªŒè¯è¯¥ç‰¹æ€§æ˜¯å¦ç”Ÿæ•ˆ.

```csharp
/// <summary>
/// ThreeHidden
/// </summary>
/// <returns></returns>
[HttpGet, HiddenApi]
public string ThreeHidden() => "Hello Hidden";
```

- é‡æ–°å¯åŠ¨ç¨‹åºå,æˆ‘ä»¬ä¼šå‘ç° ThreeHidden å¹¶æœªæ˜¾ç¤ºåœ¨ Swagger ä¸­è¯´æ˜æˆ‘ä»¬æˆåŠŸäº†.è¿™é‡Œå°±ä¸å†æˆªå›¾äº†.å¯ä»¥ä¸‹è½½æºç æŸ¥çœ‹æ•ˆæœ.
- åŒæ ·è¯¥ç‰¹æ€§å¯ä»¥ä½œç”¨äºæ§åˆ¶å™¨,è¿™æ ·æ•´ä¸ªæ§åˆ¶å™¨ä¸­çš„æ¥å£å‡ä¸ä¼šæ˜¾ç¤º.

### ä¸ºå‚æ•°æ·»åŠ é»˜è®¤å€¼æ˜¾ç¤º

- ç›®å‰æ„Ÿè§‰è¿™ä¸ªåŠŸèƒ½ Swagger æ”¯æŒè¿˜ä¸å¤Ÿå®Œç¾,æœ‰ä¸€äº›ç±»å‹çš„æ•°æ®æ— æ³•æ­£å¸¸é…ç½®,ä¸è¿‡åæœŸä¼šè¶Šæ¥è¶Šå®Œå–„çš„.
- è¿™é‡Œæˆ‘ä»¬ä¹Ÿæ˜¯åˆ©ç”¨ä¸€ä¸ª.NET æ¡†æ¶è‡ªå¸¦çš„ç‰¹æ€§ DefaultValue æ¥å®ç°.ä¸è¿‡åŒæ ·éœ€è¦è‡ªå·±å†™ä¸€ä¸ª Filter æ‰èƒ½å®ç°è¿™ç§åŠŸèƒ½.
- é¦–å…ˆæˆ‘ä»¬åœ¨ SwaggerFilters æ–‡ä»¶å¤¹ä¸­æ–°å»ºä¸€ä¸ª Filter,åå­—å« SwaggerSchemaFilter.cs å¹¶æ·»åŠ å¦‚ä¸‹ä»£ç :

```csharp
/// <summary>
/// æ·»åŠ é»˜è®¤å€¼æ˜¾ç¤º
/// </summary>
// ReSharper disable once UnusedMember.Global
// ReSharper disable once ClassNeverInstantiated.Global
public sealed class SwaggerSchemaFilter : ISchemaFilter
{
    /// <summary>
    /// Apply
    /// </summary>
    /// <param name="schema"></param>
    /// <param name="context"></param>
    public void Apply(OpenApiSchema schema, SchemaFilterContext context)
    {
        if (schema.Properties is null) return;
        foreach (var info in context.Type.GetProperties())
        {
            // Look for class attributes that have been decorated with "[DefaultAttribute(...)]".
            var defaultAttribute = info.GetCustomAttribute<DefaultValueAttribute>();
            if (defaultAttribute is null) continue;
            foreach (var property in schema.Properties)
            {
                // Only assign default value to the proper element.
                if (ToCamelCase(info.Name) != property.Key) continue;
                property.Value.Example = defaultAttribute.Value as IOpenApiAny;
                break;
            }
        }
    }

    /// <summary>
    /// è½¬æˆé©¼å³°å½¢å¼,è¿™é‡Œéœ€è¦æ³¨æ„ä¸€ä¸‹,å¯èƒ½éœ€è¦æŒ‰ç…§ä½ è‡ªå·±çš„å­—æ®µè§„èŒƒè¿›è¡Œè‡ªå®šä¹‰è½¬æ¢,ä¸ç„¶å¯¹ä¸ä¸Š.
    /// </summary>
    /// <param name="name"></param>
    /// <returns></returns>
    private static string ToCamelCase(string name) => char.ToLowerInvariant(name[0]) + name[1..];
}
```

- å…¶ä¸­ ToCamelCase æ–¹æ³•éœ€è¦æ³¨æ„ä¸€ä¸‹,æˆ‘ä»¬ä½¿ç”¨é»˜è®¤çš„é©¼å³°å½¢å¼æ¥è¡¨ç¤º JSON å­—æ®µ,æ‰€ä»¥è¿™é‡Œè‹¥æ˜¯ä¸ä¸€æ ·,éœ€è¦è‡ªå·±å¤„ç†ä¸€ä¸‹.
- æ¥ä¸‹æ¥åœ¨ Program.cs ä¸­é…ç½® SwaggerSchemaFilter.

```csharp
builder.Services.AddSwaggerGen(c =>
{
    ...
    c.DocumentFilter<SwaggerHiddenApiFilter>();  // æ·»åŠ éšè—æ¥å£è¿‡æ»¤
    c.SchemaFilter<SwaggerSchemaFilter>();       // æ·»åŠ é»˜è®¤å€¼æ˜¾ç¤º
});
```

- è¿™ä¸€åˆ‡éƒ½åšå¥½äº†å,ç°åœ¨å›åˆ° FirstController.cs ä¸­,å°† PostParameter ç±»è°ƒæ•´ä¸‹,ä¸ºäº†ç›´è§‚ç‚¹,æˆ‘åŠ äº†ä¸€ä¸ªæ–°çš„å¯¹è±¡.å¹¶è°ƒæ•´æˆå¦‚ä¸‹ä»£ç :

```csharp
/// <summary>
/// POSTå‚æ•°æ¨¡æ‹Ÿ
/// </summary>
public class PostParameter : PutParameter
{
    /// <summary>
    /// Name
    /// </summary>
    [DefaultValue("å¼ ä¸‰")]
    public string Name { get; set; } = string.Empty;

    /// <summary>
    /// Age
    /// </summary>
    [DefaultValue(20)]
    public int Age { get; set; }

    /// <summary>
    /// ç”Ÿæ—¥
    /// </summary>
    [DefaultValue(typeof(DateTime), "2023-04-01")]
    public DateTime Birthday { get; set; } = DateTime.Now;
}
```

- åœ¨ä¸Šè¿°ä¾‹å­ä¸­,æˆ‘ç»™ Name å­—æ®µæ·»åŠ äº†é»˜è®¤å€¼:å¼ ä¸‰,Age æ·»åŠ äº†é»˜è®¤å€¼ 20,æ–°å¢ Birthday å­—æ®µå¹¶è®¾ç½®é»˜è®¤å€¼ä¸º 23 å¹´æ„šäººèŠ‚.
- DefaultValue ç‰¹æ€§ç¬¬ä¸€ä¸ªå‚æ•°ä¸ºæ•°æ®ç±»å‹,æä¾›äº†å‡ ä¸ªé»˜è®¤çš„é‡è½½,è‹¥æ˜¯æ²¡æœ‰çš„è¯,å¯ä»¥ä½¿ç”¨ typeof æ¥æŒ‡å®šç±»å‹,å¹¶ç”¨å­—ç¬¦ä¸²çš„å½¢å¼è®¾ç½®é»˜è®¤å€¼æ˜¾ç¤º.
- åšå¥½è¿™ä¸€åˆ‡å,å¯åŠ¨ç¨‹åº,æ¥è§‚å¯Ÿé»˜è®¤å€¼æ˜¯å¦è®¾ç½®æˆåŠŸ.

![DefaultValue](./images/defaultvalue.png)

- å¯ä»¥çœ‹åˆ°è¿™ä¸€åˆ‡å‡æŒ‰ç…§æˆ‘ä»¬çš„é¢„æœŸå®ç°.
- åˆ°è¿™é‡Œæˆ‘åœ¨å·¥ä½œä¸­ä½¿ç”¨çš„åŠŸèƒ½å·²ç»ä»‹ç»å®Œ,è‹¥æ˜¯ä½ æœ‰å…¶ä»–çš„ç©æ³•,è¯·æä¾› PRğŸ˜ æˆ–è€…å‘Šè¯‰æˆ‘ä¸€èµ·ç ”ç©¶.
- [æºç å·²ä¸Šä¼ è‡³ GitHub](https://github.com/joesdu/Swagger.Sample)

- ä»¥ä¸ŠåŠŸèƒ½åŒæ ·åœ¨æˆ‘çš„åº“ä¸­å·²ç»é¢„å®šä¹‰.å¯ä»¥å‚è€ƒ[EasilyNET.WebCore](https://www.nuget.org/packages/EasilyNET.WebCore)
- [EasilyNET](https://github.com/EasilyNET/EasilyNET)

- [æœ¬æ–‡ GitHub é“¾æ¥](https://github.com/EasilyNET/docs)
