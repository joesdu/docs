## ä¸ºæˆ‘ä»¬çš„ç¨‹åºè¿›è¡Œæ•°å­—ç­¾å

æˆ‘ä»¬å¯ä»¥ä¸ºæˆ‘ä»¬çš„ç¨‹åºè¿›è¡Œæ•°å­—ç­¾å,è¿™æ ·å°±å¯ä»¥è¯æ˜è¯¥ç¨‹åºçš„ä½œè€…æ˜¯å¯ä¿¡çš„.

é¦–å…ˆä¸ºäº†ç­¾åç¨‹åº,æˆ‘ä»¬éœ€è¦å…ˆåˆ›å»ºä¸€ä¸ªè¯ä¹¦.è¯ä¹¦æ˜¯ç”±è¯ä¹¦é¢å‘æœºæ„(CA)é¢å‘çš„,CA æ˜¯å—ä¿¡ä»»çš„ç¬¬ä¸‰æ–¹æœºæ„,å®ƒå¯ä»¥ä¸ºæˆ‘ä»¬é¢å‘è¯ä¹¦.å½“ç„¶æˆ‘ä»¬ä¹Ÿå¯ä»¥è‡ªå·±åˆ›å»ºè¯ä¹¦.æ¥ä¸‹æ¥ç®€å•ä»‹ç»ä¸‹å¦‚ä½•åˆ©ç”¨ OpenSSL å·¥å…·åˆ›å»ºè¯ä¹¦.

### åˆ›å»ºè¯ä¹¦

- [ä¸‹è½½ openssl å®‰è£…åŒ…](http://slproweb.com/products/Win32OpenSSL.html)å¹¶å®‰è£…,æ¨èä¸‹è½½æœ€æ–° 64 ä½ç‰ˆæœ¬.
- æ‰“å¼€å‘½ä»¤è¡Œ,è¾“å…¥ openssl,å¦‚æœæç¤º Openssl ä¸æ˜¯å†…éƒ¨æˆ–å¤–éƒ¨å‘½ä»¤,éœ€è¦è®¾ç½®ä¸€ä¸‹ç¯å¢ƒå˜é‡,æŠŠ Openssl çš„å®‰è£…ç›®å½•åŠ å…¥åˆ° path ç¯å¢ƒå˜é‡.
- å¦å¤–æ–°å»ºä¸€ä¸ªç¯å¢ƒå˜é‡,å¦‚ä»¥ä¸‹æ‰€ç¤º,åç§°ä¸ºï¼šOPENSSL_CONF,æŒ‡å‘ä½ å®‰è£…ç›®å½•çš„ openssl.cfg æ–‡ä»¶,ç°åœ¨è¾“å…¥ openssl åº”è¯¥æ²¡æœ‰é—®é¢˜äº†.
- æ–°å»ºä¸€ä¸ªæ–‡ä»¶å¤¹ç”¨äºæ”¾ç½®å¯†é’¥,åœ¨è¯¥ç›®å½•æ‰“å¼€å‘½ä»¤è¡Œ.

- 1.ç”³è¯·ä¸€ä¸ªç§é’¥,åœ¨å‘½ä»¤è¡Œä¸­è¾“å…¥:

```shell
openssl genrsa -out private.key 2048
```

- ç”³è¯·ä¸€ä¸ª 2048 ä½çš„ RSA åŠ å¯†ç§é’¥.ç›®å½•ä¸‹å°†å¤šäº†ä¸€ä¸ªåä¸º private.key çš„æ–‡ä»¶.

- 2.ç”³è¯·ä¸€ä¸ª 10 å¹´æœ‰æ•ˆæœŸçš„å…¬é’¥

```shell
openssl req -new -x509 -key private.key -days 3650 -out public.crt
```

- å…¶ä¸­ -key private.key æ˜¯æŒ‡å®šè¿™ä¸ªå…¬é’¥çš„é…å¯¹ç§é’¥,å°±æ˜¯ç¬¬ä¸€æ­¥ç”³è¯·çš„ç§é’¥.x509 æ˜¯ X.509 å…¬é’¥æ ¼å¼æ ‡å‡†.

- æ¥ä¸‹æ¥ä¼šæç¤ºä½ è¾“å…¥ä¸€äº›ä¿¡æ¯,ç”¨äºé¢å‘æœºæ„çš„ä¿¡æ¯å±•ç¤º,å¦‚å…¬å¸,æ‰€åœ¨å›½å®¶,åŸå¸‚ç­‰

```conf
You are about to be asked to enter information that will be incorporated
into your certificate request.
What you are about to enter is what is called a Distinguished Name or a DN.
There are quite a few fields but you can leave some blank
For some fields there will be a default value,
If you enter '.', the field will be left blank.
-----
Country Name (2 letter code) [AU]:CN
State or Province Name (full name) [Some-State]:ShangHai
Locality Name (eg, city) []:ShangHai
Organization Name (eg, company) [Internet Widgits Pty Ltd]:XXXXX
Organizational Unit Name (eg, section) []:XXXXX-XXXXX
Common Name (e.g. server FQDN or YOUR name) []:XXXXX
Email Address []:XXXXX@outlook.com
```

- å¦‚æœä¸æƒ³æ¯æ¬¡éƒ½è¾“å…¥è¿™äº›ä¿¡æ¯,å¯ä»¥ä½¿ç”¨â€œ-config é…ç½®æ–‡ä»¶ç›®å½•â€çš„æ–¹å¼æŒ‡å®šé…ç½®æ–‡ä»¶,å®‰è£…å Openssl å,æœ‰ä¸€ä¸ªåä¸º openssl.cnf çš„é»˜è®¤çš„é…ç½®æ–‡ä»¶åœ¨å®‰è£…ç›®å½• bin/cnf ç›®å½•ä¸­.ç¼–è¾‘è¯¥æ–‡ä»¶,æ‰¾åˆ° req_distinguished_name

```conf
[ req_distinguished_name ]
countryName         = Country Name (2 letter code)
countryName_default     = CN
countryName_min         = 2
countryName_max         = 2

stateOrProvinceName     = State or Province Name (full name)
stateOrProvinceName_default = Some-State

localityName            = Locality Name (eg, city)

0.organizationName      = Organization Name (eg, company)
0.organizationName_default  = Internet Widgits Pty Ltd

# we can do this but it is not needed normally :-)
#1.organizationName     = Second Organization Name (eg, company)
#1.organizationName_default = World Wide Web Pty Ltd

organizationalUnitName      = Organizational Unit Name (eg, section)
#organizationalUnitName_default =

commonName          = Common Name (e.g. server FQDN or YOUR name)
commonName_max          = 64

emailAddress            = Email Address
emailAddress_max        = 64
```

- è¿™é‡Œå¯ä»¥æŒ‡å®šè¿™äº›å‚æ•°çš„é»˜è®¤å€¼,å¦‚æŒ‡å®šå›½å®¶é»˜è®¤å€¼ä¸º CN.æŠŠ countryName_default æ”¹æˆ CN å°±è¡Œäº†.ç”³è¯·å®Œå…¬é’¥å,ç›®å½•ä¸‹å°†å¤šäº†ä¸€ä¸ª public.crt çš„æ–‡ä»¶.

- 3.å…¬é’¥åŠç§é’¥çš„æå–åŠ å¯†.ç”±äºä¼ æ’­å®‰å…¨æ–¹é¢çš„è€ƒè™‘,éœ€è¦å°†å…¬é’¥åŠç§é’¥åŠ å¯†,å¾®è½¯æ”¯æŒ PCK12(å…¬é’¥åŠ å¯†æŠ€æœ¯ 12 å·æ ‡å‡†ï¼šPublic Key
  Cryptography Standards #12),PCK12 å°†å…¬é’¥å’Œç§é’¥åˆåœ¨ä¸€ä¸ª PFX åç¼€æ–‡ä»¶å¹¶ç”¨å¯†ç ä¿æŠ¤,å¦‚è¦æå–å…¬é’¥å’Œç§é’¥éœ€è¦å¯†ç ç¡®è®¤.å¦ä¸€ç§è§‰çš„å…¬é’¥ç§é’¥æå–åŠ å¯†æ–¹å¼æ˜¯
  JKS(JAVA Key Store)ç”¨äº JAVA ç¯å¢ƒçš„å…¬é’¥å’Œç§é’¥æå–.è¿™ä¸¤ç§æ ¼å¼å¯ä»¥ç›¸äº’è½¬æ¢.

- åœ¨å‘½ä»¤è¡Œä¸­è¾“å…¥

```shell
openssl pkcs12 -export -in public.crt -inkey private.key -out sign.pfx
```

- è¾“å…¥å¯†ç å’Œç¡®è®¤å¯†ç å,å½“å‰ç›®å½•ä¼šå¤šå‡ºä¸€ä¸ªæ–‡ä»¶:sign.pfx.è¿™å°±æ˜¯æˆ‘ä»¬è¦ç”¨çš„å¯†é’¥è¯ä¹¦äº†.

### ç­¾åç¨‹åº

- ç¨‹åºçš„ç­¾åå°†ä½¿ç”¨åˆ° Visual Studio çš„ç­¾åå·¥å…· signtool.exe,å®ƒä½äº Windows SDK ç›®å½•çš„ bin ç›®å½•ä¸‹.
- æ‰“å¼€å‘½ä»¤è¡Œ,è¾“å…¥ signtool,å¦‚æœæç¤º signtool ä¸æ˜¯å†…éƒ¨æˆ–å¤–éƒ¨å‘½ä»¤,éœ€è¦è®¾ç½®ä¸€ä¸‹ç¯å¢ƒå˜é‡,æŠŠ signtool çš„å®‰è£…ç›®å½•åŠ å…¥åˆ° path ç¯å¢ƒå˜é‡.
- ç­¾åç¨‹åºçš„å‘½ä»¤å¦‚ä¸‹:

```shell
signtool sign /f "sign.pfx" /p "å¯†ç " /tr "http://timestamp.digicert.com" /td SHA256 /fd SHA256 "ç¨‹åºå.exe"
```

- å…¶ä¸­ /f "sign.pfx" æ˜¯æŒ‡å®šç­¾åè¯ä¹¦çš„è·¯å¾„, /p "å¯†ç " æ˜¯æŒ‡å®šç­¾åè¯ä¹¦çš„å¯†ç , /tr "http://timestamp.digicert.com" æ˜¯æŒ‡å®šæ—¶é—´æˆ³æœåŠ¡å™¨åœ°å€, /td SHA256 æ˜¯æŒ‡å®šæ‘˜è¦ç®—æ³•, /fd SHA256 æ˜¯æŒ‡å®šæ–‡ä»¶æ‘˜è¦ç®—æ³•.
- æœ€å "ç¨‹åºå.exe" æ˜¯è¦ç­¾åçš„ç¨‹åºå.
- ç­¾åå®Œæˆå,æˆ‘ä»¬å°±å¯ä»¥åœ¨ç¨‹åºçš„å±æ€§ä¸­æŸ¥çœ‹æ•°å­—ç­¾åé€‰é¡¹å¡çš„ç­¾åä¿¡æ¯äº†.

### éªŒè¯ç­¾å

- éªŒè¯ç­¾åçš„å‘½ä»¤å¦‚ä¸‹:

```shell
signtool verify "ç¨‹åºå.exe"
```

- å…¶ä¸­ "ç¨‹åºå.exe" æ˜¯è¦éªŒè¯ç­¾åçš„ç¨‹åºå.
- ç”±äºæˆ‘è¿™é‡Œæ˜¯è‡ªç­¾å‘çš„è¯ä¹¦,æ‰€ä»¥ä¸å¯ä¿¡è¿˜æ²¡æœ‰éªŒè¯æˆåŠŸè¿‡ ğŸ˜‚,å¤§ä½¬ä»¬å¯ä»¥è¯•è¯•èŠ±é’±çš„è¯ä¹¦å“ˆ!

- å¦‚æœéªŒè¯å¤±è´¥,è¾“å‡ºç»“æœå¦‚ä¸‹:

```shell
Index  Algorithm  Timestamp
========================================
SignTool Error: A certificate chain processed, but terminated in a root
        certificate which is not trusted by the trust provider.

Number of errors: 1
```

å‚è€ƒé“¾æ¥:

[SignTool.exeï¼ˆç­¾åå·¥å…·ï¼‰](https://learn.microsoft.com/zh-cn/dotnet/framework/tools/signtool-exe)
