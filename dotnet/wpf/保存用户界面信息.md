> åœ¨ WPF ç­‰ç”¨æˆ·å®¢æˆ·ç«¯ç¨‹åºçš„å¼€å‘è¿‡ç¨‹ä¸­,å¾€å¾€æˆ‘ä»¬ä¸ºäº†è‰¯å¥½çš„ç”¨æˆ·ä½“éªŒ,éœ€è¦ä¿å­˜ç”¨æˆ·çš„ç•Œé¢ä¿¡æ¯.æ¯”å¦‚ç”¨æˆ·é’ˆå¯¹ç•Œé¢éƒ¨åˆ†çš„ UI å˜åŒ–,å¦‚æ”¾å¤§çª—ä½“,UI ä¸­éƒ¨åˆ†å…ƒç´ ä½ç½®çš„ç¼–è¾‘.å½“ä¸‹ä¸€æ¬¡ç”¨æˆ·æ‰“å¼€çš„æ—¶å€™èƒ½å¤Ÿè¿˜åŸä¹‹å‰çš„ç¼–è¾‘ç»“æœ.è‹¥æ˜¯æ¯æ¬¡æ‰“å¼€éƒ½æ¢å¤åˆ°é»˜è®¤è®¾ç½®é‚£å¯çœŸçš„æ˜¯æ— æ³•æ¥å—,ä»Šå¤©å°±æ¥åˆ†äº«ä¸€ä¸‹æˆ‘åœ¨ WPF ä¸­æ˜¯å¦‚ä½•åˆ©ç”¨ LiteDB å®ç°çš„.

æœ¬æ–‡åˆ†å¦‚ä¸‹å‡ ä¸ªéƒ¨åˆ†æ¥è¯´æ˜:(åŸºäºä¹‹å‰çš„ WpfAutoDISample åœ¨å…¶åŸºç¡€ä¸Šæ¥æ·»åŠ å’Œä¿®æ”¹)

- è°ƒæ•´ä¸»ç•Œé¢çš„ UI å¸ƒå±€,ä½¿ç”¨æˆ‘ä»¬è‡ªå®šä¹‰çš„ç•Œé¢åˆ†å‰²ç»„ä»¶ StatefulGridSplitter,ä»åå­—å°±å¯ä»¥çœ‹å‡ºæ¥,ä»–ä¹Ÿéœ€è¦ä¿å­˜çŠ¶æ€.
- åœ¨ WPF é¡¹ç›®ä¸­ä½¿ç”¨ IMessenger æ¥ä¼ é€’ä¸€äº›æ¶ˆæ¯(æ—©æœŸçš„å¼€å‘ä¸­,ä½¿ç”¨å‘å¸ƒè®¢é˜…æ¨¡å¼è‡ªå·±å®ç°äº†ä¸€ä¸ª,åæ¥å‘ç° CommunityToolkit.Mvvm ä¸­æœ‰ç°æˆçš„å°±ç”¨ç°æˆå¾—äº† ğŸ˜…).
- å¦‚ä½•ä½¿ç”¨ LiteDB æ¥ä¿å­˜æˆ‘ä»¬çš„ç•Œé¢ä¿¡æ¯.

#### è‡ªå®šä¹‰ StatefulGridSplitter ç»„ä»¶

> ä¸ºäº†åæœŸçš„æŒä¹…åŒ–ä»¥åŠæ›´å¤šçš„åŠŸèƒ½è®¾ç½®,è¿™é‡Œæˆ‘ä»¬éœ€è¦è‡ªå·±æ¥å®ç°ä¸€ä¸ªç®€æ˜“çš„ GridSplitter ç»„ä»¶,è€Œä¸æ˜¯ä½¿ç”¨é»˜è®¤çš„.

```csharp
public sealed class StatefulGridSplitter : GridSplitter;
```

ä¸Šé¢çš„ä»£ç å°±å¯ä»¥å®ç°åŸºæœ¬çš„ GridSplitter åŠŸèƒ½,ä½†æ˜¯å¯ä»¥çœ‹å‡ºæ¥ä»–å’Œé»˜è®¤çš„æ•ˆæœä¸€æ · ğŸ˜‚.ä¸ç”¨ç€æ€¥,åé¢å†ä¸€ç‚¹ç‚¹çš„æ·»åŠ å†…å®¹.

- ä¸ºäº†ä½¿å…¶èƒ½å¤Ÿå®ç°æ°´å¹³å’Œå‚ç›´æ–¹å‘éƒ½èƒ½æ­£å¸¸å·¥ä½œ,æˆ‘ä»¬è¿˜éœ€åœ¨ App.xaml ä¸­æ·»åŠ èµ„æº.èµ„æºå†…å®¹å¦‚ä¸‹.

```xml
<ResourceDictionary>
    <Style TargetType="uc:StatefulGridSplitter">
        <Setter Property="HorizontalAlignment" Value="Stretch" />
        <Setter Property="Template">
            <Setter.Value>
                <ControlTemplate TargetType="uc:StatefulGridSplitter">
                    <Border Background="{TemplateBinding Background}" CornerRadius="1" />
                </ControlTemplate>
            </Setter.Value>
        </Setter>
    </Style>
</ResourceDictionary>
```

- åˆ°è¿™é‡Œæˆ‘ä»¬çš„åˆ†å‰²ç»„ä»¶å°±åŸºæœ¬å®Œæˆ,æ¥ä¸‹æ¥å°±å»è°ƒæ•´ä¸€ä¸‹ MainWindow.xaml å®ç°ä¸€ä¸ªå¸¸è§çš„ UI å¸ƒå±€.

```xml
<Window x:Class="WpfAutoDISample.Views.MainWindow"
                 xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
                 xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
                 xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
                 xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
                 xmlns:viewModels="clr-namespace:WpfAutoDISample.ViewModels"
                 xmlns:uc="clr-namespace:WpfAutoDISample.Controls"
                 d:DataContext="{d:DesignInstance viewModels:MainWindowModel}"
                 mc:Ignorable="d"
                 Title="MainWindow" Height="600" Width="800"
                 WindowStartupLocation="CenterScreen">
    <Grid Background="Transparent">
        <Grid.ColumnDefinitions>
                <ColumnDefinition Width="*" />
                <ColumnDefinition Width="Auto" />
                <ColumnDefinition Width="*" />
            </Grid.ColumnDefinitions>
            <!-- å·¦ä¾§çš„Panel -->
            <Border Grid.Column="0">
                <ListView BorderThickness="0"
                       SelectedIndex="0"
                       TextOptions.TextFormattingMode="Display"
                       TextOptions.TextRenderingMode="ClearType"
                       VirtualizingStackPanel.IsVirtualizing="True"
                       VirtualizingStackPanel.VirtualizationMode="Recycling"
                       RenderOptions.ClearTypeHint="Enabled">
                    <ListViewItem>1</ListViewItem>
                    <ListViewItem>2</ListViewItem>
                </ListView>
                <!--ItemContainerStyle="{StaticResource ListViewItemStyle}"-->
            </Border>
            <!-- GridSplitterç”¨äºè°ƒæ•´å¤§å° -->
            <uc:StatefulGridSplitter Grid.Column="1" Width="3" />
            <!-- å³ä¾§çš„Panel -->
            <Border Grid.Column="2" HorizontalAlignment="Stretch">
                <Grid>
                    <Grid.RowDefinitions>
                        <RowDefinition Height="*" />
                        <RowDefinition Height="Auto" />
                        <RowDefinition Height="*" />
                    </Grid.RowDefinitions>
                    <!-- ä¸Šä¾§çš„Panel -->
                    <Border Grid.Row="0" Background="Beige">
                        <TextBlock>ä¸Šä¾§çš„Panel</TextBlock>
                    </Border>
                    <uc:StatefulGridSplitter Grid.Row="1" Height="3" />
                    <!-- ä¸‹ä¾§çš„Panel -->
                    <Border Grid.Row="2" Background="Bisque">
                        <TextBlock>ä¸‹ä¾§çš„Panel</TextBlock>
                    </Border>
                </Grid>
            </Border>
    </Grid>
</Window>

```

ä»ä¸Šé¢çš„ä»£ç åˆ†æå°±å¯ä»¥å¾—åˆ°æˆ‘ä»¬çš„ UI å¤§æ¦‚æ˜¯å·¦å³åˆ†å‰²,ç„¶åå³ä¾§å†ä¸Šä¸‹åˆ†å‰²ä¸€ä¸‹,åœ¨å·¦ä¾§æˆ‘ä»¬æ”¾å…¥äº†ä¸€ä¸ª ListView ç”¨æ¥æ˜¾ç¤ºä¸€ä¸ªåˆ—è¡¨,å³ä¾§åˆ™ä½¿ç”¨ä¸¤ä¸ª TextBlock åˆ†åˆ«æ¥ä»£æŒ‡æ˜¾ç¤ºå†…å®¹,ä¸ºäº†çœäº‹,è¿™é‡Œå°±ä¸æˆªå›¾äº†.

- åŒæ ·è¿˜æœ‰ä¸ªçŸ¥è¯†ç‚¹å¯ä»¥é¡ºå¸¦è¯´ä¸€ä¸‹.å¯ä»¥çœ‹åˆ°æˆ‘çš„ ListView è®¾ç½®äº†ä¸€äº›å±æ€§,è¿™äº›å±æ€§çš„ä½œç”¨ä¸»è¦æ˜¯ä¸ºäº†é˜²æ­¢ç•Œé¢æ¸²æŸ“çš„æ—¶å€™å‡ºç°æ–‡å­—è™šåŒ–çš„é—®é¢˜.æš‚æ—¶å°±ä¸è¯¦ç»†è¯´æ˜å„ä¸ªé…ç½®çš„å«ä¹‰äº†,æ„Ÿå…´è¶£çš„å¯ä»¥è‡ªè¡Œ Bing ä¸€ä¸‹.

```csharp
TextOptions.TextFormattingMode="Display"
TextOptions.TextRenderingMode="ClearType"
VirtualizingStackPanel.IsVirtualizing="True"
VirtualizingStackPanel.VirtualizationMode="Recycling"
RenderOptions.ClearTypeHint="Enabled"
```

è‡³æ­¤,UI çš„åŸºæœ¬å†…å®¹å°±æå®š,ä½†æ˜¯æš‚æ—¶å¹¶ä¸ä¼šæŒä¹…åŒ–ç•Œé¢ä¿¡æ¯.æ¥ä¸‹æ¥æˆ‘ä»¬å°±æ¥å®ç°è¿™äº›åŠŸèƒ½.

#### å‘å¸ƒè®¢é˜… UI å˜åŒ–æ¶ˆæ¯

> åœ¨æŒä¹…åŒ– UI ä¹‹å‰,æˆ‘ä»¬è¿˜éœ€è¦åˆ©ç”¨æ¶ˆæ¯ç³»ç»Ÿ,å‘å¸ƒå’Œè®¢é˜…ç›¸å…³çš„ UI å˜åŒ–çš„æ¶ˆæ¯,å¦‚çª—ä½“å¤§å°å’Œä½ç½®çš„æ”¹å˜,GridSplitter çš„ä½ç½®å˜åŒ–.ä»¥åŠå…¶ä»–æƒ³ä¿å­˜çš„ä¸€äº› UI ä¿¡æ¯.

- åœ¨ WPF ä¸­æˆ‘ä»¬å¯ä»¥åˆ©ç”¨ CommunityToolkit.Mvvm ä¸­çš„ `WeakReferenceMessenger`, `IMessenger` æ¥å®ç°æ¶ˆæ¯çš„è®¢é˜…å’Œå‘å¸ƒ.
- æˆ‘ä»¬å…ˆæ¥å®ç°ç®€å•çš„å†…å®¹,å°†ä¸»çª—ä½“çš„å¤§å°å˜åŒ–é€šè¿‡ IMessenger å‘é€ç»™æˆ‘ä»¬çš„ StatefulGridSplitter,è®©å…¶å¯ä»¥æ ¹æ®çª—ä½“å¤§å°æ¥è®¡ç®—æœ€å¤§æ‹–åŠ¨èŒƒå›´,é¿å…æ‹–åˆ°ç•Œé¢ä¹‹å¤–é€ æˆæ˜¾ç¤ºé—®é¢˜.
- é¦–å…ˆå®šä¹‰æˆ‘ä»¬çš„æ¶ˆæ¯ä½“:

```csharp
internal sealed class MainWindowSizeChangeEventArgs(double width, double height) : EventArgs
{
    public double Width { get; } = width;

    public double Height { get; } = height;
}
```

- ç„¶åæˆ‘ä»¬åœ¨ MainWindow.xaml.cs çš„æ„é€ å‡½æ•°ä¸­æ³¨å†Œ SizeChanged äº‹ä»¶,å¹¶å®Œæˆæ¶ˆæ¯å‘å¸ƒçš„ä»£ç .

```csharp
public MainWindow(MainWindowViewModel mwv, ILogger<MainWindow> logger, IMessenger messenger)
{
    InitializeComponent();
    DataContext = mwv;
    _logger = logger;
    _messenger = messenger;
    SizeChanged += MainWindow_SizeChanged;
}

private void MainWindow_SizeChanged(object sender, SizeChangedEventArgs e)
{
    // è·å–å½“å‰çª—ä½“çš„å°ºå¯¸
    var width = ActualWidth;
    var height = ActualHeight;
    _logger.LogInformation("MainWindow size changed: Width={Width}, Height={Height}", width, height);
    // å‘å¸ƒäº‹ä»¶å¹¶ä¼ é€’å°ºå¯¸ä¿¡æ¯
    _messenger.Send(new MainWindowSizeChangeEventArgs(width, height));
}
```

- æ¶ˆæ¯å‘é€å‡ºå»å,é‚£ä¹ˆæˆ‘ä»¬å°±å¯ä»¥åœ¨ StatefulGridSplitter ç»„ä»¶ä¸­è®¢é˜…è¯¥æ¶ˆæ¯,å¹¶å®Œæˆæˆ‘ä»¬çš„é€»è¾‘ä»£ç .

```csharp
public sealed class StatefulGridSplitter : GridSplitter, IDisposable
{
    private readonly IMessenger _messenger;
    private bool _disposed;

    public StatefulGridSplitter()
    {
        // è®¾ç½®é»˜è®¤èƒŒæ™¯è‰²
        Background = new SolidColorBrush(Color.FromRgb(99, 99, 99));
        _messenger = App.Services.GetRequiredService<IMessenger>();
        _messenger.Register<StatefulGridSplitter, MainWindowSizeChangeEventArgs>(this, Handler);
    }

    /// <summary>
    /// ç”¨æ¥è¡¨ç¤ºGridSplitterçš„æœ€å°èŒƒå›´,ä¸ºäº†ä¸è®©Gridæ‹–åŠ¨åˆ°ä¸å¯è§åŒºåŸŸ,é»˜è®¤ä¸º0.1
    /// </summary>
    public required double MinRatio { get; set; } = 0.1;

    public void Dispose()
    {
        Dispose(true);
        GC.SuppressFinalize(this);
    }

    private void Handler(object recipient, MainWindowSizeChangeEventArgs message)
    {
        if (Parent is not Grid parentGrid) return;
        // è·å–GridSplitterçš„å½“å‰åˆ—å’Œè¡Œä½ç½®
        var columnIndex = Grid.GetColumn(this);
        var rowIndex = Grid.GetRow(this);
        var orientation = DetermineOrientation();
        if (orientation == GridSplitterOrientation.Vertical)
        {
            // å½“ä¸ºå‚ç›´æ–¹å‘æ—¶ï¼Œå½“å‰åˆ—ç´¢å¼•å³ä¸ºæ§åˆ¶çš„åˆ—ç´¢å¼•
            parentGrid.ColumnDefinitions[columnIndex - 1].MinWidth = message.Width * MinRatio;
            parentGrid.ColumnDefinitions[columnIndex + 1].MinWidth = message.Width * MinRatio;
            parentGrid.ColumnDefinitions[columnIndex - 1].MaxWidth = message.Width * (1 - MinRatio);
            parentGrid.ColumnDefinitions[columnIndex + 1].MaxWidth = message.Width * (1 - MinRatio);
        }
        else
        {
            // å½“ä¸ºæ°´å¹³æ–¹å‘æ—¶ï¼Œå½“å‰è¡Œç´¢å¼•å³ä¸ºæ§åˆ¶çš„åˆ—ç´¢å¼•
            parentGrid.RowDefinitions[rowIndex - 1].MinHeight = message.Height * MinRatio;
            parentGrid.RowDefinitions[rowIndex + 1].MinHeight = message.Height * MinRatio;
            parentGrid.RowDefinitions[rowIndex - 1].MaxHeight = message.Height * (1 - MinRatio);
            parentGrid.RowDefinitions[rowIndex + 1].MaxHeight = message.Height * (1 - MinRatio);
        }
    }

    private void Dispose(bool disposing)
    {
        if (_disposed) return;
        if (disposing)
        {
            _messenger.Unregister<MainWindowSizeChangeEventArgs>(this);
        }

        // é‡Šæ”¾éæ‰˜ç®¡èµ„æºï¼ˆå¦‚æœæœ‰ï¼‰
        _disposed = true;
    }

    ~StatefulGridSplitter()
    {
        Dispose(false);
    }
}
```

ä»ä¸Šé¢çš„ä»£ç ä¸­æˆ‘ä»¬å³å¯åœ¨ä¸»çª—ä½“å‘ç”Ÿå˜åŒ–å,å‘é€æ¶ˆæ¯åˆ°æˆ‘ä»¬çš„ç»„ä»¶,å¹¶æ ¹æ®å˜åŒ–çš„å€¼æ¥åŠ¨æ€çš„è°ƒæ•´ GridSplitter çš„ä½ç½®å’Œé™åˆ¶èŒƒå›´.ä¸è¿‡æˆ‘ä»¬çš„æœ€å°èŒƒå›´ä¹Ÿå¯ä»¥é€šè¿‡å±æ€§ä¼ å…¥,åªéœ€è¦åœ¨ä½¿ç”¨çš„æ—¶å€™æŒ‡å®šå°±è¡Œ.

```xml
<uc:StatefulGridSplitter MinRatio="0.12" Grid.Column="1" Width="3" />
```
