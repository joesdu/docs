> åœ¨ WPF ç­‰ç”¨æˆ·å®¢æˆ·ç«¯ç¨‹åºçš„å¼€å‘è¿‡ç¨‹ä¸­,å¾€å¾€æˆ‘ä»¬ä¸ºäº†è‰¯å¥½çš„ç”¨æˆ·ä½“éªŒ,éœ€è¦ä¿å­˜ç”¨æˆ·çš„ç•Œé¢ä¿¡æ¯.æ¯”å¦‚ç”¨æˆ·é’ˆå¯¹ç•Œé¢éƒ¨åˆ†çš„ UI å˜åŒ–,å¦‚æ”¾å¤§çª—ä½“,UI ä¸­éƒ¨åˆ†å…ƒç´ ä½ç½®çš„ç¼–è¾‘.
> å½“ä¸‹ä¸€æ¬¡ç”¨æˆ·æ‰“å¼€çš„æ—¶å€™èƒ½å¤Ÿè¿˜åŸä¹‹å‰çš„ç¼–è¾‘ç»“æœ.è‹¥æ˜¯æ¯æ¬¡æ‰“å¼€éƒ½æ¢å¤åˆ°é»˜è®¤è®¾ç½®é‚£å¯çœŸçš„æ˜¯æ— æ³•æ¥å—,ä»Šå¤©å°±æ¥åˆ†äº«ä¸€ä¸‹æˆ‘åœ¨ WPF ä¸­æ˜¯å¦‚ä½•åˆ©ç”¨ LiteDB å®ç°çš„.

æœ¬æ–‡åˆ†å¦‚ä¸‹å‡ ä¸ªéƒ¨åˆ†æ¥è¯´æ˜:(åŸºäºä¹‹å‰çš„ WpfAutoDISample åœ¨å…¶åŸºç¡€ä¸Šæ¥æ·»åŠ å’Œä¿®æ”¹,æœ¬æ–‡ä»£ç å†…å®¹è¾ƒå¤š,ä¸æƒ³çœ‹æ–‡å­—çš„å¯ä»¥ç›´æ¥çœ‹æºç .)

- è°ƒæ•´ä¸»ç•Œé¢çš„ UI å¸ƒå±€,ä½¿ç”¨æˆ‘ä»¬è‡ªå®šä¹‰çš„ç•Œé¢åˆ†å‰²ç»„ä»¶ StatefulGridSplitter,ä»åå­—å°±å¯ä»¥çœ‹å‡ºæ¥,ä»–ä¹Ÿéœ€è¦ä¿å­˜çŠ¶æ€.
- åœ¨ WPF é¡¹ç›®ä¸­ä½¿ç”¨ IMessenger æ¥ä¼ é€’ä¸€äº›æ¶ˆæ¯(æ—©æœŸçš„å¼€å‘ä¸­,ä½¿ç”¨å‘å¸ƒè®¢é˜…æ¨¡å¼è‡ªå·±å®ç°äº†ä¸€ä¸ª,åæ¥å‘ç° CommunityToolkit.Mvvm ä¸­æœ‰ç°æˆçš„å°±ç”¨ç°æˆå¾—äº† ğŸ˜…).
- å¦‚ä½•ä½¿ç”¨ LiteDB æ¥ä¿å­˜æˆ‘ä»¬çš„ç•Œé¢ä¿¡æ¯.

#### è‡ªå®šä¹‰ StatefulGridSplitter ç»„ä»¶

> ä¸ºäº†åæœŸçš„æŒä¹…åŒ–ä»¥åŠæ›´å¤šçš„åŠŸèƒ½è®¾ç½®,è¿™é‡Œæˆ‘ä»¬éœ€è¦è‡ªå·±æ¥å®ç°ä¸€ä¸ªç®€æ˜“çš„ GridSplitter ç»„ä»¶,è€Œä¸æ˜¯ä½¿ç”¨é»˜è®¤çš„.

```csharp
public sealed class StatefulGridSplitter : GridSplitter;
```

ä¸Šé¢çš„ä»£ç å°±å¯ä»¥å®ç°åŸºæœ¬çš„ GridSplitter åŠŸèƒ½,ä½†æ˜¯å¯ä»¥çœ‹å‡ºæ¥ä»–å’Œé»˜è®¤çš„æ•ˆæœä¸€æ · ğŸ˜‚.ä¸ç”¨ç€æ€¥,åé¢å†ä¸€ç‚¹ç‚¹çš„æ·»åŠ å†…å®¹.

- ä¸ºäº†ä½¿å…¶èƒ½å¤Ÿå®ç°æ°´å¹³å’Œå‚ç›´æ–¹å‘éƒ½èƒ½æ­£å¸¸å·¥ä½œ,æˆ‘ä»¬è¿˜éœ€åœ¨ App.xaml ä¸­æ·»åŠ èµ„æº.èµ„æºå†…å®¹å¦‚ä¸‹.

```xml
<ResourceDictionary>
    <Style TargetType="uc:StatefulGridSplitter">
        <Setter Property="HorizontalAlignment" Value="Stretch" />
        <Setter Property="Template">
            <Setter.Value>
                <ControlTemplate TargetType="uc:StatefulGridSplitter">
                    <Border Background="{TemplateBinding Background}" CornerRadius="1" />
                </ControlTemplate>
            </Setter.Value>
        </Setter>
    </Style>
</ResourceDictionary>
```

- åˆ°è¿™é‡Œæˆ‘ä»¬çš„åˆ†å‰²ç»„ä»¶å°±åŸºæœ¬å®Œæˆ,æ¥ä¸‹æ¥å°±å»è°ƒæ•´ä¸€ä¸‹ MainWindow.xaml å®ç°ä¸€ä¸ªå¸¸è§çš„ UI å¸ƒå±€.

```xml
<Window x:Class="WpfAutoDISample.Views.MainWindow"
                 xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
                 xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
                 xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
                 xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
                 xmlns:viewModels="clr-namespace:WpfAutoDISample.ViewModels"
                 xmlns:uc="clr-namespace:WpfAutoDISample.Controls"
                 d:DataContext="{d:DesignInstance viewModels:MainWindowModel}"
                 mc:Ignorable="d"
                 Title="MainWindow" Height="600" Width="800"
                 WindowStartupLocation="CenterScreen">
    <Grid Background="Transparent">
        <Grid.ColumnDefinitions>
                <ColumnDefinition Width="*" />
                <ColumnDefinition Width="Auto" />
                <ColumnDefinition Width="*" />
            </Grid.ColumnDefinitions>
            <!-- å·¦ä¾§çš„Panel -->
            <Border Grid.Column="0">
                <ListView BorderThickness="0"
                       SelectedIndex="0"
                       TextOptions.TextFormattingMode="Display"
                       TextOptions.TextRenderingMode="ClearType"
                       VirtualizingStackPanel.IsVirtualizing="True"
                       VirtualizingStackPanel.VirtualizationMode="Recycling"
                       RenderOptions.ClearTypeHint="Enabled">
                    <ListViewItem>1</ListViewItem>
                    <ListViewItem>2</ListViewItem>
                </ListView>
                <!--ItemContainerStyle="{StaticResource ListViewItemStyle}"-->
            </Border>
            <!-- GridSplitterç”¨äºè°ƒæ•´å¤§å° -->
            <uc:StatefulGridSplitter Grid.Column="1" Width="3" />
            <!-- å³ä¾§çš„Panel -->
            <Border Grid.Column="2" HorizontalAlignment="Stretch">
                <Grid>
                    <Grid.RowDefinitions>
                        <RowDefinition Height="*" />
                        <RowDefinition Height="Auto" />
                        <RowDefinition Height="*" />
                    </Grid.RowDefinitions>
                    <!-- ä¸Šä¾§çš„Panel -->
                    <Border Grid.Row="0" Background="Beige">
                        <TextBlock>ä¸Šä¾§çš„Panel</TextBlock>
                    </Border>
                    <uc:StatefulGridSplitter Grid.Row="1" Height="3" />
                    <!-- ä¸‹ä¾§çš„Panel -->
                    <Border Grid.Row="2" Background="Bisque">
                        <TextBlock>ä¸‹ä¾§çš„Panel</TextBlock>
                    </Border>
                </Grid>
            </Border>
    </Grid>
</Window>

```

ä»ä¸Šé¢çš„ä»£ç åˆ†æå°±å¯ä»¥å¾—åˆ°æˆ‘ä»¬çš„ UI å¤§æ¦‚æ˜¯å·¦å³åˆ†å‰²,ç„¶åå³ä¾§å†ä¸Šä¸‹åˆ†å‰²ä¸€ä¸‹,åœ¨å·¦ä¾§æˆ‘ä»¬æ”¾å…¥äº†ä¸€ä¸ª ListView ç”¨æ¥æ˜¾ç¤ºä¸€ä¸ªåˆ—è¡¨,å³ä¾§åˆ™ä½¿ç”¨ä¸¤ä¸ª TextBlock åˆ†åˆ«æ¥ä»£æŒ‡æ˜¾ç¤ºå†…å®¹,ä¸ºäº†çœäº‹,è¿™é‡Œå°±ä¸æˆªå›¾äº†.

- åŒæ ·è¿˜æœ‰ä¸ªçŸ¥è¯†ç‚¹å¯ä»¥é¡ºå¸¦è¯´ä¸€ä¸‹.å¯ä»¥çœ‹åˆ°æˆ‘çš„ ListView è®¾ç½®äº†ä¸€äº›å±æ€§,è¿™äº›å±æ€§çš„ä½œç”¨ä¸»è¦æ˜¯ä¸ºäº†é˜²æ­¢ç•Œé¢æ¸²æŸ“çš„æ—¶å€™å‡ºç°æ–‡å­—è™šåŒ–çš„é—®é¢˜.æš‚æ—¶å°±ä¸è¯¦ç»†è¯´æ˜å„ä¸ªé…ç½®çš„å«ä¹‰äº†,æ„Ÿå…´è¶£çš„å¯ä»¥è‡ªè¡Œ Bing ä¸€ä¸‹.

```csharp
TextOptions.TextFormattingMode="Display"
TextOptions.TextRenderingMode="ClearType"
VirtualizingStackPanel.IsVirtualizing="True"
VirtualizingStackPanel.VirtualizationMode="Recycling"
RenderOptions.ClearTypeHint="Enabled"
```

è‡³æ­¤,UI çš„åŸºæœ¬å†…å®¹å°±æå®š,ä½†æ˜¯æš‚æ—¶å¹¶ä¸ä¼šæŒä¹…åŒ–ç•Œé¢ä¿¡æ¯.æ¥ä¸‹æ¥æˆ‘ä»¬å°±æ¥å®ç°è¿™äº›åŠŸèƒ½.

#### å‘å¸ƒè®¢é˜… UI å˜åŒ–æ¶ˆæ¯

> åœ¨æŒä¹…åŒ– UI ä¹‹å‰,æˆ‘ä»¬è¿˜éœ€è¦åˆ©ç”¨æ¶ˆæ¯ç³»ç»Ÿ,å‘å¸ƒå’Œè®¢é˜…ç›¸å…³çš„ UI å˜åŒ–çš„æ¶ˆæ¯,å¦‚çª—ä½“å¤§å°å’Œä½ç½®çš„æ”¹å˜,GridSplitter çš„ä½ç½®å˜åŒ–.ä»¥åŠå…¶ä»–æƒ³ä¿å­˜çš„ä¸€äº› UI ä¿¡æ¯.

- åœ¨ WPF ä¸­æˆ‘ä»¬å¯ä»¥åˆ©ç”¨ CommunityToolkit.Mvvm ä¸­çš„ `WeakReferenceMessenger`, `IMessenger` æ¥å®ç°æ¶ˆæ¯çš„è®¢é˜…å’Œå‘å¸ƒ.
- æˆ‘ä»¬å…ˆæ¥å®ç°ç®€å•çš„å†…å®¹,å°†ä¸»çª—ä½“çš„å¤§å°å˜åŒ–é€šè¿‡ IMessenger å‘é€ç»™æˆ‘ä»¬çš„ StatefulGridSplitter,è®©å…¶å¯ä»¥æ ¹æ®çª—ä½“å¤§å°æ¥è®¡ç®—æœ€å¤§æ‹–åŠ¨èŒƒå›´,é¿å…æ‹–åˆ°ç•Œé¢ä¹‹å¤–é€ æˆæ˜¾ç¤ºé—®é¢˜.
- é¦–å…ˆå®šä¹‰æˆ‘ä»¬çš„æ¶ˆæ¯ä½“:

```csharp
internal sealed class MainWindowSizeChangeEventArgs(double width, double height) : EventArgs
{
    public double Width { get; } = width;

    public double Height { get; } = height;
}
```

- ç„¶åæˆ‘ä»¬åœ¨ MainWindow.xaml.cs çš„æ„é€ å‡½æ•°ä¸­æ³¨å†Œ SizeChanged äº‹ä»¶,å¹¶å®Œæˆæ¶ˆæ¯å‘å¸ƒçš„ä»£ç .

```csharp
public MainWindow(MainWindowViewModel mwv, ILogger<MainWindow> logger, IMessenger messenger)
{
    InitializeComponent();
    DataContext = mwv;
    _logger = logger;
    _messenger = messenger;
    SizeChanged += MainWindow_SizeChanged;
}

private void MainWindow_SizeChanged(object sender, SizeChangedEventArgs e)
{
    // è·å–å½“å‰çª—ä½“çš„å°ºå¯¸
    var width = ActualWidth;
    var height = ActualHeight;
    _logger.LogInformation("MainWindow size changed: Width={Width}, Height={Height}", width, height);
    // å‘å¸ƒäº‹ä»¶å¹¶ä¼ é€’å°ºå¯¸ä¿¡æ¯
    _messenger.Send(new MainWindowSizeChangeEventArgs(width, height));
}
```

- æ¶ˆæ¯å‘é€å‡ºå»å,é‚£ä¹ˆæˆ‘ä»¬å°±å¯ä»¥åœ¨ StatefulGridSplitter ç»„ä»¶ä¸­è®¢é˜…è¯¥æ¶ˆæ¯,å¹¶å®Œæˆæˆ‘ä»¬çš„é€»è¾‘ä»£ç .

```csharp
public sealed class StatefulGridSplitter : GridSplitter, IDisposable
{
    private readonly IMessenger _messenger;
    private bool _disposed;

    public StatefulGridSplitter()
    {
        // è®¾ç½®é»˜è®¤èƒŒæ™¯è‰²
        Background = new SolidColorBrush(Color.FromRgb(99, 99, 99));
        _messenger = App.Services.GetRequiredService<IMessenger>();
        _messenger.Register<StatefulGridSplitter, MainWindowSizeChangeEventArgs>(this, Handler);
    }

    /// <summary>
    /// ç”¨æ¥è¡¨ç¤ºGridSplitterçš„æœ€å°èŒƒå›´,ä¸ºäº†ä¸è®©Gridæ‹–åŠ¨åˆ°ä¸å¯è§åŒºåŸŸ,é»˜è®¤ä¸º0.1
    /// </summary>
    public required double MinRatio { get; set; } = 0.1;

    public void Dispose()
    {
        Dispose(true);
        GC.SuppressFinalize(this);
    }

    private void Handler(object recipient, MainWindowSizeChangeEventArgs message)
    {
        if (Parent is not Grid parentGrid) return;
        // è·å–GridSplitterçš„å½“å‰åˆ—å’Œè¡Œä½ç½®
        var columnIndex = Grid.GetColumn(this);
        var rowIndex = Grid.GetRow(this);
        var orientation = DetermineOrientation();
        if (orientation == GridSplitterOrientation.Vertical)
        {
            // å½“ä¸ºå‚ç›´æ–¹å‘æ—¶ï¼Œå½“å‰åˆ—ç´¢å¼•å³ä¸ºæ§åˆ¶çš„åˆ—ç´¢å¼•
            parentGrid.ColumnDefinitions[columnIndex - 1].MinWidth = message.Width * MinRatio;
            parentGrid.ColumnDefinitions[columnIndex + 1].MinWidth = message.Width * MinRatio;
            parentGrid.ColumnDefinitions[columnIndex - 1].MaxWidth = message.Width * (1 - MinRatio);
            parentGrid.ColumnDefinitions[columnIndex + 1].MaxWidth = message.Width * (1 - MinRatio);
        }
        else
        {
            // å½“ä¸ºæ°´å¹³æ–¹å‘æ—¶ï¼Œå½“å‰è¡Œç´¢å¼•å³ä¸ºæ§åˆ¶çš„åˆ—ç´¢å¼•
            parentGrid.RowDefinitions[rowIndex - 1].MinHeight = message.Height * MinRatio;
            parentGrid.RowDefinitions[rowIndex + 1].MinHeight = message.Height * MinRatio;
            parentGrid.RowDefinitions[rowIndex - 1].MaxHeight = message.Height * (1 - MinRatio);
            parentGrid.RowDefinitions[rowIndex + 1].MaxHeight = message.Height * (1 - MinRatio);
        }
    }

    private void Dispose(bool disposing)
    {
        if (_disposed) return;
        if (disposing)
        {
            _messenger.Unregister<MainWindowSizeChangeEventArgs>(this);
        }

        // é‡Šæ”¾éæ‰˜ç®¡èµ„æºï¼ˆå¦‚æœæœ‰ï¼‰
        _disposed = true;
    }

    ~StatefulGridSplitter()
    {
        Dispose(false);
    }
}
```

ä»ä¸Šé¢çš„ä»£ç ä¸­æˆ‘ä»¬å³å¯åœ¨ä¸»çª—ä½“å‘ç”Ÿå˜åŒ–å,å‘é€æ¶ˆæ¯åˆ°æˆ‘ä»¬çš„ç»„ä»¶,å¹¶æ ¹æ®å˜åŒ–çš„å€¼æ¥åŠ¨æ€çš„è°ƒæ•´ GridSplitter çš„ä½ç½®å’Œé™åˆ¶èŒƒå›´.ä¸è¿‡æˆ‘ä»¬çš„æœ€å°èŒƒå›´ä¹Ÿå¯ä»¥é€šè¿‡å±æ€§ä¼ å…¥,åªéœ€è¦åœ¨ä½¿ç”¨çš„æ—¶å€™æŒ‡å®šå°±è¡Œ.

```xml
<uc:StatefulGridSplitter MinRatio="0.12" Grid.Column="1" Width="3" />
```

- æ¥ä¸‹æ¥æ¥çš„å†…å®¹ä¸­ä½¿ç”¨åˆ°å¾ˆå¤š Constant.cs çš„å†…å®¹,ä½œä¸ºå…¨å±€çš„é™æ€å˜é‡.è¿™é‡Œå…ˆå°†ä»£ç è´´å‡ºæ¥.

```csharp
internal static class Constant
{
    /// <summary>
    /// UIé…ç½®æœåŠ¡Key
    /// </summary>
    internal const string UiConfigServiceKey = "UiConfig";

    /// <summary>
    /// AppCacheæœåŠ¡Key
    /// </summary>
    internal const string AppCacheServiceKey = "AppCache";

    /// <summary>
    /// UIé…ç½®æ•°æ®åº“
    /// </summary>
    internal const string UiConfigDB = "uiconfig.db";

    /// <summary>
    /// AppCacheæ•°æ®åº“
    /// </summary>
    internal const string AppCacheDB = "appcache.db";

    /// <summary>
    /// è·å–ç”¨æˆ·æ•°æ®ç›®å½•,å°†ç”¨æˆ·æ•°æ®ä¿å­˜åˆ°ç”µè„‘é‡Œ[æ–‡æ¡£]ç›®å½•é‡Œ.
    /// </summary>
    /// <returns></returns>
    internal static string GetUserDataPath()
    {
        var documentsPath = Environment.GetFolderPath(Environment.SpecialFolder.MyDocuments);
        var appFolderPath = Path.Combine(documentsPath, "WpfAutoDISample");
        // å¦‚æœåº”ç”¨ç¨‹åºæ–‡ä»¶å¤¹ä¸å­˜åœ¨ï¼Œåˆ™åˆ›å»ºå®ƒ
        if (!Directory.Exists(appFolderPath)) Directory.CreateDirectory(appFolderPath);
        return appFolderPath;
    }
}
```

#### ä½¿ç”¨ LiteDB æ¥æŒä¹…åŒ–ç•Œé¢ä¿¡æ¯

> å¤§å®¶éƒ½çŸ¥é“æˆ‘éå¸¸å–œæ¬¢ä½¿ç”¨ MongoDB,ä¸»è¦æ˜¯ä»–ç®€å•æ— éœ€è®¾ç½®å’Œåˆå§‹åŒ–è¡¨ä»€ä¹ˆçš„,ç›´æ¥å†™ä»£ç å°±è¡Œ.
> è€Œä¸”ç±»ä¼¼äº SQLite çš„åµŒå…¥å¼ NoSQL æ•°æ®åº“ä¹Ÿæœ‰,å°±æ˜¯ä»Šå¤©è¯´çš„ LiteDB.ç”¨æ³•å’Œ SQLite ç±»ä¼¼.
> ä½“éªŒå’Œ MongoDB ç±»ä¼¼,ä½¿ç”¨å‰æ— éœ€è¿ç§»æ•°æ®åº“,æ— éœ€æå‰åˆ›å»ºåº“å’Œè¡¨,å¯ä»¥è¯´æ˜¯éå¸¸çš„çˆ½.
> æ¥ä¸‹æ¥å°±æ¥è°ƒæ•´æˆ‘ä»¬çš„ä»£ç ,ä½¿å…¶ç”¨æˆ·ç•Œé¢ä¿¡æ¯æŒä¹…åŒ–.

- é¦–å…ˆæˆ‘ä»¬é€šè¿‡ä¾èµ–æ³¨å…¥æ¥æ³¨å…¥ LiteDB çš„æœåŠ¡.å®šä¹‰æˆ‘ä»¬çš„ `LiteDBModule.cs`

```csharp
internal sealed class LiteDBModule : AppModule
{
    public override void ConfigureServices(ConfigureServicesContext context)
    {
        var cache_db = Path.Combine(Constant.GetUserDataPath(), "cache");
        // ç¡®ä¿æ•°æ®ç›®å½•å­˜åœ¨
        if (!Directory.Exists(cache_db)) Directory.CreateDirectory(cache_db);
        context.Services.AddKeyedSingleton<ILiteDatabase>(Constant.AppCacheServiceKey, (_, _) => new LiteDatabase(new LiteEngine(new EngineSettings
        {
            AutoRebuild = true,
            Filename = Path.Combine(cache_db, Constant.AppCacheDB)
        })));
        var ui_db = Path.Combine(Constant.GetUserDataPath(), "ui");
        // ç¡®ä¿æ•°æ®ç›®å½•å­˜åœ¨
        if (!Directory.Exists(ui_db)) Directory.CreateDirectory(ui_db);
        context.Services.AddKeyedSingleton<ILiteDatabase>(Constant.UiConfigServiceKey, (_, _) => new LiteDatabase(new LiteEngine(new EngineSettings
        {
            AutoRebuild = true,
            Filename = Path.Combine(ui_db, Constant.UiConfigDB)
        })));
    }
}
```

- æ¥ä¸‹æ¥åœ¨ `AppServiceModules.cs` ä¸­æ³¨å†Œ

```csharp
/**
 * è¦å®ç°è‡ªåŠ¨æ³¨å…¥,ä¸€å®šè¦åœ¨è¿™ä¸ªåœ°æ–¹æ·»åŠ ,ç”±äºä¸­é—´ä»¶çš„æ³¨å†Œé¡ºåºä¼šå¯¹ç¨‹åºäº§ç”Ÿå·¨å¤§å½±å“,å› æ­¤è¯·æ³¨æ„æ¨¡å—çš„æ³¨å…¥é¡ºåº,æœåŠ¡é…ç½®çš„é¡ºåºæ— æ‰€è°“.
 * è¯¥å¤„æ¨¡å—æ³¨å…¥é¡ºåºä¸ºä»ä¸Šè‡³ä¸‹,æœ¬ç±»AppWebModuleæœ€å…ˆæ³¨å†Œ.æ‰€ä»¥æœ¬ç±»ä¸­ä¸­é—´ä»¶æ³¨å†Œå‡½æ•°ApplicationInitializationæœ€å…ˆæ‰§è¡Œ.
 */
[DependsOn(typeof(DependencyAppModule),
    typeof(LiteDBModule))]
internal sealed class AppServiceModules : AppModule;
```

- ç„¶åå®šä¹‰ä¸€ä¸ª Model ç”¨æ¥ä¿å­˜ MainWindow çš„ä¿¡æ¯.

```csharp
internal sealed class MainWindowState
{
    [BsonId]
    public required ObjectId Id { get; set; } // ä½¿ç”¨å›ºå®šIDï¼Œå› ä¸ºåªå­˜å‚¨ä¸€ä¸ªçª—å£çŠ¶æ€

    public double Width { get; set; }

    public double Height { get; set; }

    public double Top { get; set; }

    public double Left { get; set; }
}
```

- ç„¶åæˆ‘ä»¬æ”¹é€ ä¸€ä¸‹ MainWindow.xaml.cs æ–‡ä»¶æ¥ä¿å­˜ä¸»çª—ä½“çš„ä½ç½®,ä»¥åŠå¤§å°ä¿¡æ¯.æ”¹é€ åçš„å†…å®¹å¦‚ä¸‹.

```csharp
[DependencyInjection(ServiceLifetime.Singleton, AddSelf = true)]
public partial class MainWindow
{
    private const string CollectionName = nameof(MainWindow);
    private readonly ILiteCollection<MainWindowState> _coll;
    private readonly ILiteDatabase _db;
    private readonly ILogger<MainWindow> _logger;
    private readonly IMessenger _messenger;

    /// <inheritdoc />
    public MainWindow(MainWindowModel mwm, ILogger<MainWindow> logger, IMessenger messenger, [FromKeyedServices(Constant.UiConfigServiceKey)] ILiteDatabase db)
    {
        InitializeComponent();
        DataContext = mwm;
        _logger = logger;
        _messenger = messenger;
        _db = db;
        _coll = _db.GetCollection<MainWindowState>(CollectionName);
        SizeChanged += MainWindow_SizeChanged;
        SourceInitialized += OnSourceInitialized;
        Closing += MainWindow_Closing;
    }

    public void Dispose()
    {
        _db.Dispose();
    }

    private void MainWindow_SizeChanged(object sender, SizeChangedEventArgs e)
    {
        // è·å–å½“å‰çª—ä½“çš„å°ºå¯¸
        var width = ActualWidth;
        var height = ActualHeight;
        _logger.LogInformation("MainWindow size changed: Width={Width}, Height={Height}", width, height);
        // å‘å¸ƒäº‹ä»¶å¹¶ä¼ é€’å°ºå¯¸ä¿¡æ¯
        _messenger.Send(new MainWindowSizeChangeEventArgs(width, height));
    }

    private void OnSourceInitialized(object? sender, EventArgs e)
    {
        try
        {
            // å°è¯•è·å–çª—å£çŠ¶æ€
            var state = _coll.FindById(new(new ObjectId(Uid)));
            if (state is null) return;
            // åº”ç”¨çª—å£çŠ¶æ€
            Width = state.Width;
            Height = state.Height;
            Top = state.Top;
            Left = state.Left;
        }
        catch (Exception)
        {
            _db.DropCollection(CollectionName);
        }
        _logger.LogInformation("Restored MainWindow state: Width={Width}, Height={Height}, Top={Top}, Left={Left}", Width, Height, Top, Left);
    }

    private void MainWindow_Closing(object? sender, CancelEventArgs e)
    {
        // ä¿å­˜çª—å£çŠ¶æ€
        _coll.Upsert(new MainWindowState
        {
            Id = new(Uid),
            Width = Width,
            Height = Height,
            Top = Top,
            Left = Left
        });
        _logger.LogInformation("Saved MainWindow state: Width={Width}, Height={Height}, Top={Top}, Left={Left}", Width, Height, Top, Left);
    }
}
```

- åŒæ—¶,æˆ‘ä»¬çœ‹åˆ°è¿™é‡Œä½¿ç”¨äº† Uid ä½œä¸ºä¸»é”®,ä¸ºäº†ç¬¬äºŒæ¬¡å¯åŠ¨èƒ½åŠ è½½ä¹‹å‰çš„ä¿¡æ¯,æˆ‘ä»¬éœ€è¦åœ¨ MainWindow.xaml ä¸­æ·»åŠ ä¸€ä¸ª Uid å±æ€§.è¿™ä¸ª Uid å¯ä»¥ä½¿ç”¨ ObjectId æ¥ç”Ÿæˆä¸€ä¸ªæ–°çš„,åªè¦æ˜¯å…¨å±€å”¯ä¸€,ä¸é‡å¤å°±è¡Œ.è€Œä¸”ä¸ç”¨æ›´æ–°.

```xml
<Window x:Class="WpfAutoDISample.Views.MainWindow"
                 xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
                 xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
                 xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
                 xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
                 xmlns:viewModels="clr-namespace:WpfAutoDISample.ViewModels"
                 xmlns:uc="clr-namespace:WpfAutoDISample.Controls"
                 d:DataContext="{d:DesignInstance viewModels:MainWindowModel}"
                 mc:Ignorable="d"
                 Title="MainWindow" Height="600" Width="800"
                 Uid="66976bc7527624f51dbd3088"
                 WindowStartupLocation="CenterScreen">
```

- æ¥ä¸‹æ¥å°† StatefulGridSplitter çš„è®¾ç½®ä¿å­˜ä¸‹æ¥,å¹¶åœ¨å¯åŠ¨çš„æ—¶å€™åŠ è½½ä»–ä»¬.
- é¦–å…ˆåˆ›å»ºä¸€ä¸ªç±» GridSplitterState.cs ç”¨æ¥ä½œä¸ºä¿¡æ¯å®ä½“.

```csharp
internal sealed class GridSplitterState
{
    [BsonId]
    public required ObjectId Id { get; set; } // LiteDBéœ€è¦ä¸€ä¸ªIdå­—æ®µä½œä¸ºä¸»é”®

    public double Value { get; set; } // ä¿å­˜çš„ä½ç½®å€¼ï¼Œå¯ä»¥æ˜¯å®½åº¦æˆ–é«˜åº¦
}
```

- æ¥ä¸‹æ¥è°ƒæ•´ StatefulGridSplitter ä½¿å…¶æŒä¹…åŒ–çŠ¶æ€ä¿¡æ¯.

```csharp
public sealed class StatefulGridSplitter : GridSplitter, IDisposable
{
    private const string CollectionName = nameof(StatefulGridSplitter);
    private readonly ILiteCollection<GridSplitterState> _coll;
    private readonly IMessenger _messenger;
    private readonly ILiteDatabase db;
    private bool _disposed;

    public StatefulGridSplitter()
    {
        // è®¾ç½®é»˜è®¤èƒŒæ™¯è‰²
        Background = new SolidColorBrush(Color.FromRgb(99, 99, 99));
        db = App.Services.GetRequiredKeyedService<ILiteDatabase>(Constant.UiConfigServiceKey);
        _coll = db.GetCollection<GridSplitterState>(CollectionName);
        Loaded += StatefulGridSplitter_Loaded;
        DragCompleted += StatefulGridSplitter_DragCompleted;
        _messenger = App.Services.GetRequiredService<IMessenger>();
        _messenger.Register<StatefulGridSplitter, MainWindowSizeChangeEventArgs>(this, Handler);
    }

    /// <summary>
    /// ç”¨æ¥è¡¨ç¤ºGridSplitterçš„æœ€å°èŒƒå›´,ä¸ºäº†ä¸è®©Gridæ‹–åŠ¨åˆ°ä¸å¯è§åŒºåŸŸ,é»˜è®¤ä¸º0.1
    /// </summary>
    public required double MinRatio { get; set; } = 0.1;

    public void Dispose()
    {
        Dispose(true);
        GC.SuppressFinalize(this);
    }

    private void Handler(object recipient, MainWindowSizeChangeEventArgs message)
    {
        if (Parent is not Grid parentGrid) return;
        // è·å–GridSplitterçš„å½“å‰åˆ—å’Œè¡Œä½ç½®
        var columnIndex = Grid.GetColumn(this);
        var rowIndex = Grid.GetRow(this);
        var orientation = DetermineOrientation();
        if (orientation == GridSplitterOrientation.Vertical)
        {
            // å½“ä¸ºå‚ç›´æ–¹å‘æ—¶ï¼Œå½“å‰åˆ—ç´¢å¼•å³ä¸ºæ§åˆ¶çš„åˆ—ç´¢å¼•
            parentGrid.ColumnDefinitions[columnIndex - 1].MinWidth = message.Width * MinRatio;
            parentGrid.ColumnDefinitions[columnIndex + 1].MinWidth = message.Width * MinRatio;
            parentGrid.ColumnDefinitions[columnIndex - 1].MaxWidth = message.Width * (1 - MinRatio);
            parentGrid.ColumnDefinitions[columnIndex + 1].MaxWidth = message.Width * (1 - MinRatio);
        }
        else
        {
            // å½“ä¸ºæ°´å¹³æ–¹å‘æ—¶ï¼Œå½“å‰è¡Œç´¢å¼•å³ä¸ºæ§åˆ¶çš„åˆ—ç´¢å¼•
            parentGrid.RowDefinitions[rowIndex - 1].MinHeight = message.Height * MinRatio;
            parentGrid.RowDefinitions[rowIndex + 1].MinHeight = message.Height * MinRatio;
            parentGrid.RowDefinitions[rowIndex - 1].MaxHeight = message.Height * (1 - MinRatio);
            parentGrid.RowDefinitions[rowIndex + 1].MaxHeight = message.Height * (1 - MinRatio);
        }
    }

    private void Dispose(bool disposing)
    {
        if (_disposed) return;
        if (disposing)
        {
            Loaded -= StatefulGridSplitter_Loaded;
            DragCompleted -= StatefulGridSplitter_DragCompleted;
            db.Dispose();
            _messenger.Unregister<MainWindowSizeChangeEventArgs>(this);
        }

        // é‡Šæ”¾éæ‰˜ç®¡èµ„æºï¼ˆå¦‚æœæœ‰ï¼‰
        _disposed = true;
    }

    ~StatefulGridSplitter()
    {
        Dispose(false);
    }

    private void StatefulGridSplitter_DragCompleted(object sender, DragCompletedEventArgs e)
    {
        if (Parent is not Grid parentGrid || string.IsNullOrEmpty(Uid)) return;
        var orientation = DetermineOrientation();
        double realValue;
        switch (orientation)
        {
            case GridSplitterOrientation.Vertical:
            {
                var gridColumnIndex = Grid.GetColumn(this);
                realValue = parentGrid.ColumnDefinitions[gridColumnIndex - 1].Width.Value;
                break;
            }
            case GridSplitterOrientation.Horizontal:
            {
                var gridRowIndex = Grid.GetRow(this);
                realValue = parentGrid.RowDefinitions[gridRowIndex - 1].Height.Value;
                break;
            }
            case GridSplitterOrientation.Unknown:
                realValue = parentGrid.ActualWidth * MinRatio;
                break;
            default:
                throw new("æœªçŸ¥GridSplitterOrientationçŠ¶æ€");
        }
        _coll.Upsert(new GridSplitterState
        {
            Id = new(Uid),
            Value = realValue
        });
    }

    private GridSplitterOrientation DetermineOrientation()
    {
        // å¦‚æœHeightä¸æ˜¯è‡ªåŠ¨ï¼ˆå³æœ‰æ˜ç¡®çš„å€¼ï¼‰ï¼Œä¸”Widthæ˜¯è‡ªåŠ¨ï¼ˆDouble.NaNï¼‰ï¼Œåˆ™è®¤ä¸ºæ˜¯æ°´å¹³åˆ†å‰²å™¨
        if (!double.IsNaN(Height) && double.IsNaN(Width))
        {
            return GridSplitterOrientation.Horizontal;
        }
        // å¦‚æœWidthä¸æ˜¯è‡ªåŠ¨ï¼ˆå³æœ‰æ˜ç¡®çš„å€¼ï¼‰ï¼Œä¸”Heightæ˜¯è‡ªåŠ¨ï¼ˆDouble.NaNï¼‰ï¼Œåˆ™è®¤ä¸ºæ˜¯å‚ç›´åˆ†å‰²å™¨
        if (!double.IsNaN(Width) && double.IsNaN(Height))
        {
            return GridSplitterOrientation.Vertical;
        }
        // å¦‚æœæ— æ³•ç¡®å®šï¼Œè¿”å›"Unknown"
        return GridSplitterOrientation.Unknown;
    }

    private void StatefulGridSplitter_Loaded(object sender, RoutedEventArgs e)
    {
        if (Parent is not Grid parentGrid || string.IsNullOrEmpty(Uid)) return;
        // è·å–GridSplitterçš„å½“å‰åˆ—å’Œè¡Œä½ç½®
        var columnIndex = Grid.GetColumn(this);
        var rowIndex = Grid.GetRow(this);
        var orientation = DetermineOrientation();
        var realValue = orientation is GridSplitterOrientation.Vertical
                            ? parentGrid.ActualWidth * MinRatio
                            : parentGrid.ActualHeight * (1 - MinRatio);
        try
        {
            var config = _coll.FindById(new(new ObjectId(Uid)));
            realValue = config?.Value ?? realValue;
        }
        catch (Exception)
        {
            // å½“è·å–æ•°æ®å‡ºç°å¼‚å¸¸,è¡¨æ˜æ•°æ®ç»“æ„å¯èƒ½å‘ç”Ÿäº†å˜åŒ–,åˆ é™¤åŸæœ‰çš„é›†åˆ,å½“ä¸‹æ¬¡åŠ è½½æ—¶ä¼šé‡æ–°åˆ›å»ºæ­£ç¡®çš„æ•°æ®ç»“æ„
            db.DropCollection(CollectionName);
        }
        if (orientation == GridSplitterOrientation.Vertical)
        {
            // å½“ä¸ºå‚ç›´æ–¹å‘æ—¶ï¼Œå½“å‰åˆ—ç´¢å¼•å³ä¸ºæ§åˆ¶çš„åˆ—ç´¢å¼•
            parentGrid.ColumnDefinitions[columnIndex - 1].Width = new(realValue, GridUnitType.Pixel);
            parentGrid.ColumnDefinitions[columnIndex - 1].MinWidth = parentGrid.ActualWidth * MinRatio;
            parentGrid.ColumnDefinitions[columnIndex + 1].MinWidth = parentGrid.ActualWidth * MinRatio;
            parentGrid.ColumnDefinitions[columnIndex - 1].MaxWidth = parentGrid.ActualWidth * (1 - MinRatio);
            //parentGrid.ColumnDefinitions[columnIndex + 1].MaxWidth = parentGrid.ActualWidth * (1 - MinRatio);
        }
        else
        {
            // å½“ä¸ºæ°´å¹³æ–¹å‘æ—¶ï¼Œå½“å‰è¡Œç´¢å¼•å³ä¸ºæ§åˆ¶çš„åˆ—ç´¢å¼•
            parentGrid.RowDefinitions[rowIndex - 1].Height = new(realValue, GridUnitType.Pixel);
            parentGrid.RowDefinitions[rowIndex - 1].MinHeight = parentGrid.ActualHeight * MinRatio;
            parentGrid.RowDefinitions[rowIndex + 1].MinHeight = parentGrid.ActualHeight * MinRatio;
            parentGrid.RowDefinitions[rowIndex - 1].MaxHeight = parentGrid.ActualHeight * (1 - MinRatio);
            //parentGrid.RowDefinitions[rowIndex + 1].MaxHeight = parentGrid.ActualHeight * (1 - MinRatio);
        }
    }
}
```

- ä¸€æ ·çš„,æˆ‘ä»¬åŒæ ·éœ€è¦ä¸º StatefulGridSplitter è®¾ç½®ä¸åŒçš„ Uid ç”¨äºåŒºåˆ†ä¸åŒçš„å®ä¾‹.æ‰“å¼€ MainWindow.xaml æ–‡ä»¶,å°†éƒ¨åˆ†å†…å®¹è°ƒæ•´ä¸ºå¦‚ä¸‹å†…å®¹.

```xml
<!-- å·¦ä¾§çš„Panel -->
<Border Grid.Column="0">
    <ListView BorderThickness="0"
           SelectedIndex="0"
           TextOptions.TextFormattingMode="Display"
           TextOptions.TextRenderingMode="ClearType"
           VirtualizingStackPanel.IsVirtualizing="True"
           VirtualizingStackPanel.VirtualizationMode="Recycling"
           RenderOptions.ClearTypeHint="Enabled">
        <ListViewItem>1</ListViewItem>
        <ListViewItem>2</ListViewItem>
    </ListView>
    <!--ItemContainerStyle="{StaticResource ListViewItemStyle}"-->
</Border>
<!-- GridSplitterç”¨äºè°ƒæ•´å¤§å° -->
<uc:StatefulGridSplitter Uid="66976bc7527624f51dbd3089" MinRatio="0.12" Grid.Column="1" Width="3" />
<!-- å³ä¾§çš„Panel -->
<Border Grid.Column="2" HorizontalAlignment="Stretch">
    <Grid>
        <Grid.RowDefinitions>
            <RowDefinition Height="*" />
            <RowDefinition Height="Auto" />
            <RowDefinition Height="*" />
        </Grid.RowDefinitions>
        <!-- ä¸Šä¾§çš„Panel -->
        <Border Grid.Row="0" Background="Beige">
            <TextBlock>ä¸Šä¾§çš„Panel</TextBlock>
        </Border>
        <uc:StatefulGridSplitter Uid="66976c00527624f51dbd308a" MinRatio="0.15" Grid.Row="1" Height="3" />
        <!-- ä¸‹ä¾§çš„Panel -->
        <Border Grid.Row="2" Background="Bisque">
            <TextBlock>ä¸‹ä¾§çš„Panel</TextBlock>
        </Border>
    </Grid>
</Border>
```

- æœ€åå¯åŠ¨æˆ‘ä»¬çš„ç¨‹åº,æ‹–åŠ¨çª—å£å¤§å°ä»¥åŠå†…éƒ¨æ§ä»¶è°ƒæ•´,å‡å¯å®ç°æŒä¹…åŒ–,é‡å¯ç¨‹åºä¹Ÿæ˜¯èƒ½å¤Ÿæ­£å¸¸å¤„ç†.

- æœ€åæŒ‰ç…§å¸¸ä¾‹è´´å‡ºæºç åœ°å€: https://github.com/joesdu/WpfAutoDISample
