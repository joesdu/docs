### åœ¨ WebApi é¡¹ç›®ä¸­å¿«é€Ÿå¼€å§‹ä½¿ç”¨ RabbitMQ

> RabbitMQ æ˜¯ VMware ä¸€ä¸ªéå¸¸å¼ºå¤§çš„å¼€æºæ¶ˆæ¯ä»£ç†è½¯ä»¶,é€šå¸¸ç”¨äºå¤„ç†èƒŒæ™¯ä»»åŠ¡,å»¶è¿Ÿæ¶ˆæ¯å’Œé•¿æ—¶é—´è¿è¡Œçš„ä»»åŠ¡.å®ƒæ”¯æŒå¤šç§æ¶ˆæ¯é˜Ÿåˆ—åè®®(AMQP,MQTT,STOMP ç­‰),å¯ä»¥åœ¨åˆ†å¸ƒå¼å’Œè”ç½‘ç¯å¢ƒä¸­ä½¿ç”¨,æä¾›äº†é«˜å¯ç”¨æ€§å’Œå¯é æ€§.

è‡³äºå…¶ä»–çš„ä¸€äº›ä¼˜ç‚¹ä¹Ÿä¸å¿…å¤šè¯´,è¿™ä¹Ÿä¸æ˜¯æˆ‘çš„é£æ ¼.æˆ‘å–œæ¬¢çš„å°±æ˜¯å¥½ç”¨,ç¨³,ç®€å•.ğŸ˜

å…¶ä»–çš„æ›´å¤šçš„å†…å®¹è¿™é‡Œä¸å†å¤šè¯´,ä»¥åŠ RabbitMQ çš„ 7 ç§å·¥ä½œæ¨¡å¼.å¯ä»¥å‚è€ƒå·¥è‰¯å¤§ä½¬çš„åšå®¢,å’ŒæŸ¥çœ‹å®˜ç½‘çš„ä¾‹å­æ¥å­¦ä¹ .

- å·¥è‰¯å¤§ä½¬çš„åšå®¢åœ°å€: https://www.whuanle.cn/archives/21430
- å®˜ç½‘é“¾æ¥: https://www.rabbitmq.com/tutorials

å®˜ç½‘çš„ä¾‹å­åŒ…å«å„ç§è¯­è¨€çš„å®ç°.éœ€è¦çš„å¯ä»¥æŸ¥çœ‹ä¸€ä¸‹,æˆ‘ä¸»è¦ç”¨ C#,æ‰€ä»¥è¿™é‡Œæˆ‘ä»…ä½¿ç”¨ C#ä½œä¸ºæœ¬æ–‡å†…å®¹.

#### éƒ¨ç½² RabbitMQ æœåŠ¡

> è¦ä½¿ç”¨ RabbitMQ è‚¯å®šæ˜¯éœ€è¦æˆ‘ä»¬éƒ¨ç½²ä¸€ä¸ªæœåŠ¡ç«¯çš„.è¿™é‡Œä¹Ÿæœ‰å¿…è¦ç®€è¦çš„å¿«é€Ÿè¯´æ˜ä¸€ä¸‹,å®‰è£…æ–¹æ³•.

å½“ç„¶æˆ‘ä»¬å¯ä»¥æ ¹æ®å®˜ç½‘çš„æ•™ç¨‹,è¿›è¡Œæ‰‹åŠ¨å®‰è£…æœåŠ¡.ä½†æ˜¯ç•¥æ˜¾éº»çƒ¦.æ‰€ä»¥é’ˆå¯¹åœ¨ Ubuntu/Debian æ“ä½œç³»ç»Ÿçš„å°ä¼™ä¼´æˆ‘å†™äº†ä¸€ä¸ªè„šæœ¬.å½“ç„¶ä¹Ÿæœ‰ä¸€äº›æ³¨æ„äº‹é¡¹.

- ç¬¬ä¸€ä¸ªå°±æ˜¯ç³»ç»Ÿç‰ˆæœ¬.æ¨èä½¿ç”¨ Ubuntu ç³»ç»Ÿå¹¶ä¸”ç³»ç»Ÿç‰ˆæœ¬ä¸º: 22.04, 23.04, 23.10
- è™½ç„¶ Debian ä¹Ÿå¯ä»¥,ä½†æ˜¯æ›´æ¨è Ubuntu,å¹¶ä¸”ä½¿ç”¨è¾ƒæ–°çš„ç‰ˆæœ¬,è¿™æ ·ä¸å®¹æ˜“å‡ºç°ä¾èµ–é—®é¢˜.
- è¿™å‡ ä¸ªç‰ˆæœ¬æ˜¯ç»è¿‡æˆ‘æµ‹è¯•çš„.å¯ä»¥é€šè¿‡ä¸€é”®å®‰è£…è„šæœ¬è¿›è¡Œå®‰è£….

```bash
curl -s https://raw.githubusercontent.com/joesdu/rabbitmq-server-install-bash/main/install.sh | sudo bash
```

è„šæœ¬æºç æ‰€åœ¨ä»“åº“: https://github.com/joesdu/rabbitmq-server-install-bash

æœ‰å…´è¶£çš„å¯ä»¥å»çœ‹çœ‹,å¹¶ä¸”è‹¥æ˜¯èƒ½æäº¤æ–°çš„ PR å°±æ›´å¥½äº†.

- å½“ç„¶äº‹æƒ…ä¹Ÿä¸å¿…å¦‚æ­¤éº»çƒ¦,å› ä¸ºç°åœ¨å¼€å‘æˆ‘ä»¬æœ‰æ›´å¿«é€Ÿå’Œæ–¹ä¾¿çš„å·¥å…· Docker.åˆ©ç”¨ Docker æˆ‘ä»¬å¯ä»¥å¿«é€Ÿçš„æ„å»ºä¸€ä¸ªæœåŠ¡ç”¨äºæµ‹è¯•,ç”Ÿäº§ç¯å¢ƒä¹Ÿå¯ä»¥ä½¿ç”¨ Docker è¿›è¡ŒæœåŠ¡éƒ¨ç½².ç®€ç›´ä¸è¦å¤ªèˆ’æœ.
- æ‰€ä»¥æˆ‘ä¹Ÿåˆ¶ä½œäº† Docker é•œåƒç”¨äºå¿«é€Ÿéƒ¨ç½²æœåŠ¡ç«¯.å¯ä»¥ä½¿ç”¨å¦‚ä¸‹å‘½ä»¤è¿è¡Œä¸€ä¸ªå®¹å™¨.

```bash
# å¯åŠ¨RabbitMQæœåŠ¡,è¯¥é•œåƒåŒ…å«å¹¶å¯ç”¨ delayed_message_exchange æ’ä»¶
docker run --name rabbitmq -p 5672:5672 -p 15672:15672 -d --rm -it -e RABBITMQ_DEFAULT_USER=guest -e RABBITMQ_DEFAULT_PASS=guest dygood/rabbitmq:3.13-management-dlx
```

é•œåƒæºç ä»“åº“: https://github.com/EasilyNET/rabbit-with-dlx-image

#### åˆ›å»ºé¡¹ç›®å¼€å§‹å†™ä»£ç äº†

- æœåŠ¡ç«¯å‡†å¤‡å¥½å,æˆ‘ä»¬ä¾¿å¯ä»¥å¼€å§‹å†™ä»£ç äº†,ç›®å‰ä»£ç åˆšå¼€å§‹åˆ›å»º.æˆ‘å†™æ–‡æ¡£éƒ½æ˜¯å†™åˆ°ä»€ä¹ˆåœ°æ–¹å°±å¼€å§‹ä»€ä¹ˆæ“ä½œ,æ‰€ä»¥æœ‰å¯èƒ½å‰åæ–‡å­—é£æ ¼ä¼šå‘ç”Ÿå˜åŒ–,å¸Œæœ›è§è°….
- æ‰“å¼€å‘½ä»¤è¡Œåˆ›å»ºä¸€ä¸ªè§£å†³æ–¹æ¡ˆæ–‡ä»¶,åå­—éšä½ ä»¬è‡ªå·±å–.å¹¶åŠ å…¥ä¸€äº›æˆ‘ä»¬éœ€è¦çš„ä¸œè¥¿.

```bash
# åˆ›å»ºè§£å†³æ–¹æ¡ˆæ–‡ä»¶
dotnet new sln -n easilynet.sample.rabbit
# åˆ›å»ºç”Ÿäº§è€…Webapié¡¹ç›®,æ–¹ä¾¿ä½¿ç”¨Swaggerè¿›è¡Œæ¶ˆæ¯å‘å¸ƒ
dotnet new apicontroller -n Producer.Api
# å°†ç”Ÿäº§è€…é¡¹ç›®æ·»åŠ åˆ°è§£å†³æ–¹æ¡ˆæ–‡ä»¶ä¸­
dotnet sln add ./Producer.Api
# åˆ›å»ºæ¶ˆè´¹è€…é¡¹ç›®
dotnet new apicontroller -n Consumer
# å°†æ¶ˆè´¹è€…æ·»åŠ åˆ°è§£å†³æ–¹æ¡ˆ
dotnet sln add ./Consumer
# è¿™é‡Œæˆ‘ä»¬å†åˆ›å»ºä¸€ä¸ªç±»åº“,ç”¨äºæ„å»ºæ¶ˆæ¯å®ä½“.æ–¹ä¾¿ç®¡ç†å’Œå¼•ç”¨.å¹¶å°†å…¶åŠ å…¥è§£å†³æ–¹æ¡ˆä¸­
dotnet new classlib -n RabbitEvents
dotnet sln add ./RabbitEvents
# æ¥ä¸‹æ¥ä¸¤å¥ç”±AIç”Ÿæˆ,çœŸæ˜¯ç‰›å•Š,æ„æ€å°±æ˜¯å°†RabbitEventsåº“åˆ†åˆ«æ·»åŠ åˆ°æ¶ˆè´¹è€…å’Œç”Ÿäº§è€…é¡¹ç›®ä¸­
# Add the RabbitEvents library as a reference to the Producer.Api project
dotnet add ./Producer.Api/Producer.Api.csproj reference ./RabbitEvents/RabbitEvents.csproj
# Add the RabbitEvents library as a reference to the Consumer project
dotnet add ./Consumer/Consumer.csproj reference ./RabbitEvents/RabbitEvents.csproj
# æ¥ä¸‹æ¥ä¸ºå„ä¸ªé¡¹ç›®å¼•å…¥ä¾èµ–åŒ….
# Add the necessary NuGet packages to the RabbitEvents project
dotnet add ./RabbitEvents/RabbitEvents.csproj package EasilyNET.RabbitBus.Core
dotnet add ./Producer.Api/Producer.Api.csproj package EasilyNET.RabbitBus.AspNetCore
dotnet add ./Consumer/Consumer.csproj package EasilyNET.RabbitBus.AspNetCore
```

- åˆ°è¿™é‡Œ,æˆ‘ä»¬ä¾¿å¯ä»¥ç”¨ VS æˆ–è€… VS Code æ‰“å¼€é¡¹ç›®äº†.å½“ç„¶,æˆ‘ä»¬ä½¿ç”¨ VS ç›´æ¥å¯è§†åŒ–åˆ›å»ºé¡¹ç›®å¹¶æ·»åŠ å¼•ç”¨ä¹Ÿæ˜¯éå¸¸å¯ä»¥çš„.ä¸ºäº†ä¸æˆªå›¾,è¿™é‡Œå°±ä½¿ç”¨å‘½ä»¤çš„æ–¹å¼è¿›è¡Œåˆ›å»ºäº†.
- æ¥ä¸‹æ¥,å…ˆä¸ºç”Ÿäº§è€…å’Œæ¶ˆè´¹è€…æ·»åŠ æœåŠ¡æ³¨å†Œ.å¹¶åˆ é™¤ä¸€äº›æ¨¡æ¿çš„ä»£ç .è¯¦ç»†ä»£ç ,ç¨åæˆ‘ä¼šä¸Šä¼ åˆ° GitHub,æ‰€ä»¥è¿™é‡Œæˆ‘ç®€è¦çš„å†™ä¸€ä¸ªä¾‹å­.

- é¦–å…ˆåœ¨æ¶ˆè´¹è€…å’Œç”Ÿäº§è€…é¡¹ç›®ä¸­,æ·»åŠ æœåŠ¡.

```csharp
// é…ç½®æœåŠ¡(äº¦å¯ä½¿ç”¨é›†ç¾¤æ¨¡å¼æˆ–è€…ä½¿ç”¨é…ç½®æ–‡ä»¶)
builder.Services.AddRabbitBus(c =>
{
    c.Host = "localhost";
    c.Port = 5672;
    c.UserName = "guest";
    c.PassWord = "guest";
});
// æˆ–è€…ä½¿ç”¨é…ç½®æ–‡ä»¶
// builder.Services.AddRabbitBus(builder.Configuration, poolCount: (uint)Environment.ProcessorCount);
```

- è‹¥æ˜¯ä½¿ç”¨ Configuration æ³¨å†Œ,åˆ™æŒ‰ç…§å¦‚ä¸‹æ ¼å¼ä¹¦å†™è¿æ¥å­—ç¬¦ä¸².

```json
{
  "ConnectionStrings": {
    "Rabbit": "amqp://guest:guest@localhost:5672/%2f"
  }
}
```

- ç„¶åæˆ‘ä»¬åœ¨ RabbitEvents é¡¹ç›®ä¸­æ·»åŠ ä¸€ä¸ªæ¶ˆæ¯å®ä½“.è¿™é‡Œä»¥ DelayedEvent ä¸ºä¾‹,é¡ºä¾¿ä»‹ç»å¦‚ä½•ä½¿ç”¨å»¶æ—¶æ¶ˆæ¯.

```csharp
[Exchange(EModel.Delayed, "xdl.hello", queue: "xdl.hello.world", isDlx: true), QueueArg("x-message-ttl", 5000)]
public class DelayedEvent : IEvent
{
    /// <summary>
    /// æ‘˜è¦
    /// </summary>
    public string Summary { get; set; } = "delayed_msg";

    /// <summary>
    /// æ¶ˆæ¯ID
    /// </summary>
    public string EventId => SnowId.GenerateNewId().ToString();
}
```

- ä»ä¸Šé¢çš„ä»£ç ä¸­éœ€è¦æ¶ˆæ¯å®ä½“ç»§æ‰¿ IEvent æ¥å£,å…¶ä¸­æ¶ˆæ¯ ID å¯ä»¥è‡ªåŠ¨ç”Ÿæˆ,è‹¥æ˜¯ä¸å¸Œæœ›ä½¿ç”¨é»˜è®¤çš„æ ¼å¼,å¯ä»¥è‡ªå·±æ›¿æ¢æˆå…¶ä»–ç”Ÿæˆæ–¹å¼.
- ç„¶åæ·»åŠ ä¸Šäº¤æ¢æœºä¿¡æ¯çš„ç‰¹æ€§å³å¯.
- æ¶ˆæ¯å®ä½“å®Œæˆå,æ¥ç€å» Consumer é¡¹ç›®æ·»åŠ æ¶ˆè´¹è€…çš„å‡½æ•°.

```csharp
public class DelayedEventHandler : IEventHandler<DelayedEvent>
{
    /// <inheritdoc />
    public Task HandleAsync(DelayedEvent @event)
    {
        Console.WriteLine($"[æ¶ˆæ¯å¤„ç†è‡ª:{nameof(DelayedEventHandler)}]-{JsonSerializer.Serialize(@event)}");
        return Task.CompletedTask;
    }
}
```

- åŒæ ·æˆ‘ä»¬çš„æ¶ˆè´¹è€…ä»…éœ€ç»§æ‰¿ IEventHandler<>æ¥å£å³å¯.
- ç„¶ååœ¨ HandleAsync å‡½æ•°ä¸­å®ç°è‡ªå·±çš„ä¸šåŠ¡é€»è¾‘å³å¯.
- æœ€åæˆ‘ä»¬å»ç”Ÿäº§è€…é¡¹ç›®ä¸­å†™ä¸€ä¸ªæ¶ˆæ¯å‘é€çš„æ¥å£,å¹¶é€šè¿‡ Swagger è°ƒç”¨.ç­‰å¾… 3 ç§’åå³å¯åœ¨æ¶ˆè´¹è€…çª—å£çœ‹åˆ°æ¶ˆæ¯è¾“å‡º.

```csharp
/// <summary>
/// å‘é€å»¶æ—¶æ¶ˆæ¯,ä½¿ç”¨å»¶æ—¶æ’ä»¶
/// </summary>
[HttpPost]
public async Task Delayed()
{
    var rand = new Random();
    await ibus.Publish(new DelayedEvent(), priority: (byte)rand.Next(0, 9), ttl: 3000).ConfigureAwait(false);
}
```

- æ¶ˆè´¹è€…è¾“å‡ºç»“æœ

```text
[æ¶ˆæ¯å¤„ç†è‡ª:DelayedEventHandler]-{"Summary":"delayed_msg","EventId":"65f42a8ff73e109da5ec0d19"}
```

- è‡ªæ­¤æˆ‘ä»¬çš„æ¶ˆæ¯å‘é€,å¤„ç†å°±å®Œæˆäº†.è¯¥åº“å‘é€æ¶ˆæ¯ä»…ä¸€ä¸ªæ¥å£,ä¸¤ä¸ªé‡è½½.
- å¤„ç†æ¶ˆæ¯ä¹Ÿä»…æœ‰ä¸€ä¸ªå‡½æ•°.å¯è°“æ˜¯æç®€ ğŸ˜.
- æ›´è¯¦ç»†çš„ä½¿ç”¨å¯ä»¥å‚è€ƒæœ¬æ–‡ä¾‹å­æºç .å½“ç„¶å¯ä»¥å» EasilyNET ç»„ç»‡æä¾› PR æˆ–è€…æå‡ºé—®é¢˜è”ç³»æˆ‘.
- æœ¬æ–‡ä»…ä¸ºä¸€ä¸ªç®€å•çš„ä¾‹å­,è¿˜æœ‰ä¸€äº›ç»†èŠ‚å°šæœªè¯¦ç»†çš„å†™å‡ºæ¥,ä¸€è¾¹åˆ›å»ºé¡¹ç›®ä¸€è¾¹å†™æ–‡æ¡£ç¡®å®æœ‰ç‚¹è´¹æ—¶é—´,ä¸€ä¸¤ä¸ªå°æ—¶å°±åšäº†è¿™ä¸€ä»¶äº‹æƒ…

æœ¬æ–‡ä¾‹å­ GitHub ä»“åº“åœ°å€: https://github.com/joesdu/easilynet.sample.rabbit
